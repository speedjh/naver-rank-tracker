{% extends "base.html" %}
{% block title %}{{ client.name }} - ë„¤ì´ë²„ ìˆœìœ„ íŠ¸ë˜ì»¤{% endblock %}
{% block extra_style %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€ ëª¨ë‹¬ â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px;}
.modal-box{background:#0f172a;border:1px solid #334155;border-radius:14px;width:100%;max-width:720px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;}
.modal-head{padding:18px 20px 12px;border-bottom:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-body{flex:1;overflow-y:auto;padding:16px 20px;}
.modal-footer{padding:12px 20px;border-top:1px solid #1e293b;flex-shrink:0;}
.search-result-item{display:flex;gap:12px;padding:10px 12px;border:1px solid #1e293b;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:border-color .15s;}
.search-result-item:hover{border-color:#03c75a;}
.search-result-item img{width:56px;height:56px;object-fit:cover;border-radius:6px;flex-shrink:0;}
.search-result-info{flex:1;min-width:0;}
.result-title{font-size:.83rem;font-weight:600;color:#e2e8f0;line-height:1.4;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.result-meta{font-size:.73rem;color:#64748b;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.badge-catalog{background:#f59e0b22;color:#f59e0b;border:1px solid #f59e0b55;padding:1px 7px;border-radius:10px;font-size:.7rem;font-weight:700;}
.badge-normal{background:#3b82f622;color:#3b82f6;border:1px solid #3b82f655;padding:1px 7px;border-radius:10px;font-size:.7rem;}
.btn-select{margin-left:auto;flex-shrink:0;background:#03c75a;color:#000;border:none;border-radius:6px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;white-space:nowrap;}
.btn-select:hover{background:#00e065;}
</style>
{% endblock %}
{% block content %}

<!-- â”€â”€â”€ í˜ì´ì§€ í—¤ë” â”€â”€â”€ -->
<div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
  <div>
    <div style="font-size:.82rem;color:#64748b;margin-bottom:4px;">
      <a href="/">ëŒ€ì‹œë³´ë“œ</a> &rsaquo; {{ client.name }}
    </div>
    <div class="page-title">ğŸª {{ client.name }}</div>
    {% if client.memo %}<div class="page-sub">{{ client.memo }}</div>{% endif %}
  </div>
  <form action="/clients/{{ client.id }}/track" method="post" id="trackForm">
    <button type="submit" class="btn btn-track" id="trackBtn"
      onclick="return confirm('{{ products|length }}ê°œ ìƒí’ˆ Ã— {{ keywords|length }}ê°œ í‚¤ì›Œë“œ ìˆœìœ„ë¥¼ ì¶”ì í• ê¹Œìš”?\nì´ {{ products|length * keywords|length }}ë²ˆ ê²€ìƒ‰í•©ë‹ˆë‹¤.')">
      â–¶ ì§€ê¸ˆ ìˆœìœ„ ì¶”ì 
    </button>
  </form>
</div>

<!-- ì¶”ì  ì¤‘ ë°°ë„ˆ -->
{% if tracking == 'running' %}
<div class="tracking-banner" id="trackingBanner">
  <div class="spinner"></div>
  <span>ìˆœìœ„ ì¶”ì  ì¤‘... ì ì‹œ í›„ í˜ì´ì§€ê°€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</span>
</div>
{% endif %}

<!-- í†µê³„ ì¹´ë“œ -->
{% set ranked = latest_ranks | selectattr('rank') | list %}
{% set best = ranked | map(attribute='rank') | min if ranked else None %}
<div class="grid3" style="margin-bottom:20px;">
  <div class="stat-card green">
    <div class="stat-lbl">ë“±ë¡ ìƒí’ˆ ìˆ˜</div>
    <div class="stat-val">{{ products|length }}</div>
  </div>
  <div class="stat-card blue">
    <div class="stat-lbl">ì¶”ì  í‚¤ì›Œë“œ</div>
    <div class="stat-val">{{ keywords|length }}</div>
  </div>
  <div class="stat-card yellow">
    <div class="stat-lbl">ìµœê³  ìˆœìœ„</div>
    <div class="stat-val">{{ best ~ 'ìœ„' if best else '-' }}</div>
  </div>
</div>

<div class="grid2">
<!-- â”€â”€â”€ ì™¼ìª½: ìƒí’ˆ + í‚¤ì›Œë“œ ê´€ë¦¬ â”€â”€â”€ -->
<div>
  <!-- ìƒí’ˆ ê´€ë¦¬ -->
  <div class="card">
    <div class="card-title">ğŸ›ï¸ ìƒí’ˆ ê´€ë¦¬</div>

    <!-- âš ï¸ ê°€ê²©ë¹„êµ ì•ˆë‚´ + ê²€ìƒ‰ ë²„íŠ¼ -->
    <div style="background:#1a2535;border:1px solid #f59e0b55;border-radius:8px;padding:14px 16px;margin-bottom:14px;">
      <div style="font-size:.82rem;color:#f59e0b;font-weight:700;margin-bottom:6px;">âš ï¸ "1000ìœ„ ë°–" ë¬¸ì œê°€ ìƒê¸´ë‹¤ë©´?</div>
      <div style="font-size:.78rem;color:#94a3b8;line-height:1.8;">
        ìƒìœ„ 10ìœ„ê¶Œ ìƒí’ˆ ëŒ€ë¶€ë¶„ì€ <strong style="color:#e2e8f0;">ë„¤ì´ë²„ ê°€ê²©ë¹„êµ(ì¹´íƒˆë¡œê·¸)</strong>ë¡œ ë¬¶ì—¬ ìˆì–´,<br>
        ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ URLë¡œ ë“±ë¡í•˜ë©´ ë‹¤ë¥¸ IDë¡œ ì¸ì‹ë¼ ìˆœìœ„ë¥¼ ëª» ì°¾ì•„ìš”.<br><br>
        <strong style="color:#03c75a;">âœ… í•´ê²°ë²•:</strong> ì•„ë˜ <strong>"í‚¤ì›Œë“œë¡œ ë‚´ ìƒí’ˆ ì°¾ê¸°"</strong> ë²„íŠ¼ìœ¼ë¡œ ê²€ìƒ‰ í›„,
        ê²°ê³¼ì—ì„œ ë‚´ ìƒí’ˆì„ ì§ì ‘ ì„ íƒí•˜ë©´ ì •í™•í•œ ì¹´íƒˆë¡œê·¸ IDê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.
      </div>
      <button type="button" class="btn btn-primary btn-sm" style="margin-top:10px;background:#f59e0b;color:#000;font-weight:700;"
        onclick="openSearchModal()">ğŸ” í‚¤ì›Œë“œë¡œ ë‚´ ìƒí’ˆ ì°¾ê¸°</button>
    </div>

    <!-- ì§ì ‘ URL ì…ë ¥ í¼ -->
    <details style="margin-bottom:14px;">
      <summary style="cursor:pointer;font-size:.82rem;color:#64748b;padding:6px 0;user-select:none;">
        â–¶ ë˜ëŠ” URL/ID ì§ì ‘ ì…ë ¥
      </summary>
      <form action="/clients/{{ client.id }}/products/add" method="post" style="margin-top:10px;">
        <div style="margin-bottom:10px;">
          <label>ìƒí’ˆ URL ë˜ëŠ” ìƒí’ˆ ID <span style="color:#ef4444;">*</span></label>
          <input type="text" name="product_url" id="directUrlInput"
            placeholder="https://search.shopping.naver.com/catalog/ìˆ«ì  ë˜ëŠ”  ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ URL" required>
          <div style="font-size:.72rem;color:#475569;margin-top:3px;">
            ê°€ê²©ë¹„êµ: search.shopping.naver.com/catalog/{ID} ê¶Œì¥ | ì¼ë°˜: smartstore URL
          </div>
        </div>
        <div class="form-row" style="margin-bottom:10px;">
          <div class="form-group">
            <label>ìŠ¤í† ì–´ëª… (fallback, ì„ íƒ)</label>
            <input type="text" name="mall_name" id="directMallInput" placeholder="ë„¤ì´ë²„ ì‡¼í•‘ì— í‘œì‹œë˜ëŠ” ìŠ¤í† ì–´ëª…">
          </div>
          <div class="form-group">
            <label>ìƒí’ˆ ë³„ì¹­ (ì„ íƒ)</label>
            <input type="text" name="product_name" id="directAliasInput" placeholder="ì˜ˆ: ê°¤ëŸ­ì‹œë²„ì¦ˆ3">
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
      </form>
    </details>

    {% if products %}
    <table>
      <thead>
        <tr><th>ë³„ì¹­</th><th>ìƒí’ˆ ID</th><th>ìŠ¤í† ì–´ëª…</th><th>íƒ€ì…</th><th></th></tr>
      </thead>
      <tbody>
      {% for p in products %}
      <tr>
        <td style="font-weight:600;color:#e2e8f0;">{{ p.product_name or p.product_id }}</td>
        <td>
          <code style="font-size:.76rem;color:#03c75a;background:#03c75a11;padding:2px 6px;border-radius:4px;">{{ p.product_id }}</code>
          {% if p.catalog_id and p.catalog_id != p.product_id %}
            <div style="font-size:.72rem;color:#f59e0b;margin-top:2px;">ì¹´íƒˆë¡œê·¸: {{ p.catalog_id }}</div>
          {% endif %}
        </td>
        <td style="font-size:.8rem;color:#94a3b8;">{{ p.mall_name or '-' }}</td>
        <td>
          {% if p.catalog_id or 'catalog' in (p.product_url or '') %}
            <span class="badge-catalog">ê°€ê²©ë¹„êµ</span>
          {% elif 'smartstore' in (p.product_url or '') %}
            <span class="badge-normal">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</span>
          {% else %}
            <span style="color:#475569;font-size:.75rem;">ì§ì ‘ì…ë ¥</span>
          {% endif %}
        </td>
        <td>
          <form action="/clients/{{ client.id }}/products/{{ p.id }}/delete" method="post">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ì‚­ì œí• ê¹Œìš”?')">Ã—</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:20px;color:#475569;font-size:.875rem;">
      ìœ„ <strong style="color:#f59e0b;">ğŸ” í‚¤ì›Œë“œë¡œ ë‚´ ìƒí’ˆ ì°¾ê¸°</strong>ë¡œ ìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
    </div>
    {% endif %}
  </div>

  <!-- í‚¤ì›Œë“œ ê´€ë¦¬ -->
  <div class="card">
    <div class="card-title">ğŸ” í‚¤ì›Œë“œ ê´€ë¦¬</div>
    <form action="/clients/{{ client.id }}/keywords/add" method="post" style="margin-bottom:16px;">
      <label>í‚¤ì›Œë“œ ì…ë ¥ (ì—¬ëŸ¬ ê°œëŠ” ì‰¼í‘œ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
      <textarea name="keyword" rows="3" placeholder="ë¬´ì„ ì´ì–´í°&#10;ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°&#10;ë…¸ì´ì¦ˆìº”ìŠ¬ë§" style="margin-bottom:8px;resize:vertical;"></textarea>
      <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
    </form>

    {% if keywords %}
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      {% for kw in keywords %}
      <div style="display:flex;align-items:center;background:#1a2535;border:1px solid #334155;border-radius:20px;padding:4px 12px;gap:8px;">
        <span style="font-size:.85rem;">{{ kw.keyword }}</span>
        <form action="/clients/{{ client.id }}/keywords/{{ kw.id }}/delete" method="post" style="display:inline;">
          <button type="submit" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:.8rem;padding:0;">Ã—</button>
        </form>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align:center;padding:20px;color:#475569;font-size:.875rem;">í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
    {% endif %}
  </div>
</div>

<!-- â”€â”€â”€ ì˜¤ë¥¸ìª½: ìˆœìœ„ í˜„í™© â”€â”€â”€ -->
<div>
  <div class="card">
    <div class="card-title">ğŸ“ˆ ìµœì‹  ìˆœìœ„ í˜„í™©</div>
    {% if latest_ranks %}
    <table>
      <thead>
        <tr><th>í‚¤ì›Œë“œ</th><th>ìƒí’ˆëª…</th><th>ìˆœìœ„</th><th>íƒ€ì…</th><th>ê°€ê²©</th><th>í™•ì¸ì¼ì‹œ</th></tr>
      </thead>
      <tbody>
      {% for r in latest_ranks %}
      <tr>
        <td style="font-weight:600;color:#e2e8f0;">{{ r.keyword }}</td>
        <td>
          <div style="font-size:.78rem;color:#03c75a;">{{ r.product_id }}</div>
          <div style="font-size:.75rem;color:#64748b;">{{ r.product_name or '' }}</div>
        </td>
        <td>
          {% if r.rank %}
            <span class="rank-{% if r.rank <= 10 %}top{% elif r.rank <= 30 %}good{% elif r.rank <= 100 %}mid{% else %}low{% endif %}">
              {{ r.rank }}ìœ„
              {% if r.rank <= 10 %}ğŸ”¥{% elif r.rank <= 30 %}âœ…{% endif %}
            </span>
          {% else %}
            <span class="rank-none">1000ìœ„â†“</span>
          {% endif %}
        </td>
        <td>
          {% if r.product_type == 1 %}
            <span class="badge-catalog">ê°€ê²©ë¹„êµ</span>
          {% elif r.product_type in [2,3] %}
            <span class="badge-normal">ì¼ë°˜</span>
          {% else %}
            <span style="color:#475569;font-size:.75rem;">-</span>
          {% endif %}
        </td>
        <td style="font-size:.82rem;color:#94a3b8;">
          {{ '{:,}'.format(r.lprice) ~ 'ì›' if r.lprice else '-' }}
        </td>
        <td style="font-size:.78rem;color:#475569;">{{ r.checked_at[:16] if r.checked_at else '-' }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:32px;color:#475569;">
      <div style="font-size:2rem;margin-bottom:8px;">ğŸ“­</div>
      <div>ìˆœìœ„ ì¶”ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div style="font-size:.82rem;margin-top:4px;">ìƒí’ˆê³¼ í‚¤ì›Œë“œë¥¼ ë“±ë¡ í›„ "ì§€ê¸ˆ ìˆœìœ„ ì¶”ì " ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>
    {% endif %}
  </div>
</div>
</div>

<!-- ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ -->
{% if latest_ranks %}
<div class="card">
  <div class="card-title">ğŸ“‰ ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ (ìµœê·¼ 14ì¼, ë‚®ì„ìˆ˜ë¡ ìƒìœ„)</div>
  <div style="position:relative;height:300px;">
    <canvas id="rankChart"></canvas>
  </div>
  <div style="font-size:.75rem;color:#475569;margin-top:8px;">* Yì¶• ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ë„¤ì´ë²„ ì‡¼í•‘ ìƒìœ„ ë…¸ì¶œ</div>
</div>
{% endif %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ” ë‚´ ìƒí’ˆ ì°¾ê¸° ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="searchModal" class="modal-overlay" style="display:none;" onclick="closeModalOnBg(event)">
  <div class="modal-box">
    <div class="modal-head">
      <div>
        <div style="font-weight:700;font-size:1rem;color:#e2e8f0;">ğŸ” í‚¤ì›Œë“œë¡œ ë‚´ ìƒí’ˆ ì°¾ê¸°</div>
        <div style="font-size:.75rem;color:#64748b;margin-top:2px;">í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ì„œ ë‚´ ìƒí’ˆì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</div>
      </div>
      <button onclick="closeSearchModal()" style="background:none;border:none;color:#64748b;font-size:1.2rem;cursor:pointer;padding:4px;">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- ê²€ìƒ‰ì°½ -->
      <div style="display:flex;gap:8px;margin-bottom:16px;">
        <input type="text" id="modalSearchInput" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: ë¬´ì„ ì´ì–´í°, ê°¤ëŸ­ì‹œë²„ì¦ˆ)"
          style="flex:1;" onkeydown="if(event.key==='Enter')doModalSearch(1)">
        <button class="btn btn-primary btn-sm" onclick="doModalSearch(1)" style="white-space:nowrap;">ê²€ìƒ‰</button>
      </div>

      <!-- ì„ íƒëœ ìƒí’ˆ ë¯¸ë¦¬ë³´ê¸° -->
      <div id="selectedPreview" style="display:none;background:#0c1a2e;border:2px solid #03c75a;border-radius:8px;padding:12px 14px;margin-bottom:14px;">
        <div style="font-size:.75rem;color:#03c75a;font-weight:700;margin-bottom:6px;">âœ… ì„ íƒëœ ìƒí’ˆ</div>
        <div id="selectedTitle" style="font-size:.85rem;color:#e2e8f0;margin-bottom:6px;"></div>
        <div id="selectedMeta" style="font-size:.75rem;color:#64748b;margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <div>
            <label style="font-size:.73rem;color:#64748b;">ìƒí’ˆ ë³„ì¹­ (ì„ íƒ)</label>
            <input type="text" id="selectedAlias" placeholder="ì˜ˆ: ê°¤ëŸ­ì‹œë²„ì¦ˆ3 FE" style="margin-top:3px;width:200px;">
          </div>
          <button class="btn btn-track btn-sm" onclick="submitSelected()" style="margin-top:18px;">ì´ ìƒí’ˆìœ¼ë¡œ ë“±ë¡</button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div id="searchLoading" style="display:none;text-align:center;padding:24px;color:#64748b;">
        <div class="spinner" style="margin:0 auto 8px;"></div>ê²€ìƒ‰ ì¤‘...
      </div>
      <div id="searchResults"></div>

      <!-- í˜ì´ì§• -->
      <div id="searchPaging" style="display:none;display:flex;gap:8px;justify-content:center;margin-top:12px;"></div>
    </div>
    <div class="modal-footer" style="font-size:.73rem;color:#475569;">
      ğŸ’¡ <strong style="color:#f59e0b;">ğŸ· ê°€ê²©ë¹„êµ</strong> ë°°ì§€ = ë„¤ì´ë²„ ì¹´íƒˆë¡œê·¸ ìƒí’ˆ (ìƒìœ„ê¶Œ ëŒ€ë¶€ë¶„ í•´ë‹¹) |
      <strong style="color:#3b82f6;">ğŸ“¦ ì¼ë°˜</strong> = ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë‹¨ë… ìƒí’ˆ
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
const CLIENT_ID_INT = {{ client.id }};
let currentModalPage = 1;
let currentModalKeyword = '';
let selectedProduct = null;

// â”€â”€â”€ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° â”€â”€â”€
function openSearchModal(){
  document.getElementById('searchModal').style.display='flex';
  setTimeout(()=>document.getElementById('modalSearchInput').focus(), 100);
}
function closeSearchModal(){
  document.getElementById('searchModal').style.display='none';
}
function closeModalOnBg(e){
  if(e.target.id==='searchModal') closeSearchModal();
}

// â”€â”€â”€ ëª¨ë‹¬ ê²€ìƒ‰ ì‹¤í–‰ â”€â”€â”€
async function doModalSearch(page){
  const kw = document.getElementById('modalSearchInput').value.trim();
  if(!kw){ alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  currentModalKeyword = kw;
  currentModalPage = page;

  document.getElementById('searchLoading').style.display='block';
  document.getElementById('searchResults').innerHTML='';
  document.getElementById('searchPaging').style.display='none';

  try {
    const res = await fetch(`/api/search-products?q=${encodeURIComponent(kw)}&page=${page}`);
    const data = await res.json();
    document.getElementById('searchLoading').style.display='none';

    if(data.error){ document.getElementById('searchResults').innerHTML=`<div style="color:#ef4444;padding:16px;">${data.error}</div>`; return; }

    renderSearchResults(data.items);
    renderPaging(data.total, page);
  } catch(e) {
    document.getElementById('searchLoading').style.display='none';
    document.getElementById('searchResults').innerHTML='<div style="color:#ef4444;padding:16px;">ê²€ìƒ‰ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
  }
}

// â”€â”€â”€ ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§ â”€â”€â”€
function renderSearchResults(items){
  if(!items.length){
    document.getElementById('searchResults').innerHTML='<div style="text-align:center;padding:24px;color:#64748b;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const html = items.map(item => {
    const badge = item.isCatalog
      ? `<span class="badge-catalog">ğŸ· ê°€ê²©ë¹„êµ</span>`
      : `<span class="badge-normal">ğŸ“¦ ì¼ë°˜</span>`;
    const price = item.lprice ? `${item.lprice.toLocaleString()}ì›~` : '';
    const imgTag = item.image ? `<img src="${item.image}" alt="" onerror="this.style.display='none'">` : `<div style="width:56px;height:56px;background:#1e293b;border-radius:6px;flex-shrink:0;"></div>`;
    return `
    <div class="search-result-item" onclick="selectProduct(${JSON.stringify(item).replace(/"/g,'&quot;')})">
      ${imgTag}
      <div class="search-result-info">
        <div class="result-title">[${item.rank}ìœ„] ${item.title}</div>
        <div class="result-meta">
          ${badge}
          <span>${item.mallName || ''}</span>
          ${price ? `<span style="color:#03c75a;font-weight:600;">${price}</span>` : ''}
          <span style="color:#475569;">ID: ${item.productId}</span>
        </div>
      </div>
      <button class="btn-select">ì„ íƒ</button>
    </div>`;
  }).join('');
  document.getElementById('searchResults').innerHTML = html;
}

// â”€â”€â”€ ìƒí’ˆ ì„ íƒ â”€â”€â”€
function selectProduct(item){
  selectedProduct = item;
  document.getElementById('selectedPreview').style.display='block';
  document.getElementById('selectedTitle').textContent = `[${item.rank}ìœ„] ${item.title}`;
  const typeLabel = item.isCatalog ? 'ğŸ· ê°€ê²©ë¹„êµ(ì¹´íƒˆë¡œê·¸)' : 'ğŸ“¦ ì¼ë°˜ ìƒí’ˆ';
  document.getElementById('selectedMeta').textContent =
    `${typeLabel}  |  ID: ${item.productId}  |  ${item.mallName}  |  ${item.lprice ? item.lprice.toLocaleString()+'ì›~' : ''}`;
  document.getElementById('selectedAlias').value = item.title.replace(/<[^>]+>/g,'').substring(0,30);
  document.getElementById('selectedPreview').scrollIntoView({behavior:'smooth',block:'nearest'});
}

// â”€â”€â”€ ì„ íƒ ìƒí’ˆ ë“±ë¡ â”€â”€â”€
async function submitSelected(){
  if(!selectedProduct){ alert('ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const alias = document.getElementById('selectedAlias').value.trim() || selectedProduct.title;
  const formData = new FormData();
  formData.append('product_url', selectedProduct.addUrl || selectedProduct.link);
  formData.append('product_name', alias);
  formData.append('mall_name', selectedProduct.mallName || '');

  try {
    const res = await fetch(`/clients/${CLIENT_ID_INT}/products/add`, {method:'POST', body: formData});
    // ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µì´ë©´ ì„±ê³µ
    if(res.ok || res.redirected){
      closeSearchModal();
      location.reload();
    } else {
      alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch(e){
    location.reload(); // í¼ ì „ì†¡ ë°©ì‹ìœ¼ë¡œ fallback
  }
}

// â”€â”€â”€ í˜ì´ì§• â”€â”€â”€
function renderPaging(total, current){
  const maxPage = Math.min(Math.ceil(total / 20), 10);
  if(maxPage <= 1){ document.getElementById('searchPaging').style.display='none'; return; }
  let html = '';
  for(let p=1;p<=maxPage;p++){
    html += `<button onclick="doModalSearch(${p})" style="background:${p===current?'#03c75a':'#1e293b'};color:${p===current?'#000':'#94a3b8'};border:1px solid #334155;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8rem;">${p}</button>`;
  }
  const paging = document.getElementById('searchPaging');
  paging.innerHTML = html;
  paging.style.display = 'flex';
}

// â”€â”€â”€ ì¶”ì  ìƒíƒœ í´ë§ â”€â”€â”€
{% if tracking == 'running' %}
const pollStatus = setInterval(async () => {
  const res = await fetch('/clients/{{ client.id }}/track/status');
  const data = await res.json();
  if (data.status !== 'running') {
    await fetch('/clients/{{ client.id }}/track/reset', {method:'POST'});
    clearInterval(pollStatus);
    location.reload();
  }
}, 3000);
{% endif %}

// â”€â”€â”€ ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ â”€â”€â”€
{% if latest_ranks %}
const rawData = {{ chart_data | safe }};
const COLORS = ['#03c75a','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16'];

const datasets = Object.entries(rawData).map(([label, d], i) => ({
  label,
  data: d.dates.map((x, i) => ({ x, y: d.ranks[i] })),
  borderColor: COLORS[i % COLORS.length],
  backgroundColor: COLORS[i % COLORS.length] + '22',
  tension: 0.3,
  fill: false,
  pointRadius: 5,
  spanGaps: true,
}));

const ctx = document.getElementById('rankChart');
if (ctx && datasets.length) {
  new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { type: 'category', ticks: { color: '#64748b', maxTicksLimit: 10 }, grid: { color: '#1e293b' } },
        y: {
          reverse: true,
          ticks: { color: '#64748b', callback: v => v + 'ìœ„' },
          grid: { color: '#1e293b' },
          title: { display: true, text: 'ìˆœìœ„', color: '#64748b' }
        }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', font: { size: 11 }, padding: 12 } },
        tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${c.parsed.y != null ? c.parsed.y + 'ìœ„' : 'ë¯¸ë°œê²¬'}` } }
      }
    }
  });
}
{% endif %}
</script>
{% endblock %}
