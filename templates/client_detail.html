{% extends "base.html" %}
{% block title %}{{ client.name }} - ë„¤ì´ë²„ ìˆœìœ„ íŠ¸ë˜ì»¤{% endblock %}
{% block extra_style %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}
{% block content %}

<!-- í˜ì´ì§€ í—¤ë” -->
<div class="page-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
  <div>
    <div style="font-size:.82rem;color:#64748b;margin-bottom:4px;">
      <a href="/">ëŒ€ì‹œë³´ë“œ</a> &rsaquo; {{ client.name }}
    </div>
    <div class="page-title">ğŸª {{ client.name }}</div>
    {% if client.memo %}<div class="page-sub">{{ client.memo }}</div>{% endif %}
  </div>
  <form action="/clients/{{ client.id }}/track" method="post" id="trackForm">
    <button type="submit" class="btn btn-track" id="trackBtn"
      onclick="return confirm('{{ products|length }}ê°œ ìƒí’ˆ Ã— {{ keywords|length }}ê°œ í‚¤ì›Œë“œ ìˆœìœ„ë¥¼ ì¶”ì í• ê¹Œìš”?\nì´ {{ products|length * keywords|length }}ë²ˆ ê²€ìƒ‰í•©ë‹ˆë‹¤.')">
      â–¶ ì§€ê¸ˆ ìˆœìœ„ ì¶”ì 
    </button>
  </form>
</div>

<!-- ì¶”ì  ì¤‘ ë°°ë„ˆ -->
{% if tracking == 'running' %}
<div class="tracking-banner" id="trackingBanner">
  <div class="spinner"></div>
  <span>ìˆœìœ„ ì¶”ì  ì¤‘... ì ì‹œ í›„ í˜ì´ì§€ê°€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</span>
</div>
{% endif %}

<!-- í†µê³„ ì¹´ë“œ -->
{% set ranked = latest_ranks | selectattr('rank') | list %}
{% set best = ranked | map(attribute='rank') | min if ranked else None %}
<div class="grid3" style="margin-bottom:20px;">
  <div class="stat-card green">
    <div class="stat-lbl">ë“±ë¡ ìƒí’ˆ ìˆ˜</div>
    <div class="stat-val">{{ products|length }}</div>
  </div>
  <div class="stat-card blue">
    <div class="stat-lbl">ì¶”ì  í‚¤ì›Œë“œ</div>
    <div class="stat-val">{{ keywords|length }}</div>
  </div>
  <div class="stat-card yellow">
    <div class="stat-lbl">ìµœê³  ìˆœìœ„</div>
    <div class="stat-val">{{ best ~ 'ìœ„' if best else '-' }}</div>
  </div>
</div>

<div class="grid2">
<!-- ì™¼ìª½: ìƒí’ˆ + í‚¤ì›Œë“œ ê´€ë¦¬ -->
<div>
  <!-- ìƒí’ˆ ê´€ë¦¬ -->
  <div class="card">
    <div class="card-title">ğŸ›ï¸ ìƒí’ˆ ê´€ë¦¬</div>
    <form action="/clients/{{ client.id }}/products/add" method="post" style="margin-bottom:16px;">
      <div style="margin-bottom:8px;">
        <label>ìƒí’ˆ URL ë˜ëŠ” ìƒí’ˆ ID *</label>
        <input type="text" name="product_url" placeholder="https://smartstore.naver.com/store/products/12345678 ë˜ëŠ” ìˆ«ì ID" required>
        <div style="font-size:.75rem;color:#475569;margin-top:4px;">
          ì§€ì›: smartstore URL / search.shopping.naver.com/catalog/{id} / ìˆ«ì ID ì§ì ‘ ì…ë ¥
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ìƒí’ˆ ë³„ì¹­ (ì„ íƒ)</label>
          <input type="text" name="product_name" placeholder="ì˜ˆ: ë¬´ì„ ì´ì–´í° Aëª¨ë¸">
        </div>
        <div style="align-self:flex-end;">
          <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
        </div>
      </div>
    </form>

    {% if products %}
    <table>
      <thead>
        <tr><th>ë³„ì¹­</th><th>ìƒí’ˆ ID</th><th>ì›ë³¸ URL</th><th></th></tr>
      </thead>
      <tbody>
      {% for p in products %}
      <tr>
        <td style="font-weight:600;color:#e2e8f0;">{{ p.product_name or p.product_id }}</td>
        <td><code style="font-size:.78rem;color:#03c75a;background:#03c75a11;padding:2px 6px;border-radius:4px;">{{ p.product_id }}</code></td>
        <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
          <a href="{{ p.product_url }}" target="_blank" style="color:#3b82f6;font-size:.78rem;">{{ p.product_url }}</a>
        </td>
        <td>
          <form action="/clients/{{ client.id }}/products/{{ p.id }}/delete" method="post">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ì‚­ì œí• ê¹Œìš”?')">Ã—</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:20px;color:#475569;font-size:.875rem;">ìƒí’ˆì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
    {% endif %}
  </div>

  <!-- í‚¤ì›Œë“œ ê´€ë¦¬ -->
  <div class="card">
    <div class="card-title">ğŸ” í‚¤ì›Œë“œ ê´€ë¦¬</div>
    <form action="/clients/{{ client.id }}/keywords/add" method="post" style="margin-bottom:16px;">
      <label>í‚¤ì›Œë“œ ì…ë ¥ (ì—¬ëŸ¬ ê°œëŠ” ì‰¼í‘œ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)</label>
      <textarea name="keyword" rows="3" placeholder="ë¬´ì„ ì´ì–´í°&#10;ë¸”ë£¨íˆ¬ìŠ¤ ì´ì–´í°&#10;ë…¸ì´ì¦ˆìº”ìŠ¬ë§" style="margin-bottom:8px;resize:vertical;"></textarea>
      <button type="submit" class="btn btn-primary btn-sm">ì¶”ê°€</button>
    </form>

    {% if keywords %}
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      {% for kw in keywords %}
      <div style="display:flex;align-items:center;background:#1a2535;border:1px solid #334155;border-radius:20px;padding:4px 12px;gap:8px;">
        <span style="font-size:.85rem;">{{ kw.keyword }}</span>
        <form action="/clients/{{ client.id }}/keywords/{{ kw.id }}/delete" method="post" style="display:inline;">
          <button type="submit" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:.8rem;padding:0;">Ã—</button>
        </form>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align:center;padding:20px;color:#475569;font-size:.875rem;">í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
    {% endif %}
  </div>
</div>

<!-- ì˜¤ë¥¸ìª½: ìˆœìœ„ í˜„í™© -->
<div>
  <div class="card">
    <div class="card-title">ğŸ“ˆ ìµœì‹  ìˆœìœ„ í˜„í™©</div>
    {% if latest_ranks %}
    <table>
      <thead>
        <tr><th>í‚¤ì›Œë“œ</th><th>ìƒí’ˆ ID</th><th>ìˆœìœ„</th><th>ê°€ê²©</th><th>í™•ì¸ì¼ì‹œ</th></tr>
      </thead>
      <tbody>
      {% for r in latest_ranks %}
      <tr>
        <td style="font-weight:600;color:#e2e8f0;">{{ r.keyword }}</td>
        <td>
          <div style="font-size:.78rem;color:#03c75a;">{{ r.product_id }}</div>
          <div style="font-size:.75rem;color:#64748b;">{{ r.product_name or '' }}</div>
        </td>
        <td>
          {% if r.rank %}
            <span class="rank-{% if r.rank <= 10 %}top{% elif r.rank <= 30 %}good{% elif r.rank <= 100 %}mid{% else %}low{% endif %}">
              {{ r.rank }}ìœ„
              {% if r.rank <= 10 %}ğŸ”¥{% elif r.rank <= 30 %}âœ…{% endif %}
            </span>
          {% else %}
            <span class="rank-none">1000ìœ„â†“</span>
          {% endif %}
        </td>
        <td style="font-size:.82rem;color:#94a3b8;">
          {{ '{:,}'.format(r.lprice) ~ 'ì›' if r.lprice else '-' }}
        </td>
        <td style="font-size:.78rem;color:#475569;">{{ r.checked_at[:16] if r.checked_at else '-' }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:32px;color:#475569;">
      <div style="font-size:2rem;margin-bottom:8px;">ğŸ“­</div>
      <div>ìˆœìœ„ ì¶”ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div style="font-size:.82rem;margin-top:4px;">ìƒí’ˆê³¼ í‚¤ì›Œë“œë¥¼ ë“±ë¡ í›„ "ì§€ê¸ˆ ìˆœìœ„ ì¶”ì " ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>
    {% endif %}
  </div>
</div>
</div>

<!-- ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ -->
{% if latest_ranks %}
<div class="card">
  <div class="card-title">ğŸ“‰ ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ (ìµœê·¼ 14ì¼, ë‚®ì„ìˆ˜ë¡ ìƒìœ„)</div>
  <div style="position:relative;height:300px;">
    <canvas id="rankChart"></canvas>
  </div>
  <div style="font-size:.75rem;color:#475569;margin-top:8px;">* Yì¶• ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ë„¤ì´ë²„ ì‡¼í•‘ ìƒìœ„ ë…¸ì¶œ</div>
</div>
{% endif %}

{% endblock %}

{% block extra_script %}
<script>
// â”€â”€â”€ ì¶”ì  ìƒíƒœ í´ë§ â”€â”€â”€
{% if tracking == 'running' %}
const pollStatus = setInterval(async () => {
  const res = await fetch('/clients/{{ client.id }}/track/status');
  const data = await res.json();
  if (data.status !== 'running') {
    await fetch('/clients/{{ client.id }}/track/reset', {method:'POST'});
    clearInterval(pollStatus);
    location.reload();
  }
}, 3000);
{% endif %}

// â”€â”€â”€ ìˆœìœ„ ì¶”ì´ ì°¨íŠ¸ â”€â”€â”€
{% if latest_ranks %}
const rawData = {{ chart_data | safe }};
const COLORS = ['#03c75a','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16'];

const datasets = Object.entries(rawData).map(([label, d], i) => ({
  label,
  data: d.dates.map((x, i) => ({ x, y: d.ranks[i] })),
  borderColor: COLORS[i % COLORS.length],
  backgroundColor: COLORS[i % COLORS.length] + '22',
  tension: 0.3,
  fill: false,
  pointRadius: 5,
  spanGaps: true,
}));

const ctx = document.getElementById('rankChart');
if (ctx && datasets.length) {
  new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { type: 'category', ticks: { color: '#64748b', maxTicksLimit: 10 }, grid: { color: '#1e293b' } },
        y: {
          reverse: true,
          ticks: { color: '#64748b', callback: v => v + 'ìœ„' },
          grid: { color: '#1e293b' },
          title: { display: true, text: 'ìˆœìœ„', color: '#64748b' }
        }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', font: { size: 11 }, padding: 12 } },
        tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${c.parsed.y != null ? c.parsed.y + 'ìœ„' : 'ë¯¸ë°œê²¬'}` } }
      }
    }
  });
}
{% endif %}
</script>
{% endblock %}
