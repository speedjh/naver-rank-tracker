{% extends "base.html" %}
{% block title %}ìˆœìœ„ íŠ¸ë˜ì»¤{% endblock %}

{% block extra_style %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â•â•â•â• ë ˆì´ì•„ì›ƒ â•â•â•â• */
.page-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:18px;}
.page-header h1{font-size:1.3rem;font-weight:800;color:#e2e8f0;margin:0 0 2px;}
.page-header p{font-size:.78rem;color:#64748b;margin:0;}

/* ìŠ¤ì¼€ì¤„ ë°°ì§€ */
.sch-badge{display:flex;align-items:center;gap:10px;background:#1a2535;border:1px solid #2d3f5a;border-radius:10px;padding:8px 16px;}
.sch-dot{width:8px;height:8px;border-radius:50%;background:#03c75a;flex-shrink:0;
  box-shadow:0 0 0 3px #03c75a33;animation:pulse 1.8s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 3px #03c75a33}50%{box-shadow:0 0 0 6px #03c75a11}}
.sch-info{font-size:.78rem;color:#94a3b8;line-height:1.65;}
.sch-info strong{color:#e2e8f0;}

/* ì¶”ì  ë°°ë„ˆ */
.track-banner{background:#03c75a0e;border:1px solid #03c75a44;border-radius:8px;
  padding:9px 16px;margin-bottom:14px;display:flex;align-items:center;gap:10px;font-size:.84rem;color:#03c75a;}

/* â•â•â•â• ê´‘ê³ ì£¼ íƒ­ ë°” â•â•â•â• */
.client-tabbar{
  display:flex;align-items:flex-end;gap:4px;
  border-bottom:2px solid #1e293b;
  margin-bottom:20px;overflow-x:auto;
  padding-bottom:0;
}
.client-tabbar::-webkit-scrollbar{height:4px;}
.client-tabbar::-webkit-scrollbar-thumb{background:#334155;border-radius:2px;}

.ctab{
  display:flex;align-items:center;gap:7px;
  padding:9px 18px 10px;
  background:#1a2535;border:1px solid #1e293b;border-bottom:none;
  border-radius:8px 8px 0 0;
  font-size:.84rem;font-weight:600;color:#64748b;
  cursor:pointer;white-space:nowrap;flex-shrink:0;
  transition:color .15s,background .15s;
  position:relative;top:2px;
}
.ctab:hover{color:#94a3b8;background:#1e293b;}
.ctab.active{
  background:#161c2d;color:#e2e8f0;
  border-color:#334155;
  border-bottom:2px solid #161c2d;
  top:2px;
}
.ctab .tab-del{
  background:none;border:none;color:#334155;cursor:pointer;
  font-size:.78rem;padding:0 0 0 2px;line-height:1;
}
.ctab .tab-del:hover{color:#ef4444;}

/* + ìƒˆ ê´‘ê³ ì£¼ ë²„íŠ¼ */
.ctab-add{
  padding:8px 14px 10px;
  background:none;border:none;border-bottom:none;
  color:#334155;font-size:1.1rem;cursor:pointer;
  border-radius:8px 8px 0 0;
  transition:color .15s;
  position:relative;top:2px;
}
.ctab-add:hover{color:#03c75a;}

/* íƒ­ íŒ¨ë„ */
.client-panel{display:none;}
.client-panel.active{display:block;}

/* ë¹ˆ ìƒíƒœ */
.empty-clients{
  text-align:center;padding:72px 20px;color:#334155;
}
.empty-clients .icon{font-size:3rem;margin-bottom:12px;}
.empty-clients h3{font-size:1rem;color:#475569;margin:0 0 6px;}
.empty-clients p{font-size:.83rem;margin:0 0 20px;}

/* â•â•â•â• ì…ë ¥ íŒ¨ë„ â•â•â•â• */
.input-panel{
  background:#1e2433;border:1px solid #2a3347;
  border-radius:12px;padding:18px 20px;margin-bottom:18px;
}
.input-panel-title{font-size:.7rem;font-weight:700;color:#475569;
  text-transform:uppercase;letter-spacing:.06em;margin-bottom:14px;}
.input-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:600px){.input-grid{grid-template-columns:1fr;}}
.input-block label{display:block;font-size:.73rem;color:#64748b;margin-bottom:5px;}
.input-hint{font-size:.69rem;color:#334155;margin-top:3px;}

input[type=text],textarea{
  background:#0f1117;border:1px solid #334155;color:#e2e8f0;
  padding:8px 11px;border-radius:7px;font-size:.875rem;
  width:100%;box-sizing:border-box;transition:border-color .15s;
}
input[type=text]:focus,textarea:focus{outline:none;border-color:#03c75a;}
textarea{resize:vertical;font-family:inherit;}

/* â•â•â•â• ë²„íŠ¼ â•â•â•â• */
.btn{display:inline-flex;align-items:center;gap:5px;
  padding:8px 16px;border-radius:7px;font-size:.83rem;font-weight:600;
  border:none;cursor:pointer;transition:background .15s,opacity .15s;}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-primary{background:#03c75a;color:#000;}
.btn-primary:hover:not(:disabled){background:#00e065;}
.btn-secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.btn-secondary:hover{background:#263347;color:#e2e8f0;}
.btn-danger{background:#ef444415;color:#ef4444;border:1px solid #ef444433;}
.btn-danger:hover{background:#ef444425;}
.btn-sm{padding:5px 12px;font-size:.77rem;}
.btn-track{background:#03c75a;color:#000;padding:8px 18px;font-size:.84rem;font-weight:700;border-radius:7px;border:none;cursor:pointer;}
.btn-track:hover{background:#00e065;}
.btn-track:disabled{opacity:.5;cursor:not-allowed;}

/* â•â•â•â• í‚¤ì›Œë“œ íƒœê·¸ â•â•â•â• */
.kw-tag{
  display:inline-flex;align-items:center;gap:5px;
  background:#1a2535;border:1px solid #334155;
  border-radius:14px;padding:3px 9px;font-size:.79rem;color:#e2e8f0;
}
.kw-del{background:none;border:none;color:#475569;cursor:pointer;font-size:.73rem;padding:0;line-height:1;}
.kw-del:hover{color:#ef4444;}

/* â•â•â•â• ìˆœìœ„ í…Œì´ë¸” â•â•â•â• */
.table-card{background:#161c2d;border:1px solid #1e293b;border-radius:12px;overflow:hidden;}
.table-card-head{display:flex;align-items:center;justify-content:space-between;
  padding:13px 18px 11px;border-bottom:1px solid #1e293b;}
.table-card-head h2{font-size:.88rem;font-weight:700;color:#e2e8f0;margin:0;}
.table-wrap{overflow-x:auto;}
table.rtbl{width:100%;border-collapse:collapse;min-width:680px;}
table.rtbl thead th{
  padding:8px 13px;font-size:.69rem;color:#475569;text-align:left;
  text-transform:uppercase;letter-spacing:.04em;
  border-bottom:1px solid #1e293b;background:#1a2535;white-space:nowrap;
}
table.rtbl tbody td{
  padding:10px 13px;border-bottom:1px solid #1a2535;
  font-size:.84rem;vertical-align:middle;
}
table.rtbl tbody tr:last-child td{border-bottom:none;}
table.rtbl tbody tr:hover td{background:#1e2a3a;}

/* ìˆœìœ„ ë±ƒì§€ */
.rb{display:inline-block;padding:2px 9px;border-radius:20px;font-weight:700;font-size:.8rem;min-width:48px;text-align:center;}
.rb-top {background:#f59e0b18;color:#f59e0b;border:1px solid #f59e0b44;}
.rb-good{background:#03c75a18;color:#03c75a;border:1px solid #03c75a44;}
.rb-mid {background:#3b82f618;color:#3b82f6;border:1px solid #3b82f644;}
.rb-low {background:#94a3b818;color:#94a3b8;border:1px solid #94a3b844;}
.rb-none{background:#ef444418;color:#ef4444;border:1px solid #ef444444;}

/* ì‚­ì œ ë²„íŠ¼ ì¸ë¼ì¸ */
.del-btn{background:none;border:none;color:#334155;cursor:pointer;font-size:.84rem;padding:2px 6px;border-radius:4px;}
.del-btn:hover{color:#ef4444;background:#ef444415;}

/* ë¹ˆ í…Œì´ë¸” */
.empty-tbl{text-align:center;padding:44px 20px;color:#334155;}
.empty-tbl .icon{font-size:2.4rem;margin-bottom:8px;}

/* ë¯¸ë‹ˆ ì°¨íŠ¸ */
canvas.mini{display:block;}

/* â•â•â•â• ëª¨ë‹¬ â•â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:1000;
  display:flex;align-items:center;justify-content:center;padding:16px;}
.modal-box{background:#0f172a;border:1px solid #334155;border-radius:14px;
  width:100%;max-width:680px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;}
.modal-head{padding:15px 20px 11px;border-bottom:1px solid #1e293b;
  display:flex;align-items:center;justify-content:space-between;}
.modal-body{flex:1;overflow-y:auto;padding:16px 20px;}
.modal-footer{padding:8px 20px;border-top:1px solid #1e293b;font-size:.71rem;color:#475569;}
.modal-close{background:none;border:none;color:#64748b;font-size:1.2rem;cursor:pointer;}
.modal-close:hover{color:#e2e8f0;}

/* ê²€ìƒ‰ ì•„ì´í…œ */
.sr-item{display:flex;gap:12px;padding:10px 12px;border:1px solid #1e293b;
  border-radius:8px;margin-bottom:7px;cursor:pointer;transition:border-color .15s;}
.sr-item:hover{border-color:#03c75a;}
.sr-info{flex:1;min-width:0;}
.sr-title{font-size:.81rem;font-weight:600;color:#e2e8f0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;}
.sr-meta{font-size:.71rem;color:#64748b;display:flex;gap:7px;flex-wrap:wrap;align-items:center;}
.bc{background:#f59e0b22;color:#f59e0b;border:1px solid #f59e0b55;padding:1px 7px;border-radius:10px;font-size:.69rem;font-weight:700;}
.bn{background:#3b82f622;color:#3b82f6;border:1px solid #3b82f655;padding:1px 7px;border-radius:10px;font-size:.69rem;}
.pick-btn{margin-left:auto;flex-shrink:0;background:#03c75a;color:#000;border:none;border-radius:6px;padding:5px 11px;font-size:.74rem;font-weight:700;cursor:pointer;}
.pick-btn:hover{background:#00e065;}

/* ìŠ¤í”¼ë„ˆ */
.spinner{width:18px;height:18px;border:2px solid #334155;border-top-color:#03c75a;
  border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ìƒíƒœ ë©”ì‹œì§€ */
.status-msg{font-size:.79rem;padding:6px 0;}
</style>
{% endblock %}

{% block content %}

<!-- â”€â”€ í˜ì´ì§€ í—¤ë” â”€â”€ -->
<div class="page-header">
  <div>
    <h1>ğŸ“Š ìˆœìœ„ íŠ¸ë˜ì»¤</h1>
    <p>ë„¤ì´ë²„ ì‡¼í•‘ ìƒí’ˆ ìˆœìœ„ Â· ê´‘ê³ ì£¼ë³„ ê´€ë¦¬ Â· ë§¤ì¼ 11:00 ìë™ ì¶”ì </p>
  </div>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <div class="sch-badge">
      <div class="sch-dot"></div>
      <div class="sch-info">
        <strong>ìë™ ì¶”ì </strong> ë§¤ì¼ 11:00 KST<br>
        ë‹¤ìŒ: <strong style="color:#03c75a;">{{ next_run }}</strong>
        {% if global_tracking.last_run %} &nbsp;|&nbsp; ë§ˆì§€ë§‰: {{ global_tracking.last_run }}{% endif %}
      </div>
    </div>
    <button class="btn-track" id="btnTrackAll" onclick="trackAll()">â–¶ ì „ì²´ ì¶”ì </button>
  </div>
</div>

{% if global_tracking.running %}
<div class="track-banner" id="trackBanner">
  <div class="spinner"></div>
  <span>ìˆœìœ„ ì¶”ì  ì¤‘... ì™„ë£Œ í›„ ìë™ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.</span>
</div>
{% endif %}


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê´‘ê³ ì£¼ íƒ­ ë°”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="client-tabbar" id="clientTabbar">
  {% for cl in clients %}
  <button class="ctab {% if loop.first %}active{% endif %}"
          id="ctab_{{ cl.id }}"
          onclick="showClient({{ cl.id }})">
    ğŸª {{ cl.name }}
    <span class="tab-del" onclick="event.stopPropagation();deleteClient({{ cl.id }},'{{ cl.name }}')" title="ì‚­ì œ">âœ•</span>
  </button>
  {% endfor %}
  <button class="ctab-add" onclick="openAddClientModal()" title="ê´‘ê³ ì£¼ ì¶”ê°€">ï¼‹</button>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê´‘ê³ ì£¼ ì—†ì„ ë•Œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
{% if not clients %}
<div class="empty-clients" id="emptyState">
  <div class="icon">ğŸ¢</div>
  <h3>ë“±ë¡ëœ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
  <p>ìƒë‹¨ì˜ ï¼‹ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ê´‘ê³ ì£¼ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
  <button class="btn btn-primary" onclick="openAddClientModal()">ï¼‹ ê´‘ê³ ì£¼ ì¶”ê°€</button>
</div>
{% endif %}


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ê´‘ê³ ì£¼ íŒ¨ë„ (ì„œë²„ ë Œë”)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
{% for cl in clients %}
<div class="client-panel {% if loop.first %}active{% endif %}" id="cpanel_{{ cl.id }}">

  <!-- â”€â”€ ì…ë ¥ íŒ¨ë„ â”€â”€ -->
  <div class="input-panel">
    <div class="input-panel-title">â• {{ cl.name }} ìƒí’ˆ Â· í‚¤ì›Œë“œ ë“±ë¡</div>
    <div class="input-grid">

      <!-- ìƒí’ˆ URL -->
      <div class="input-block">
        <label>ìƒí’ˆ URL <span style="font-weight:400;color:#475569;">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë˜ëŠ” ê°€ê²©ë¹„êµ URL</span></label>
        <div style="display:flex;gap:7px;">
          <input type="text" id="url_{{ cl.id }}"
            placeholder="https://smartstore.naver.com/...">
          <button class="btn btn-secondary btn-sm" style="white-space:nowrap;"
            onclick="openSearchModal({{ cl.id }})">ğŸ”</button>
        </div>
        <input type="text" id="alias_{{ cl.id }}"
          placeholder="ìƒí’ˆ ë³„ì¹­ (ì„ íƒ)" style="margin-top:7px;">
        <div class="input-hint">ë³„ì¹­ì„ ì…ë ¥í•˜ë©´ í…Œì´ë¸”ì— ì§§ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <!-- í‚¤ì›Œë“œ -->
      <div class="input-block">
        <label>í‚¤ì›Œë“œ <span style="font-weight:400;color:#475569;">ì‰¼í‘œÂ·ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‹¤ì¤‘ ì…ë ¥</span></label>
        <textarea id="kw_{{ cl.id }}" rows="2"
          placeholder="ì¥ë‡Œì‚¼&#10;ì‚°ì–‘ì‚¼, ì‚°ì–‘ì‚°ì‚¼"></textarea>
        <div class="input-hint">ì—¬ëŸ¬ í‚¤ì›Œë“œë¥¼ í•œë²ˆì— ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      </div>

    </div>

    <!-- ë²„íŠ¼ í–‰ -->
    <div style="display:flex;gap:9px;margin-top:13px;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-primary btn-sm" onclick="submitProduct({{ cl.id }})">ğŸ“¦ ìƒí’ˆ ì¶”ê°€</button>
      <button class="btn btn-secondary btn-sm" onclick="submitKeywords({{ cl.id }})">ğŸ”‘ í‚¤ì›Œë“œ ì¶”ê°€</button>
      <span class="status-msg" id="st_{{ cl.id }}"></span>
    </div>

    <!-- ë“±ë¡ëœ í‚¤ì›Œë“œ íƒœê·¸ -->
    <div id="kwtags_{{ cl.id }}" style="margin-top:12px;{% if not client_data[cl.id].keywords %}display:none;{% endif %}">
      <div style="font-size:.69rem;color:#475569;margin-bottom:7px;text-transform:uppercase;letter-spacing:.04em;">ë“±ë¡ëœ í‚¤ì›Œë“œ</div>
      <div id="kwtaglist_{{ cl.id }}" style="display:flex;flex-wrap:wrap;gap:6px;">
        {% for kw in client_data[cl.id].keywords %}
        <span class="kw-tag" id="kwtag_{{ kw.id }}">
          {{ kw.keyword }}
          <button class="kw-del" onclick="deleteKeyword({{ cl.id }},{{ kw.id }},this)">âœ•</button>
        </span>
        {% endfor %}
      </div>
    </div>

  </div><!-- /input-panel -->


  <!-- â”€â”€ ìˆœìœ„ í…Œì´ë¸” â”€â”€ -->
  <div class="table-card">
    <div class="table-card-head">
      <h2>ğŸ“‹ ìˆœìœ„ í˜„í™© <span style="font-size:.76rem;color:#475569;font-weight:400;">â€” {{ cl.name }}</span></h2>
      <span style="font-size:.74rem;color:#475569;" id="rowcnt_{{ cl.id }}">
        {{ client_data[cl.id].rows|length }}ê°œ ì¡°í•©
      </span>
    </div>

    {% set rows = client_data[cl.id].rows %}
    {% if rows %}
    <div class="table-wrap" id="tblwrap_{{ cl.id }}">
      <table class="rtbl" id="tbl_{{ cl.id }}">
        <thead>
          <tr>
            <th style="width:190px;">ìƒí’ˆëª…</th>
            <th>í‚¤ì›Œë“œ</th>
            <th style="width:90px;text-align:center;">ìˆœìœ„</th>
            <th style="width:90px;">ê°€ê²©</th>
            <th style="width:130px;">í™•ì¸ ì‹œê°</th>
            <th style="width:110px;">ì¶”ì´</th>
            <th style="width:46px;"></th>
          </tr>
        </thead>
        <tbody id="tbody_{{ cl.id }}">
        {% set ns = namespace(prev_pid=None) %}
        {% for r in rows %}
          <tr id="tr_{{ r.pid }}_{{ r.kid }}">
            <td>
              {% if r.pid != ns.prev_pid %}
              <a href="{{ r.product_url }}" target="_blank"
                 style="color:#e2e8f0;font-weight:600;font-size:.84rem;text-decoration:none;"
                 title="{{ r.product_url }}">
                {{ r.product_name or (r.product_url[:26] ~ '...') }}
              </a>
              <div style="font-size:.7rem;color:#334155;margin-top:1px;">ID: {{ r.product_id or '-' }}</div>
              {% set ns.prev_pid = r.pid %}
              {% else %}
              <span style="color:#2d3f5a;font-size:.76rem;">â†‘ ë™ì¼ ìƒí’ˆ</span>
              {% endif %}
            </td>
            <td>
              <span class="kw-tag" style="background:transparent;border-color:#2d3f5a;">{{ r.keyword }}</span>
            </td>
            <td style="text-align:center;">
              {% if r.rank %}
                <span class="rb rb-{% if r.rank<=10 %}top{% elif r.rank<=30 %}good{% elif r.rank<=100 %}mid{% else %}low{% endif %}">
                  {{ r.rank }}ìœ„{% if r.rank<=3 %} ğŸ¥‡{% elif r.rank<=10 %} ğŸ”¥{% endif %}
                </span>
              {% elif r.checked_at %}
                <span class="rb rb-none">1000ìœ„â†“</span>
              {% else %}
                <span style="color:#334155;font-size:.77rem;">ë¯¸ì¶”ì </span>
              {% endif %}
            </td>
            <td style="color:#94a3b8;font-size:.81rem;">
              {{ '{:,}'.format(r.lprice)~'ì›' if r.lprice else '-' }}
            </td>
            <td style="color:#475569;font-size:.76rem;">
              {{ r.checked_at[:16] if r.checked_at else '-' }}
            </td>
            <td style="width:110px;">
              {% if r.product_id and r.keyword and r.keyword != 'â€”' %}
              <canvas class="mini" id="mc_{{ r.pid }}_{{ r.kid }}" width="110" height="36"
                data-pid="{{ r.product_id }}" data-kw="{{ r.keyword }}"></canvas>
              {% endif %}
            </td>
            <td style="text-align:center;">
              <button class="del-btn" title="ìƒí’ˆ ì‚­ì œ"
                onclick="deleteProduct({{ cl.id }},{{ r.pid }})">ğŸ—‘</button>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% else %}
    <div class="empty-tbl" id="emptytbl_{{ cl.id }}">
      <div class="icon">ğŸ“­</div>
      <div style="font-size:.88rem;color:#475569;margin-bottom:4px;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
      <div style="font-size:.8rem;color:#334155;">ìœ„ì—ì„œ ìƒí’ˆ URLê³¼ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>
    {% endif %}

  </div><!-- /table-card -->

</div><!-- /client-panel -->
{% endfor %}


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ëª¨ë‹¬: ê´‘ê³ ì£¼ ì¶”ê°€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="addClientModal" class="modal-overlay" style="display:none;"
  onclick="if(event.target.id==='addClientModal')closeAddClientModal()">
  <div class="modal-box" style="max-width:380px;">
    <div class="modal-head">
      <div style="font-weight:700;color:#e2e8f0;">ğŸ¢ ê´‘ê³ ì£¼ ì¶”ê°€</div>
      <button class="modal-close" onclick="closeAddClientModal()">âœ•</button>
    </div>
    <div class="modal-body" style="padding:20px;">
      <label style="font-size:.78rem;color:#64748b;display:block;margin-bottom:6px;">ê´‘ê³ ì£¼ ì´ë¦„</label>
      <input type="text" id="newClientName" placeholder="ì˜ˆ: ë„ë‹´ì‚°ì‚¼, ê¸€ë¡œì›°ì½”ì–´"
        onkeydown="if(event.key==='Enter')submitAddClient()">
      <div style="margin-top:14px;display:flex;gap:9px;justify-content:flex-end;">
        <button class="btn btn-secondary btn-sm" onclick="closeAddClientModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary btn-sm" onclick="submitAddClient()">ì¶”ê°€</button>
      </div>
      <div class="status-msg" id="clientAddStatus"></div>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ëª¨ë‹¬: ìƒí’ˆ ê²€ìƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="searchModal" class="modal-overlay" style="display:none;"
  onclick="if(event.target.id==='searchModal')closeSearchModal()">
  <div class="modal-box">
    <div class="modal-head">
      <div>
        <div style="font-weight:700;color:#e2e8f0;">ğŸ” í‚¤ì›Œë“œë¡œ ë‚´ ìƒí’ˆ ì°¾ê¸°</div>
        <div style="font-size:.72rem;color:#64748b;margin-top:2px;">ì„ íƒí•˜ë©´ URLì´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤</div>
      </div>
      <button class="modal-close" onclick="closeSearchModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;margin-bottom:13px;">
        <input type="text" id="srKw" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ (ì˜ˆ: ì¥ë‡Œì‚¼)" style="flex:1;"
          onkeydown="if(event.key==='Enter')doSearch(1)">
        <button class="btn btn-primary btn-sm" onclick="doSearch(1)" style="white-space:nowrap;">ê²€ìƒ‰</button>
      </div>
      <div id="srLoading" style="display:none;text-align:center;padding:20px;color:#64748b;">
        <div class="spinner" style="margin:0 auto 8px;"></div>ê²€ìƒ‰ ì¤‘...
      </div>
      <div id="srResults"></div>
      <div id="srPaging" style="display:flex;gap:6px;justify-content:center;margin-top:10px;"></div>
    </div>
    <div class="modal-footer">
      ğŸ’¡ <strong style="color:#f59e0b;">ğŸ· ê°€ê²©ë¹„êµ</strong> = ì¹´íƒˆë¡œê·¸ &nbsp;|&nbsp;
      <strong style="color:#3b82f6;">ğŸ“¦ ì¼ë°˜</strong> = ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´
    </div>
  </div>
</div>

{% endblock %}


{% block extra_script %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒíƒœ ë³€ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSearchCid = null;   // ê²€ìƒ‰ ëª¨ë‹¬ì´ ì–´ëŠ ê´‘ê³ ì£¼ìš©ì¸ì§€

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showClient(cid) {
  document.querySelectorAll('.client-panel').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.ctab').forEach(el => el.classList.remove('active'));
  const panel = document.getElementById('cpanel_' + cid);
  const tab   = document.getElementById('ctab_'   + cid);
  if (panel) panel.classList.add('active');
  if (tab)   tab.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒíƒœ ë©”ì‹œì§€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(cid, msg, color='#64748b') {
  const el = document.getElementById('st_' + cid);
  if (el) { el.textContent = msg; el.style.color = color; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê´‘ê³ ì£¼ ì¶”ê°€ ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddClientModal() {
  document.getElementById('addClientModal').style.display = 'flex';
  setTimeout(() => document.getElementById('newClientName').focus(), 80);
}
function closeAddClientModal() {
  document.getElementById('addClientModal').style.display = 'none';
  document.getElementById('newClientName').value = '';
  document.getElementById('clientAddStatus').textContent = '';
}

async function submitAddClient() {
  const name = document.getElementById('newClientName').value.trim();
  if (!name) { alert('ê´‘ê³ ì£¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  const fd = new FormData();
  fd.append('name', name);
  const res  = await fetch('/clients/add', { method: 'POST', body: fd });
  const data = await res.json();
  if (data.error) {
    document.getElementById('clientAddStatus').textContent = 'âŒ ' + data.error;
    return;
  }
  // íƒ­ + íŒ¨ë„ ë™ì  ì¶”ê°€
  addClientTab(data.id, data.name);
  closeAddClientModal();
  // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = 'none';
}

function addClientTab(cid, name) {
  // íƒ­ ë²„íŠ¼ ì‚½ì…
  const tabbar = document.getElementById('clientTabbar');
  const addBtn = tabbar.querySelector('.ctab-add');
  const tab    = document.createElement('button');
  tab.className   = 'ctab';
  tab.id          = 'ctab_' + cid;
  tab.innerHTML   = `ğŸª ${name} <span class="tab-del" onclick="event.stopPropagation();deleteClient(${cid},'${name}')" title="ì‚­ì œ">âœ•</span>`;
  tab.onclick     = () => showClient(cid);
  tabbar.insertBefore(tab, addBtn);

  // íŒ¨ë„ ì¶”ê°€
  const panels = document.getElementById('clientTabbar').parentNode;
  const panel  = document.createElement('div');
  panel.className = 'client-panel';
  panel.id        = 'cpanel_' + cid;
  panel.innerHTML = buildPanelHTML(cid, name);
  // íƒ­ë°” ë‹¤ìŒì— ì‚½ì…
  const lastPanel = document.querySelector('.client-panel:last-of-type');
  if (lastPanel) {
    lastPanel.insertAdjacentElement('afterend', panel);
  } else {
    tabbar.insertAdjacentElement('afterend', panel);
  }
  showClient(cid);
}

function buildPanelHTML(cid, name) {
  return `
  <div class="input-panel">
    <div class="input-panel-title">â• ${name} ìƒí’ˆ Â· í‚¤ì›Œë“œ ë“±ë¡</div>
    <div class="input-grid">
      <div class="input-block">
        <label>ìƒí’ˆ URL <span style="font-weight:400;color:#475569;">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ë˜ëŠ” ê°€ê²©ë¹„êµ URL</span></label>
        <div style="display:flex;gap:7px;">
          <input type="text" id="url_${cid}" placeholder="https://smartstore.naver.com/...">
          <button class="btn btn-secondary btn-sm" style="white-space:nowrap;" onclick="openSearchModal(${cid})">ğŸ”</button>
        </div>
        <input type="text" id="alias_${cid}" placeholder="ìƒí’ˆ ë³„ì¹­ (ì„ íƒ)" style="margin-top:7px;">
      </div>
      <div class="input-block">
        <label>í‚¤ì›Œë“œ <span style="font-weight:400;color:#475569;">ì‰¼í‘œÂ·ì¤„ë°”ê¿ˆìœ¼ë¡œ ë‹¤ì¤‘ ì…ë ¥</span></label>
        <textarea id="kw_${cid}" rows="2" placeholder="ì¥ë‡Œì‚¼&#10;ì‚°ì–‘ì‚¼, ì‚°ì–‘ì‚°ì‚¼"></textarea>
      </div>
    </div>
    <div style="display:flex;gap:9px;margin-top:13px;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-primary btn-sm" onclick="submitProduct(${cid})">ğŸ“¦ ìƒí’ˆ ì¶”ê°€</button>
      <button class="btn btn-secondary btn-sm" onclick="submitKeywords(${cid})">ğŸ”‘ í‚¤ì›Œë“œ ì¶”ê°€</button>
      <span class="status-msg" id="st_${cid}"></span>
    </div>
    <div id="kwtags_${cid}" style="display:none;margin-top:12px;">
      <div style="font-size:.69rem;color:#475569;margin-bottom:7px;text-transform:uppercase;letter-spacing:.04em;">ë“±ë¡ëœ í‚¤ì›Œë“œ</div>
      <div id="kwtaglist_${cid}" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
  </div>
  <div class="table-card">
    <div class="table-card-head">
      <h2>ğŸ“‹ ìˆœìœ„ í˜„í™© <span style="font-size:.76rem;color:#475569;font-weight:400;">â€” ${name}</span></h2>
      <span style="font-size:.74rem;color:#475569;" id="rowcnt_${cid}">0ê°œ ì¡°í•©</span>
    </div>
    <div class="empty-tbl" id="emptytbl_${cid}">
      <div class="icon">ğŸ“­</div>
      <div style="font-size:.88rem;color:#475569;margin-bottom:4px;">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
      <div style="font-size:.8rem;color:#334155;">ìœ„ì—ì„œ ìƒí’ˆ URLê³¼ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
    </div>
    <div class="table-wrap" id="tblwrap_${cid}" style="display:none;">
      <table class="rtbl" id="tbl_${cid}">
        <thead><tr>
          <th style="width:190px;">ìƒí’ˆëª…</th><th>í‚¤ì›Œë“œ</th>
          <th style="width:90px;text-align:center;">ìˆœìœ„</th>
          <th style="width:90px;">ê°€ê²©</th>
          <th style="width:130px;">í™•ì¸ ì‹œê°</th>
          <th style="width:110px;">ì¶”ì´</th>
          <th style="width:46px;"></th>
        </tr></thead>
        <tbody id="tbody_${cid}"></tbody>
      </table>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê´‘ê³ ì£¼ ì‚­ì œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteClient(cid, name) {
  if (!confirm(`"${name}" ê´‘ê³ ì£¼ë¥¼ ì‚­ì œí•˜ë©´ ëª¨ë“  ìƒí’ˆÂ·í‚¤ì›Œë“œÂ·ìˆœìœ„ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nê³„ì†í• ê¹Œìš”?`)) return;
  const res  = await fetch(`/clients/${cid}/delete`, { method: 'POST' });
  const data = await res.json();
  if (!data.ok) { alert('ì‚­ì œ ì‹¤íŒ¨'); return; }
  document.getElementById('ctab_'   + cid)?.remove();
  document.getElementById('cpanel_' + cid)?.remove();
  // ë‚¨ì€ ì²« íƒ­ í™œì„±í™”
  const firstTab = document.querySelector('.ctab');
  if (firstTab) {
    const id = firstTab.id.replace('ctab_', '');
    showClient(parseInt(id));
  } else {
    // ê´‘ê³ ì£¼ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ
    let empty = document.getElementById('emptyState');
    if (!empty) {
      empty = document.createElement('div');
      empty.id = 'emptyState';
      empty.className = 'empty-clients';
      empty.innerHTML = `<div class="icon">ğŸ¢</div><h3>ë“±ë¡ëœ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ìƒë‹¨ì˜ ï¼‹ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê´‘ê³ ì£¼ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p><button class="btn btn-primary" onclick="openAddClientModal()">ï¼‹ ê´‘ê³ ì£¼ ì¶”ê°€</button>`;
      document.getElementById('clientTabbar').insertAdjacentElement('afterend', empty);
    }
    empty.style.display = 'block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒí’ˆ ì¶”ê°€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitProduct(cid) {
  const url   = document.getElementById('url_'  + cid)?.value.trim();
  const alias = document.getElementById('alias_'+ cid)?.value.trim();
  if (!url) { setStatus(cid, 'âŒ ìƒí’ˆ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', '#ef4444'); return; }
  setStatus(cid, 'ìƒí’ˆ ì¶”ê°€ ì¤‘...', '#64748b');

  const fd = new FormData();
  fd.append('product_url',  url);
  fd.append('product_name', alias);
  try {
    const res  = await fetch(`/clients/${cid}/products/add`, { method:'POST', body:fd });
    const data = await res.json();
    if (data.error) { setStatus(cid, 'âŒ ' + data.error, '#ef4444'); return; }
    setStatus(cid, 'âœ… ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', '#03c75a');
    document.getElementById('url_'  + cid).value = '';
    document.getElementById('alias_'+ cid).value = '';
    addProductRow(cid, data);
    setTimeout(() => setStatus(cid, ''), 3000);
  } catch(e) {
    setStatus(cid, 'âŒ ì˜¤ë¥˜: ' + e.message, '#ef4444');
  }
}

function addProductRow(cid, data) {
  // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
  const empty = document.getElementById('emptytbl_' + cid);
  if (empty) empty.style.display = 'none';
  const wrap = document.getElementById('tblwrap_' + cid);
  if (wrap) wrap.style.display = 'block';

  // í‚¤ì›Œë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  const tagList = document.getElementById('kwtaglist_' + cid);
  const tags    = tagList ? tagList.querySelectorAll('.kw-tag') : [];
  const tbody   = document.getElementById('tbody_' + cid);
  if (!tbody) return;

  if (tags.length === 0) {
    // í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ë‹¨ë… í–‰
    const tr = document.createElement('tr');
    tr.id = `tr_${data.pid}_none`;
    tr.innerHTML = `
      <td><a href="${data.product_url}" target="_blank"
           style="color:#e2e8f0;font-weight:600;font-size:.84rem;text-decoration:none;">
        ${data.product_name}</a>
        <div style="font-size:.7rem;color:#334155;margin-top:1px;">ID: ${data.product_id}</div>
      </td>
      <td><span class="kw-tag" style="background:transparent;border-color:#2d3f5a;">â€”</span></td>
      <td style="text-align:center;"><span style="color:#334155;font-size:.77rem;">ë¯¸ì¶”ì </span></td>
      <td style="color:#94a3b8;font-size:.81rem;">-</td>
      <td style="color:#475569;font-size:.76rem;">-</td>
      <td></td>
      <td style="text-align:center;"><button class="del-btn" onclick="deleteProduct(${cid},${data.pid})">ğŸ—‘</button></td>
    `;
    tbody.appendChild(tr);
  } else {
    // í‚¤ì›Œë“œ ìˆ˜ë§Œí¼ í–‰ ì¶”ê°€
    tags.forEach((tag, i) => {
      const kw  = tag.childNodes[0].textContent.trim();
      const tr  = document.createElement('tr');
      tr.id = `tr_${data.pid}_kw_${i}`;
      tr.innerHTML = `
        <td>${i===0 ? `<a href="${data.product_url}" target="_blank"
             style="color:#e2e8f0;font-weight:600;font-size:.84rem;text-decoration:none;">
          ${data.product_name}</a>
          <div style="font-size:.7rem;color:#334155;margin-top:1px;">ID: ${data.product_id}</div>`
          : `<span style="color:#2d3f5a;font-size:.76rem;">â†‘ ë™ì¼ ìƒí’ˆ</span>`}
        </td>
        <td><span class="kw-tag" style="background:transparent;border-color:#2d3f5a;">${kw}</span></td>
        <td style="text-align:center;"><span style="color:#334155;font-size:.77rem;">ë¯¸ì¶”ì </span></td>
        <td style="color:#94a3b8;font-size:.81rem;">-</td>
        <td style="color:#475569;font-size:.76rem;">-</td>
        <td></td>
        <td style="text-align:center;">${i===0 ? `<button class="del-btn" onclick="deleteProduct(${cid},${data.pid})">ğŸ—‘</button>` : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  // í–‰ ìˆ˜ ì—…ë°ì´íŠ¸
  updateRowCount(cid);
}

function updateRowCount(cid) {
  const tbody = document.getElementById('tbody_' + cid);
  const cnt   = document.getElementById('rowcnt_' + cid);
  if (tbody && cnt) cnt.textContent = tbody.querySelectorAll('tr').length + 'ê°œ ì¡°í•©';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒí’ˆ ì‚­ì œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteProduct(cid, pid) {
  if (!confirm('ì´ ìƒí’ˆì„ ì‚­ì œí• ê¹Œìš”?')) return;
  const res  = await fetch(`/clients/${cid}/products/${pid}/delete`, { method:'POST' });
  const data = await res.json();
  if (!data.ok) { alert('ì‚­ì œ ì‹¤íŒ¨'); return; }
  // ê´€ë ¨ tr ëª¨ë‘ ì œê±°
  document.querySelectorAll(`tr[id^="tr_${pid}_"]`).forEach(tr => tr.remove());
  updateRowCount(cid);
  // í–‰ì´ ì—†ìœ¼ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
  const tbody = document.getElementById('tbody_' + cid);
  if (tbody && tbody.querySelectorAll('tr').length === 0) {
    const wrap = document.getElementById('tblwrap_' + cid);
    if (wrap) wrap.style.display = 'none';
    const empty = document.getElementById('emptytbl_' + cid);
    if (empty) empty.style.display = 'block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í‚¤ì›Œë“œ ì¶”ê°€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitKeywords(cid) {
  const raw = document.getElementById('kw_' + cid)?.value.trim();
  if (!raw) { setStatus(cid, 'âŒ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', '#ef4444'); return; }
  setStatus(cid, 'í‚¤ì›Œë“œ ì¶”ê°€ ì¤‘...', '#64748b');

  const fd = new FormData();
  fd.append('keyword', raw);
  try {
    const res  = await fetch(`/clients/${cid}/keywords/add`, { method:'POST', body:fd });
    const data = await res.json();
    if (data.error) { setStatus(cid, 'âŒ ' + data.error, '#ef4444'); return; }

    // íƒœê·¸ DOM ì¶”ê°€
    const tagArea = document.getElementById('kwtags_'   + cid);
    const tagList = document.getElementById('kwtaglist_'+ cid);
    if (tagArea) tagArea.style.display = 'block';
    data.added.forEach(kw => {
      const kid = data.kid_map[kw] || 0;
      const span = document.createElement('span');
      span.className = 'kw-tag';
      span.id = 'kwtag_' + kid;
      span.innerHTML = `${kw}<button class="kw-del" onclick="deleteKeyword(${cid},${kid},this)">âœ•</button>`;
      if (tagList) tagList.appendChild(span);
    });

    document.getElementById('kw_' + cid).value = '';
    setStatus(cid, `âœ… "${data.added.join(', ')}" ì¶”ê°€ë¨!`, '#03c75a');
    setTimeout(() => setStatus(cid, ''), 3000);
  } catch(e) {
    setStatus(cid, 'âŒ ì˜¤ë¥˜: ' + e.message, '#ef4444');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í‚¤ì›Œë“œ ì‚­ì œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteKeyword(cid, kid, btn) {
  btn.disabled = true;
  try {
    const res  = await fetch(`/clients/${cid}/keywords/${kid}/delete`, { method:'POST' });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('kwtag_' + kid)?.remove();
      // íƒœê·¸ ì—†ìœ¼ë©´ ì˜ì—­ ìˆ¨ê¸°ê¸°
      const tagList = document.getElementById('kwtaglist_' + cid);
      if (tagList && tagList.querySelectorAll('.kw-tag').length === 0) {
        document.getElementById('kwtags_' + cid).style.display = 'none';
      }
    }
  } catch(e) {
    btn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì „ì²´ ì¶”ì 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function trackAll() {
  const btn = document.getElementById('btnTrackAll');
  if (!confirm('ì „ì²´ ê´‘ê³ ì£¼ ìˆœìœ„ ì¶”ì ì„ ì‹œì‘í• ê¹Œìš”?')) return;
  btn.disabled = true;
  try {
    const res  = await fetch('/track/now', { method:'POST' });
    const data = await res.json();
    if (data.error) { alert(data.error); btn.disabled = false; return; }
    // ë°°ë„ˆ í‘œì‹œ
    let banner = document.getElementById('trackBanner');
    if (!banner) {
      banner = document.createElement('div');
      banner.id = 'trackBanner';
      banner.className = 'track-banner';
      banner.innerHTML = '<div class="spinner"></div><span>ìˆœìœ„ ì¶”ì  ì¤‘... ì™„ë£Œ í›„ ìë™ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.</span>';
      document.querySelector('.page-header').insertAdjacentElement('afterend', banner);
    }
    banner.style.display = 'flex';
    // í´ë§
    const poll = setInterval(async () => {
      try {
        const d = await fetch('/track/status').then(r => r.json());
        if (!d.running) {
          clearInterval(poll);
          location.reload();
        }
      } catch(e) {}
    }, 4000);
  } catch(e) {
    btn.disabled = false;
    alert('ì˜¤ë¥˜: ' + e.message);
  }
}

// ì´ˆê¸° ì¶”ì  ì¤‘ì´ë©´ í´ë§
{% if global_tracking.running %}
const initPoll = setInterval(async () => {
  try {
    const d = await fetch('/track/status').then(r => r.json());
    if (!d.running) { clearInterval(initPoll); location.reload(); }
  } catch(e) {}
}, 4000);
{% endif %}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒí’ˆ ê²€ìƒ‰ ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSearchModal(cid) {
  currentSearchCid = cid;
  document.getElementById('searchModal').style.display = 'flex';
  document.getElementById('srResults').innerHTML = '';
  document.getElementById('srPaging').innerHTML  = '';
  setTimeout(() => document.getElementById('srKw').focus(), 80);
}
function closeSearchModal() {
  document.getElementById('searchModal').style.display = 'none';
  currentSearchCid = null;
}

async function doSearch(page) {
  const kw = document.getElementById('srKw').value.trim();
  if (!kw) { alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  document.getElementById('srLoading').style.display = 'block';
  document.getElementById('srResults').innerHTML    = '';
  document.getElementById('srPaging').innerHTML     = '';

  try {
    const data = await fetch(`/api/search-products?q=${encodeURIComponent(kw)}&page=${page}`).then(r => r.json());
    document.getElementById('srLoading').style.display = 'none';
    if (data.error) {
      document.getElementById('srResults').innerHTML = `<p style="color:#ef4444;text-align:center;padding:16px;">${data.error}</p>`;
      return;
    }
    const html = (data.items||[]).map(item => {
      const badge = item.isCatalog
        ? `<span class="bc">ğŸ· ê°€ê²©ë¹„êµ</span>`
        : `<span class="bn">ğŸ“¦ ì¼ë°˜</span>`;
      const price = item.lprice ? `${item.lprice.toLocaleString()}ì›~` : '';
      const img   = item.image
        ? `<img src="${item.image}" onerror="this.style.display='none'" style="width:50px;height:50px;object-fit:cover;border-radius:6px;flex-shrink:0;">`
        : `<div style="width:50px;height:50px;background:#1e293b;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;">ğŸ›’</div>`;
      const safeItem = JSON.stringify(item).replace(/'/g,"&#39;");
      return `<div class="sr-item">
        ${img}
        <div class="sr-info">
          <div class="sr-title">[${item.rank}ìœ„] ${item.title}</div>
          <div class="sr-meta">${badge}<span>${item.mallName}</span>${price?`<span style="color:#03c75a;font-weight:600">${price}</span>`:''}</div>
        </div>
        <button class="pick-btn" onclick='pickProduct(${safeItem})'>ì„ íƒ</button>
      </div>`;
    }).join('') || '<p style="color:#64748b;text-align:center;padding:24px;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>';

    document.getElementById('srResults').innerHTML = html;

    const maxP = Math.min(Math.ceil((data.total||0)/20), 10);
    if (maxP > 1) {
      document.getElementById('srPaging').innerHTML = Array.from({length:maxP},(_,i) =>
        `<button onclick="doSearch(${i+1})"
          style="background:${i+1===page?'#03c75a':'#1e293b'};color:${i+1===page?'#000':'#94a3b8'};
                 border:1px solid #334155;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:.8rem;">${i+1}</button>`
      ).join('');
    }
  } catch(e) {
    document.getElementById('srLoading').style.display = 'none';
    document.getElementById('srResults').innerHTML = `<p style="color:#ef4444;text-align:center;padding:16px;">ì˜¤ë¥˜: ${e.message}</p>`;
  }
}

function pickProduct(item) {
  if (!currentSearchCid) return;
  const urlEl   = document.getElementById('url_'  + currentSearchCid);
  const aliasEl = document.getElementById('alias_'+ currentSearchCid);
  if (urlEl)   urlEl.value   = item.addUrl || item.link || '';
  if (aliasEl) aliasEl.value = (item.title||'').replace(/<[^>]+>/g,'').substring(0,30);
  closeSearchModal();
  setStatus(currentSearchCid, 'âœ… ìƒí’ˆ ì„ íƒë¨. "ìƒí’ˆ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“±ë¡í•˜ì„¸ìš”.', '#03c75a');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¯¸ë‹ˆ ì°¨íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('canvas.mini').forEach(async canvas => {
    const pid = canvas.dataset.pid;
    const kw  = canvas.dataset.kw;
    if (!pid || !kw || kw==='â€”') return;
    try {
      const data = await fetch(`/api/history?pid=${encodeURIComponent(pid)}&kw=${encodeURIComponent(kw)}`).then(r=>r.json());
      if (!data.length) return;
      new Chart(canvas, {
        type:'line',
        data:{
          labels: data.map(d=>d.date.slice(5,10)),
          datasets:[{ data:data.map(d=>d.rank), borderColor:'#03c75a', borderWidth:1.5,
            pointRadius:0, tension:0.3, fill:false, spanGaps:true }]
        },
        options:{
          responsive:false, animation:false,
          scales:{x:{display:false},y:{display:false,reverse:true}},
          plugins:{legend:{display:false},tooltip:{enabled:false}}
        }
      });
    } catch(e){}
  });
});
</script>
{% endblock %}
