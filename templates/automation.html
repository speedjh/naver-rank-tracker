{% extends "base.html" %}
{% block title %}ì—…ë¬´ ìë™í™” - ë„¤ì´ë²„ ìˆœìœ„ íŠ¸ë˜ì»¤{% endblock %}

{% block extra_style %}
<style>
/* â”€â”€ ìë™í™” í˜ì´ì§€ ë ˆì´ì•„ì›ƒ â”€â”€ */
.auto-tabs{display:flex;gap:0;border-bottom:2px solid #334155;margin-bottom:28px;}
.auto-tab{padding:10px 22px;cursor:pointer;font-size:.875rem;font-weight:600;color:#64748b;border-bottom:2px solid transparent;margin-bottom:-2px;transition:.15s;}
.auto-tab.active{color:#03c75a;border-bottom-color:#03c75a;}
.auto-tab:hover:not(.active){color:#e2e8f0;background:#1e2433;border-radius:6px 6px 0 0;}

.tab-panel{display:none;} .tab-panel.active{display:block;}

/* â”€â”€ ì…ë ¥ í¼ â”€â”€ */
.order-input-area{
  background:#1e2433;border-radius:12px;padding:24px;margin-bottom:20px;
}
.order-input-area textarea{
  width:100%;min-height:160px;resize:vertical;
  background:#0f1117;border:1px solid #334155;color:#e2e8f0;
  padding:12px;border-radius:8px;font-size:.875rem;line-height:1.6;
  font-family:inherit;
}
.order-input-area textarea:focus{border-color:#03c75a;outline:none;box-shadow:0 0 0 2px #03c75a22;}

.fields-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.fields-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.field-hint{font-size:.75rem;color:#475569;margin-top:3px;}

/* â”€â”€ ì‹œë‚˜ë¦¬ì˜¤ ë±ƒì§€ â”€â”€ */
.scenario-tabs{display:flex;gap:8px;margin-bottom:20px;}
.sc-tab{padding:7px 18px;border-radius:20px;cursor:pointer;font-size:.82rem;font-weight:600;
  border:1px solid #334155;color:#64748b;transition:.15s;}
.sc-tab.active{background:#03c75a22;color:#03c75a;border-color:#03c75a44;}
.sc-tab:hover:not(.active){background:#253048;}

/* â”€â”€ ê²°ê³¼ í…Œì´ë¸” â”€â”€ */
.result-section{background:#1e2433;border-radius:12px;padding:24px;margin-top:20px;}
.result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.result-title{font-size:1rem;font-weight:700;color:#f1f5f9;}
.copy-btn{background:#03c75a;color:#fff;border:none;padding:8px 20px;border-radius:8px;
  font-size:.82rem;font-weight:700;cursor:pointer;transition:.15s;display:flex;align-items:center;gap:6px;}
.copy-btn:hover{background:#02b350;}
.copy-btn.copied{background:#334155;color:#94a3b8;}

.sheet-table-wrap{overflow-x:auto;border-radius:8px;}
.sheet-table{border-collapse:collapse;min-width:900px;font-size:.8rem;}
.sheet-table th{
  background:#253048;color:#94a3b8;padding:8px 12px;border:1px solid #334155;
  font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap;
}
.sheet-table td{
  padding:8px 12px;border:1px solid #2d3748;background:#0f1117;
  vertical-align:middle;white-space:nowrap;
}
.sheet-table td.merged-top{background:#131b2e;color:#03c75a;font-weight:600;}
.sheet-table td.merged-mid{background:#131b2e;color:#334155;font-size:.7rem;font-style:italic;}
.sheet-table td.col-web{color:#f59e0b;font-weight:700;}
.sheet-table td.col-formula{color:#334155;font-style:italic;}
.sheet-table td.col-keyword{color:#3b82f6;font-weight:600;}
.sheet-table td.editable{
  background:#1e2433;color:#e2e8f0;cursor:text;
}
.sheet-table td.editable:focus{
  outline:1px solid #03c75a;background:#253048;
}
.sheet-table tr:hover td:not(.merged-mid){background:#161d2e;}
.row-num{color:#475569;font-size:.7rem;font-weight:600;padding:8px 6px !important;background:#0a0e1a !important;border-right:2px solid #334155 !important;}

/* â”€â”€ TSV ë°•ìŠ¤ â”€â”€ */
.tsv-box{background:#0a0e1a;border:1px solid #334155;border-radius:8px;padding:14px;
  font-family:monospace;font-size:.78rem;color:#94a3b8;margin-top:16px;
  white-space:pre;overflow-x:auto;max-height:160px;overflow-y:auto;line-height:1.5;}

/* â”€â”€ íŒŒì‹± ê²°ê³¼ ë±ƒì§€ â”€â”€ */
.parsed-fields{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
.pf-badge{background:#1e2433;border:1px solid #334155;border-radius:6px;padding:5px 12px;
  font-size:.78rem;color:#94a3b8;}
.pf-badge span{color:#03c75a;font-weight:600;margin-left:4px;}

/* ë¯¸ì…˜í…ìŠ¤íŠ¸ í¸ì§‘ */
.mission-edit{
  width:100%;background:#0f1117;border:1px solid #334155;color:#e2e8f0;
  padding:10px;border-radius:6px;font-size:.82rem;resize:vertical;min-height:80px;
}

/* info box */
.info-box{background:#03c75a0d;border:1px solid #03c75a33;border-radius:8px;padding:14px;
  font-size:.82rem;color:#94a3b8;line-height:1.6;margin-bottom:16px;}
.info-box strong{color:#03c75a;}

/* â”€â”€ ì„¹ì…˜ ì œëª© â”€â”€ */
.section-title{font-size:.8rem;font-weight:700;color:#64748b;text-transform:uppercase;
  letter-spacing:.06em;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.section-title::before{content:'';display:inline-block;width:3px;height:14px;
  background:#03c75a;border-radius:2px;}

/* ë°˜ì‘í˜• */
@media(max-width:768px){.fields-grid{grid-template-columns:1fr 1fr;}.fields-grid-2{grid-template-columns:1fr;}}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">ğŸš€ ì—…ë¬´ ìë™í™”</div>
  <div class="page-sub">ë¦¬ì›Œë“œ ë§ˆì¼€íŒ… ìº í˜ì¸ ìë™ ì‹œíŠ¸ ìƒì„±</div>
</div>

<!-- ë©”ì¸ íƒ­ -->
<div class="auto-tabs">
  <div class="auto-tab active" onclick="switchAutoTab('reward')">ğŸ¯ ë¦¬ì›Œë“œ ë§ˆì¼€íŒ…</div>
  <div class="auto-tab" onclick="switchAutoTab('bulk')">ğŸ“‹ ì¼ê´„ ì²˜ë¦¬ (ì¤€ë¹„ì¤‘)</div>
</div>

<!-- â•â•â•â• ë¦¬ì›Œë“œ ë§ˆì¼€íŒ… íƒ­ â•â•â•â• -->
<div id="tab-reward" class="tab-panel active">

  <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
  <div class="scenario-tabs">
    <div class="sc-tab active" id="sc1-tab" onclick="switchScenario(1)">
      ğŸ“Œ ì‹œë‚˜ë¦¬ì˜¤ 1 â€” í‚¤ì›Œë“œ ì œê³µ
    </div>
    <div class="sc-tab" id="sc2-tab" onclick="switchScenario(2)">
      ğŸ” ì‹œë‚˜ë¦¬ì˜¤ 2 â€” í‚¤ì›Œë“œ ì—†ìŒ (ì¤€ë¹„ì¤‘)
    </div>
  </div>

  <div class="info-box">
    <strong>ğŸ“‹ ì‚¬ìš©ë²•:</strong> ì£¼ë¬¸ì„œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ í•„ë“œë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤. ë˜ëŠ” ì•„ë˜ ì…ë ¥ë€ì— ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”. ìƒì„±ëœ í‘œë¥¼ ë³µì‚¬í•´ì„œ Google Sheetsì— ë¶™ì—¬ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
  </div>

  <!-- ì£¼ë¬¸ì„œ ë¶™ì—¬ë„£ê¸° -->
  <div class="order-input-area">
    <div class="section-title">ì£¼ë¬¸ì„œ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° (ìë™ íŒŒì‹±)</div>
    <textarea id="orderText" placeholder="ì£¼ë¬¸ì„œ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...
ì˜ˆì‹œ:
ì‹œì‘ì¼: 2025-03-01
ì¢…ë£Œì¼: 2025-03-07
í‚¤ì›Œë“œ: ì¥ë‡Œì‚¼
ìƒí’ˆURL: https://smartstore.naver.com/dodamginseng/products/12345678
ìƒí’ˆëª…: ë„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼ 10ë…„ê·¼ 100g
ì¼ì¼íŠ¸ë˜í”½: 50
ê²½ê³¼ì¼ìˆ˜: 3
ì´íŠ¸ë˜í”½: 150"></textarea>
    <div style="margin-top:10px;display:flex;gap:8px;">
      <button class="btn btn-primary btn-sm" onclick="parseOrder()">ğŸ” ìë™ íŒŒì‹±</button>
      <button class="btn btn-secondary btn-sm" onclick="clearAll()">ğŸ—‘ ì´ˆê¸°í™”</button>
    </div>
    <div id="parsed-display" class="parsed-fields" style="display:none;"></div>
  </div>

  <!-- ìˆ˜ë™ ì…ë ¥ -->
  <div class="card" style="margin-bottom:20px;">
    <div class="card-title">ğŸ“ ìº í˜ì¸ ì •ë³´ ì…ë ¥</div>

    <div class="fields-grid">
      <div class="form-group">
        <label>ì‹œì‘ì¼</label>
        <input type="text" id="f_start" placeholder="2025-03-01">
      </div>
      <div class="form-group">
        <label>ì¢…ë£Œì¼</label>
        <input type="text" id="f_end" placeholder="2025-03-07">
      </div>
      <div class="form-group">
        <label>í‚¤ì›Œë“œ</label>
        <input type="text" id="f_keyword" placeholder="ì¥ë‡Œì‚¼">
        <div class="field-hint">ì‹œë‚˜ë¦¬ì˜¤ 1: ê´‘ê³ ì£¼ ì œê³µ í‚¤ì›Œë“œ</div>
      </div>
    </div>

    <div class="fields-grid-2">
      <div class="form-group">
        <label>ìƒí’ˆ URL</label>
        <input type="text" id="f_url" placeholder="https://smartstore.naver.com/..." oninput="extractFromUrl()">
        <div class="field-hint" id="url-extract-hint">URL ì…ë ¥ ì‹œ ìƒí’ˆë²ˆí˜¸/ì—…ì²´ëª… ìë™ ì¶”ì¶œ</div>
      </div>
      <div class="form-group">
        <label>ìƒí’ˆëª…</label>
        <input type="text" id="f_name" placeholder="ë„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼ 10ë…„ê·¼ 100g">
      </div>
    </div>

    <div class="fields-grid">
      <div class="form-group">
        <label>ì¼ì¼ íŠ¸ë˜í”½</label>
        <input type="number" id="f_daily" placeholder="50">
      </div>
      <div class="form-group">
        <label>ê²½ê³¼ ì¼ìˆ˜</label>
        <input type="number" id="f_elapsed" placeholder="3">
      </div>
      <div class="form-group">
        <label>ì´ íŠ¸ë˜í”½</label>
        <input type="number" id="f_total" placeholder="150">
        <div class="field-hint">ìë™ ê³„ì‚° ë˜ëŠ” ì§ì ‘ ì…ë ¥</div>
      </div>
    </div>

    <div class="fields-grid-2">
      <div class="form-group">
        <label>ìƒí’ˆë²ˆí˜¸ (ìë™ì¶”ì¶œ)</label>
        <input type="text" id="f_pid" placeholder="12345678" oninput="updatePreview()">
        <div class="field-hint">Iì—´: ì• 3ìë¦¬ / Kì—´: ì• 5ìë¦¬</div>
      </div>
      <div class="form-group">
        <label>ì—…ì²´ëª… (ìë™ì¶”ì¶œ)</label>
        <input type="text" id="f_store" placeholder="ë„ë‹´ì‚°ì‚¼" oninput="updatePreview()">
        <div class="field-hint">Mì—´ ìë™ ì…ë ¥</div>
      </div>
    </div>

    <div class="form-group" style="margin-bottom:0;">
      <label>ë¯¸ì…˜ ì„¤ëª… (Jì—´) â€” ì§ì ‘ í¸ì§‘ ê°€ëŠ¥</label>
      <textarea class="mission-edit" id="f_mission">ë„¤ì´ë²„ ì‡¼í•‘ì—ì„œ "{keyword}"ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”.
ê²€ìƒ‰ ê²°ê³¼ì—ì„œ "{blurred_name}" ìƒí’ˆì„ ì°¾ì•„ë³´ì„¸ìš”.
ìƒí’ˆë²ˆí˜¸ ì• 5ìë¦¬ë¥¼ ì •ë‹µë€ì— ì…ë ¥í•´ì£¼ì„¸ìš”!</textarea>
      <div class="field-hint">í‚¤ì›Œë“œ, ìƒí’ˆëª… ë¸”ëŸ¬ ì²˜ë¦¬ í›„ ìë™ ì‚½ì…ë¨</div>
    </div>
  </div>

  <!-- ìƒì„± ë²„íŠ¼ -->
  <div style="text-align:center;margin-bottom:20px;">
    <button class="btn btn-primary" style="padding:12px 36px;font-size:.95rem;" onclick="generateSheet()">
      âœ¨ êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ìƒì„±
    </button>
  </div>

  <!-- ê²°ê³¼ -->
  <div id="result-section" class="result-section" style="display:none;">
    <div class="result-header">
      <div class="result-title">ğŸ“Š ìƒì„±ëœ ì‹œíŠ¸ ë°ì´í„° (í–‰ 3~7)</div>
      <div style="display:flex;gap:8px;">
        <button class="copy-btn" id="copy-btn" onclick="copyTSV()">
          ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬ (êµ¬ê¸€ ì‹œíŠ¸ìš©)
        </button>
      </div>
    </div>

    <div class="sheet-table-wrap">
      <table class="sheet-table" id="sheet-table">
        <thead>
          <tr>
            <th>í–‰</th>
            <th>Bì—´</th>
            <th>Cì—´ (ì‹œì‘ì¼)</th>
            <th>Dì—´ (ì¢…ë£Œì¼)</th>
            <th>Eì—´</th>
            <th>Fì—´</th>
            <th>Gì—´</th>
            <th>Hì—´</th>
            <th>Iì—´ (í‚¤ì›Œë“œíŒíŠ¸)</th>
            <th>Jì—´ (ë¯¸ì…˜)</th>
            <th>Kì—´ (ì •ë‹µ)</th>
            <th>Lì—´ (íŒíŠ¸URL)</th>
            <th>Mì—´ (ì—…ì²´)</th>
            <th>Nì—´ (ìˆ˜ëŸ‰)</th>
          </tr>
        </thead>
        <tbody id="sheet-tbody">
        </tbody>
      </table>
    </div>

    <div style="margin-top:16px;">
      <div class="section-title">TSV (íƒ­ êµ¬ë¶„) â€” êµ¬ê¸€ ì‹œíŠ¸ì— ì§ì ‘ ë¶™ì—¬ë„£ê¸°</div>
      <div class="tsv-box" id="tsv-box"></div>
    </div>

    <div style="margin-top:12px;font-size:.78rem;color:#475569;">
      ğŸ’¡ ë³µì‚¬ í›„ Google Sheetsì˜ B3 ì…€ì„ í´ë¦­í•˜ê³  Ctrl+V(ë˜ëŠ” Cmd+V)ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. C, D, N ì—´ì€ ì§ì ‘ ì…€ ë³‘í•© ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<!-- â•â•â•â• ì¼ê´„ì²˜ë¦¬ íƒ­ â•â•â•â• -->
<div id="tab-bulk" class="tab-panel">
  <div class="card">
    <div style="text-align:center;padding:48px;color:#475569;">
      <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ”§</div>
      <div style="font-size:1rem;font-weight:600;color:#64748b;">ì¤€ë¹„ ì¤‘</div>
      <div style="font-size:.85rem;margin-top:8px;">ì¼ê´„ ì²˜ë¦¬ ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
// â”€â”€ íƒ­ ì „í™˜ â”€â”€
function switchAutoTab(tab) {
  document.querySelectorAll('.auto-tab').forEach((el,i) => {
    el.classList.toggle('active', ['reward','bulk'][i] === tab);
  });
  document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
}

function switchScenario(n) {
  document.getElementById('sc1-tab').classList.toggle('active', n===1);
  document.getElementById('sc2-tab').classList.toggle('active', n===2);
}

// â”€â”€ ì£¼ë¬¸ì„œ íŒŒì‹± â”€â”€
function parseOrder() {
  const text = document.getElementById('orderText').value;
  const get = (patterns) => {
    for (const p of patterns) {
      const m = text.match(p);
      if (m && m[1]) return m[1].trim();
    }
    return '';
  };

  const start   = get([/ì‹œì‘ì¼\s*[:ï¼š]\s*([0-9\-\/]+)/,/start\s*[:ï¼š]\s*([0-9\-\/]+)/i]);
  const end     = get([/ì¢…ë£Œì¼\s*[:ï¼š]\s*([0-9\-\/]+)/,/end\s*[:ï¼š]\s*([0-9\-\/]+)/i]);
  const kw      = get([/í‚¤ì›Œë“œ\s*[:ï¼š]\s*(.+)/,/keyword\s*[:ï¼š]\s*(.+)/i]);
  const url     = get([/ìƒí’ˆ\s*URL\s*[:ï¼š]\s*(https?:\/\/\S+)/i,/URL\s*[:ï¼š]\s*(https?:\/\/\S+)/i]);
  const name    = get([/ìƒí’ˆëª…\s*[:ï¼š]\s*(.+)/,/product\s*name\s*[:ï¼š]\s*(.+)/i]);
  const daily   = get([/ì¼ì¼\s*íŠ¸ë˜í”½\s*[:ï¼š]\s*(\d+)/,/ì¼ì¼\s*[:ï¼š]\s*(\d+)/]);
  const elapsed = get([/ê²½ê³¼\s*ì¼ìˆ˜\s*[:ï¼š]\s*(\d+)/,/ê²½ê³¼\s*[:ï¼š]\s*(\d+)/]);
  const total   = get([/ì´\s*íŠ¸ë˜í”½\s*[:ï¼š]\s*(\d+)/,/ì´\s*[:ï¼š]\s*(\d+)/]);

  if (start)   document.getElementById('f_start').value   = start;
  if (end)     document.getElementById('f_end').value     = end;
  if (kw)      document.getElementById('f_keyword').value = kw;
  if (url) {
    document.getElementById('f_url').value = url;
    extractFromUrl();
  }
  if (name)    document.getElementById('f_name').value    = name;
  if (daily)   document.getElementById('f_daily').value   = daily;
  if (elapsed) document.getElementById('f_elapsed').value = elapsed;
  if (total)   document.getElementById('f_total').value   = total;

  // íŒŒì‹± ê²°ê³¼ í‘œì‹œ
  const display = document.getElementById('parsed-display');
  const fields = {ì‹œì‘ì¼:start,ì¢…ë£Œì¼:end,í‚¤ì›Œë“œ:kw,'ìƒí’ˆURL':url?url.substring(0,40)+'...':'',ìƒí’ˆëª…:name,ì¼ì¼íŠ¸ë˜í”½:daily,ê²½ê³¼ì¼ìˆ˜:elapsed,ì´íŠ¸ë˜í”½:total};
  display.innerHTML = Object.entries(fields).filter(([k,v])=>v).map(([k,v])=>
    `<div class="pf-badge">${k}<span>${v}</span></div>`
  ).join('');
  display.style.display = 'flex';
}

// â”€â”€ URLì—ì„œ ìƒí’ˆë²ˆí˜¸/ì—…ì²´ëª… ì¶”ì¶œ â”€â”€
function extractFromUrl() {
  const url = document.getElementById('f_url').value.trim();
  if (!url) return;

  // ìƒí’ˆë²ˆí˜¸ ì¶”ì¶œ: /products/ìˆ«ì ë˜ëŠ” ?itemId=ìˆ«ì
  let pid = '';
  const m1 = url.match(/\/products\/(\d+)/);
  const m2 = url.match(/[?&]itemId=(\d+)/);
  const m3 = url.match(/catalog\/(\d+)/);
  if (m1) pid = m1[1];
  else if (m2) pid = m2[1];
  else if (m3) pid = m3[1];

  // ì—…ì²´ëª… ì¶”ì¶œ: smartstore.naver.com/ì—…ì²´ëª… ë˜ëŠ” storefarm
  let store = '';
  const ms = url.match(/smartstore\.naver\.com\/([^\/\?#]+)/);
  const mf = url.match(/storefarm\.naver\.com\/([^\/\?#]+)/);
  if (ms) store = ms[1];
  else if (mf) store = mf[1];

  if (pid) document.getElementById('f_pid').value = pid;
  if (store) document.getElementById('f_store').value = store;

  const hint = document.getElementById('url-extract-hint');
  hint.innerHTML = pid ? `âœ… ìƒí’ˆë²ˆí˜¸: <strong style="color:#03c75a">${pid}</strong>` + (store ? ` | ì—…ì²´: <strong style="color:#3b82f6">${store}</strong>` : '') : 'ìƒí’ˆë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
  hint.style.color = pid ? '#03c75a' : '#ef4444';

  updatePreview();
}

// â”€â”€ ìƒí’ˆëª… ë¸”ëŸ¬ ì²˜ë¦¬ â”€â”€
function blurWord(w) {
  if (w.length <= 1) return w;
  if (w.length === 2) return '*' + w[1];
  return w[0] + '*' + w.slice(2);
}

function blurProductName(name) {
  if (!name) return '';
  const words = name.split(/\s+/);
  return words.map((w, i) => i === 0 ? w : blurWord(w)).join(' ');
}

// â”€â”€ ìë™ ê³„ì‚° â”€â”€
document.getElementById('f_daily').addEventListener('input', autoCalc);
document.getElementById('f_elapsed').addEventListener('input', autoCalc);
function autoCalc() {
  const d = parseInt(document.getElementById('f_daily').value) || 0;
  const e = parseInt(document.getElementById('f_elapsed').value) || 0;
  if (d && e) document.getElementById('f_total').value = d * e;
}

// â”€â”€ ì‹œíŠ¸ ë°ì´í„° ìƒì„± â”€â”€
function generateSheet() {
  const start   = document.getElementById('f_start').value.trim();
  const end     = document.getElementById('f_end').value.trim();
  const keyword = document.getElementById('f_keyword').value.trim();
  const url     = document.getElementById('f_url').value.trim();
  const name    = document.getElementById('f_name').value.trim();
  const daily   = document.getElementById('f_daily').value.trim();
  const pid     = document.getElementById('f_pid').value.trim();
  const store   = document.getElementById('f_store').value.trim();
  const missionTpl = document.getElementById('f_mission').value;

  if (!start || !end) { alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if (!url)           { alert('ìƒí’ˆ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  // ë¯¸ì…˜ í…ìŠ¤íŠ¸ ì™„ì„±
  const blurred = blurProductName(name);
  const mission = missionTpl
    .replace(/\{keyword\}/g, keyword || 'í‚¤ì›Œë“œ')
    .replace(/\{blurred_name\}/g, blurred || name)
    .replace(/\{product_name\}/g, name);

  const pid3 = pid ? pid.substring(0, 3) : '';
  const pid5 = pid ? pid.substring(0, 5) : '';

  // 5í–‰ ë°ì´í„° êµ¬ì„±
  const rows = [];
  for (let i = 0; i < 5; i++) {
    rows.push({
      row:     3 + i,
      B:       'WEB',
      C:       i === 0 ? start : '',       // ë³‘í•©
      D:       i === 0 ? end : '',         // ë³‘í•©
      E:       '',                         // ìˆ˜ì‹ (ë¹„ì›€)
      F:       '',
      G:       '',
      H:       '',
      I:       pid3,
      J:       i === 0 ? mission : '',     // ì²« í–‰ë§Œ ë¯¸ì…˜
      K:       pid5,
      L:       url,
      M:       store,
      N:       i === 0 ? daily : '',       // ë³‘í•©
    });
  }

  // í…Œì´ë¸” ë Œë”ë§
  const tbody = document.getElementById('sheet-tbody');
  tbody.innerHTML = rows.map(r => {
    const isMergedTop = r.C !== '' || r.row === 3;
    return `<tr>
      <td class="row-num">${r.row}</td>
      <td class="col-web">${r.B}</td>
      <td class="${r.C ? 'merged-top' : 'merged-mid'}">${r.C || '(ë³‘í•©)'}</td>
      <td class="${r.D ? 'merged-top' : 'merged-mid'}">${r.D || '(ë³‘í•©)'}</td>
      <td class="col-formula">ìˆ˜ì‹</td>
      <td class="col-formula">ìˆ˜ì‹</td>
      <td class="col-formula">ìˆ˜ì‹</td>
      <td class="col-formula">ìˆ˜ì‹</td>
      <td class="col-keyword">${r.I}</td>
      <td class="editable" contenteditable="true" style="max-width:250px;white-space:normal;word-break:break-all;">${r.J}</td>
      <td>${r.K}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;"><a href="${r.L}" target="_blank" style="color:#3b82f6;">${r.L.substring(0,35)}...</a></td>
      <td>${r.M}</td>
      <td class="${r.N ? 'merged-top' : 'merged-mid'}">${r.N || '(ë³‘í•©)'}</td>
    </tr>`;
  }).join('');

  // TSV ìƒì„± (E~HëŠ” ê³µë°±, êµ¬ê¸€ ì‹œíŠ¸ ìˆ˜ì‹ì€ ìˆ˜ë™ ì…ë ¥)
  const tsv = rows.map(r => [r.B, r.C, r.D, '', '', '', '', r.I, r.J, r.K, r.L, r.M, r.N].join('\t')).join('\n');
  document.getElementById('tsv-box').textContent = tsv;

  // ê²°ê³¼ í‘œì‹œ
  document.getElementById('result-section').style.display = 'block';
  document.getElementById('result-section').scrollIntoView({behavior:'smooth',block:'start'});
}

// â”€â”€ TSV ë³µì‚¬ â”€â”€
function copyTSV() {
  const tsv = document.getElementById('tsv-box').textContent;
  navigator.clipboard.writeText(tsv).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'âœ… ë³µì‚¬ë¨!';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.innerHTML = 'ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬ (êµ¬ê¸€ ì‹œíŠ¸ìš©)';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(() => {
    // fallback
    const el = document.createElement('textarea');
    el.value = tsv;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
}

// â”€â”€ ì „ì²´ ì´ˆê¸°í™” â”€â”€
function clearAll() {
  ['f_start','f_end','f_keyword','f_url','f_name','f_daily','f_elapsed','f_total','f_pid','f_store']
    .forEach(id => document.getElementById(id).value = '');
  document.getElementById('orderText').value = '';
  document.getElementById('parsed-display').style.display = 'none';
  document.getElementById('result-section').style.display = 'none';
  document.getElementById('url-extract-hint').textContent = 'URL ì…ë ¥ ì‹œ ìƒí’ˆë²ˆí˜¸/ì—…ì²´ëª… ìë™ ì¶”ì¶œ';
  document.getElementById('url-extract-hint').style.color = '';
}

// â”€â”€ í”„ë¦¬ë·° ìë™ ì—…ë°ì´íŠ¸ â”€â”€
function updatePreview() {}
</script>
{% endblock %}
