{% extends "base.html" %}
{% block title %}ì—…ë¬´ ìë™í™”{% endblock %}

{% block extra_style %}
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.auto-tabs{display:flex;gap:0;border-bottom:2px solid #334155;margin-bottom:16px;}
.auto-tab{padding:8px 18px;cursor:pointer;font-size:.82rem;font-weight:600;color:#64748b;
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:.15s;}
.auto-tab.active{color:#03c75a;border-bottom-color:#03c75a;}
.auto-tab:hover:not(.active){color:#e2e8f0;background:#1e2433;border-radius:6px 6px 0 0;}
.tab-panel{display:none;}.tab-panel.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íŒ¨ë„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:#161d2e;border:1px solid #1e293b;border-radius:10px;padding:14px;margin-bottom:12px;}
.panel-title{font-size:.7rem;font-weight:700;color:#475569;text-transform:uppercase;
  letter-spacing:.06em;margin-bottom:10px;display:flex;align-items:center;gap:7px;}
.panel-title::before{content:'';display:inline-block;width:3px;height:11px;background:#03c75a;border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì…ë ¥ í•„ë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.f-grid{display:grid;gap:8px;margin-bottom:8px;}
.f-grid-2{grid-template-columns:1fr 1fr;}
.f-grid-3{grid-template-columns:repeat(3,1fr);}
.f-group label{font-size:.7rem;color:#64748b;margin-bottom:3px;display:block;font-weight:600;}
.f-group input,.f-group select,.f-group textarea{
  width:100%;background:#0d1220 !important;border:1px solid #253048 !important;
  color:#e2e8f0 !important;padding:6px 9px;border-radius:6px;font-size:.78rem;transition:.15s;
  -webkit-appearance:none;-moz-appearance:none;appearance:none;box-shadow:none !important;}
.f-group input::placeholder,.f-group textarea::placeholder{color:#475569 !important;}
.f-group input:focus,.f-group select:focus,.f-group textarea:focus{
  border-color:#03c75a !important;outline:none !important;box-shadow:0 0 0 2px #03c75a18 !important;}
input[type=number]{background:#0d1220 !important;color:#e2e8f0 !important;border:1px solid #253048 !important;}
.f-hint{font-size:.65rem;color:#334155;margin-top:3px;}
.f-hint.ok{color:#03c75a;}.f-hint.warn{color:#f59e0b;}.f-hint.err{color:#ef4444;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°œì£¼ ë¶™ì—¬ë„£ê¸°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.order-paste-area{
  width:100%;min-height:70px;max-height:140px;resize:vertical;overflow:auto;
  background:#0d1220 !important;border:1.5px dashed #253048 !important;
  color:#94a3b8 !important;padding:9px;border-radius:8px;
  font-size:.75rem;line-height:1.6;font-family:'Courier New',monospace;}
.order-paste-area:focus{border-color:#03c75a !important;outline:none;}
.col-map{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.col-badge{background:#0d1220;border:1px solid #253048;border-radius:4px;
  padding:2px 8px;font-size:.65rem;color:#64748b;}
.col-badge strong{color:#03c75a;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°œì£¼ ë°ì´í„° í…Œì´ë¸”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.order-table-wrap{overflow-x:auto;border-radius:8px;border:1px solid #1e293b;margin-top:8px;}
.order-table{border-collapse:collapse;width:100%;min-width:800px;font-size:.7rem;}
.order-table th{background:#111827;color:#64748b;padding:5px 7px;
  border-bottom:1px solid #1e293b;text-align:left;font-size:.62rem;font-weight:600;white-space:nowrap;}
.order-table td{padding:3px 5px;border-bottom:1px solid #111827;color:#94a3b8;vertical-align:middle;background:#0d1220;}
.order-table tr:last-child td{border-bottom:none;}
.order-table tr:hover td{background:#111827;}
.order-table td input{background:#0d1220 !important;border:1px solid transparent !important;
  color:#e2e8f0 !important;font-size:.7rem;width:100%;padding:2px 4px;min-width:50px;border-radius:3px;}
.order-table td input:focus{background:#0d1624 !important;border:1px solid #03c75a44 !important;
  outline:none !important;color:#e2e8f0 !important;}
.order-table td input::placeholder{color:#334155 !important;}
.order-chk{width:13px;height:13px;cursor:pointer;accent-color:#03c75a;}
.btn-row-del{background:none;border:none;color:#334155;cursor:pointer;font-size:.78rem;padding:1px 4px;}
.btn-row-del:hover{color:#ef4444;}
.store-spinner{width:8px;height:8px;border:1.5px solid #03c75a44;border-top-color:#03c75a;
  border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìˆœìœ„ ì²´í¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rank-result-wrap{margin-top:8px;}
.rank-item{display:flex;align-items:center;gap:8px;padding:4px 8px;border-radius:5px;
  background:#0d1220;border:1px solid #1e293b;margin-bottom:4px;font-size:.72rem;}
.rank-badge{min-width:32px;text-align:center;font-weight:700;border-radius:3px;padding:1px 5px;font-size:.68rem;}
.rank-ok{background:#064e3b;color:#03c75a;}
.rank-warn{background:#431407;color:#f97316;}
.rank-fail{background:#450a0a;color:#ef4444;}
.rank-pending{background:#1e293b;color:#94a3b8;}
.rank-kw{color:#e2e8f0;flex:1;}
.rank-note{color:#64748b;font-size:.65rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ â€” ì „ì²´ í™”ë©´ ë§ì¶¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-wrap{
  overflow:auto;border:1px solid #1e293b;border-radius:10px;
  max-height:520px;position:relative;user-select:none;
  width:100%;
}
.isheet{
  border-collapse:collapse;
  font-size:.62rem;
  width:100%;
  table-layout:fixed;
}
.isheet th{
  position:sticky;top:0;z-index:10;
  background:#0d1220;color:#475569;padding:4px 3px;
  border:1px solid #1e293b;font-size:.6rem;font-weight:600;
  white-space:nowrap;text-align:center;overflow:hidden;
}
.isheet th.row-hd{position:sticky;left:0;top:0;z-index:20;background:#0a0e1a;width:24px;}
.isheet td{
  padding:3px 4px;border:1px solid #1a2540;
  vertical-align:middle;cursor:cell;overflow:hidden;
  white-space:pre-wrap;word-break:break-all;
}
.isheet td.row-num{
  position:sticky;left:0;z-index:5;background:#0a0e1a;
  color:#334155;font-size:.6rem;text-align:center;
  border-right:2px solid #1e293b;min-width:24px;max-width:24px;
}
.isheet td.selected{background:#0c2340 !important;}
.isheet td.merged{background:#0d1220;}

/* ì—´ë³„ ìƒ‰ìƒ */
.isheet .c-type{background:#111827;color:#64748b;text-align:center;}
.isheet .c-web{background:#0d1220;color:#f59e0b;font-weight:700;text-align:center;}
.isheet .c-date{background:#0d1a0d;color:#03c75a;font-weight:700;text-align:center;}
.isheet .c-formula{background:#0a0e18;color:#253048;}
.isheet .c-pts{background:#0a0e18;color:#253048;text-align:center;}
.isheet .c-kw{background:#0d1220;color:#3b82f6;font-weight:700;text-align:center;}
.isheet .c-mission{background:#0f172a;color:#e2e8f0;font-size:.6rem;}
.isheet .c-pid{background:#0d1220;color:#94a3b8;}
.isheet .c-url{background:#0d1220;color:#3b82f6;font-size:.58rem;}
.isheet .c-store{background:#0d1220;color:#a78bfa;font-weight:700;}
.isheet .c-qty{background:#0d1a0d;color:#03c75a;font-weight:700;text-align:center;}

/* ìº í˜ì¸ êµ¬ë¶„ì„  */
.isheet tr.camp-start td{border-top:3px solid #03c75a !important;}
.isheet tr.camp-first td{border-top:1px solid #1a2540;}

/* ì—´ ë„ˆë¹„ â€” 15ì—´ (row-num + A~O) */
.isheet .w-A{width:3.5%;}
.isheet .w-B{width:3.5%;}
.isheet .w-C{width:6%;}
.isheet .w-D{width:6%;}
.isheet .w-E{width:4.5%;}
.isheet .w-F{width:4.5%;}
.isheet .w-G{width:4.5%;}
.isheet .w-H{width:4%;}
.isheet .w-I{width:6%;}
.isheet .w-J{width:22%;}
.isheet .w-K{width:6%;}
.isheet .w-L{width:16%;}
.isheet .w-M{width:7%;}
.isheet .w-N{width:5%;}
.isheet .w-O{width:4.5%;}

/* cell-inner */
.cell-inner{overflow:hidden;max-height:100%;word-break:break-all;}
.cell-inner[contenteditable]:focus{outline:1px solid #03c75a44;border-radius:2px;}

/* ìº í˜ì¸ íƒ­ */
.camp-tabs-bar{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
.camp-tab{padding:3px 10px;background:#111827;border:1px solid #1e293b;border-radius:4px;
  cursor:pointer;font-size:.68rem;color:#64748b;transition:.1s;}
.camp-tab.active{background:#0d2d1a;border-color:#03c75a;color:#03c75a;}
.camp-tab:hover{color:#e2e8f0;}

/* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
.dl-btns{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;align-items:center;}
.btn-dl{padding:7px 14px;border:none;border-radius:6px;cursor:pointer;
  font-size:.75rem;font-weight:600;transition:.15s;white-space:nowrap;}
.btn-dl-green{background:#03c75a;color:#000;}
.btn-dl-green:hover{background:#02a84c;}
.btn-dl-xlsx{background:#0ea5e9;color:#fff;}
.btn-dl-xlsx:hover{background:#0284c7;}
.btn-dl-fill{background:#7c3aed;color:#fff;}
.btn-dl-fill:hover{background:#6d28d9;}
.btn-dl-gray{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.btn-dl-gray:hover{background:#253048;color:#e2e8f0;}
.btn-dl:disabled{opacity:.5;cursor:not-allowed;}

/* ë„êµ¬ë°” */
.sheet-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;}
.sel-info{font-size:.65rem;color:#475569;margin-left:auto;}

/* ë²„íŠ¼ ê³µí†µ */
.btn{padding:7px 14px;border:none;border-radius:7px;cursor:pointer;font-size:.78rem;font-weight:600;transition:.15s;}
.btn-primary{background:#03c75a;color:#000;}
.btn-primary:hover{background:#02a84c;}
.btn-secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.btn-secondary:hover{background:#253048;color:#e2e8f0;}
.btn-sm{padding:4px 10px;font-size:.68rem;}
.btn-danger{background:#450a0a;color:#ef4444;border:1px solid #7f1d1d;}
.btn-danger:hover{background:#7f1d1d;}
.btn-rank{background:#1e3a5f;color:#60a5fa;border:1px solid #1e40af;}
.btn-rank:hover{background:#1e40af;color:#fff;}

/* ì •ë³´ ë°” */
.info-bar{background:#0d1a2d;border:1px solid #1e3a5f;border-radius:6px;
  padding:7px 12px;font-size:.72rem;color:#60a5fa;margin-bottom:8px;}
.info-bar.warn{background:#1c1407;border-color:#92400e;color:#f59e0b;}
.info-bar.err{background:#1a0a0a;border-color:#7f1d1d;color:#ef4444;}
.info-bar.ok{background:#052e16;border-color:#166534;color:#03c75a;}

/* ë¯¸ì…˜ í…œí”Œë¦¿ */
.mission-tpl-wrap textarea{
  width:100%;background:#0d1220 !important;border:1px solid #253048 !important;
  color:#e2e8f0 !important;padding:8px;border-radius:6px;font-size:.75rem;
  font-family:'Courier New',monospace;min-height:70px;resize:vertical;}
.mission-tpl-wrap textarea:focus{border-color:#03c75a !important;outline:none !important;}
.tpl-hint{font-size:.65rem;color:#475569;margin-top:4px;}

/* ì—…ë¡œë“œ ì¡´ */
.upload-zone{border:1.5px dashed #253048;border-radius:8px;padding:14px;text-align:center;
  cursor:pointer;background:#0d1220;transition:.15s;}
.upload-zone:hover,.upload-zone.drag{border-color:#03c75a;background:#052e16;}
.upload-zone input{display:none;}
.upload-icon{font-size:1.4rem;margin-bottom:5px;}
.upload-text{font-size:.72rem;color:#64748b;}
.upload-file-name{font-size:.68rem;color:#03c75a;margin-top:4px;font-weight:600;}
</style>
{% endblock %}

{% block content %}
<div style="max-width:100%;padding:0 2px;">
  <div style="margin-bottom:14px;">
    <h2 style="font-size:1.05rem;font-weight:700;color:#e2e8f0;margin:0 0 3px;">ğŸ“Š ì—…ë¬´ ìë™í™”</h2>
    <div style="font-size:.72rem;color:#475569;">ë°œì£¼ ë°ì´í„° â†’ ìº í˜ì¸ ì‹œíŠ¸ ìë™ ìƒì„± Â· ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</div>
  </div>

  <!-- íƒ­ -->
  <div class="auto-tabs">
    <div class="auto-tab active" onclick="switchTab('reward')">ğŸ› ë„¤ì´ë²„ ì‡¼í•‘ (ê°€ê²©ë¹„êµ)</div>
    <div class="auto-tab" onclick="switchTab('place')">ğŸ“ í”Œë ˆì´ìŠ¤ (ëª…ì†Œ)</div>
    <div class="auto-tab" onclick="switchTab('bulk')">ì¼ê´„ì²˜ë¦¬</div>
  </div>

  <!-- â•â•â•â•â•â• ë¦¬ì›Œë“œ íƒ­ â•â•â•â•â•â• -->
  <div id="tab-reward" class="tab-panel active">

    <!-- STEP 1: ë°œì£¼ ì…ë ¥ -->
    <div class="panel">
      <div class="panel-title">â‘  ë°œì£¼ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
      <div class="info-bar" style="margin-bottom:8px;">
        ì—‘ì…€ì—ì„œ í–‰ ë³µì‚¬ í›„ ë¶™ì—¬ë„£ê¸°. í‚¤ì›Œë“œëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥ (ë¶€ì¡± ì‹œ ìˆœí™˜ ë³µì œ).
      </div>
      <textarea id="orderPaste" class="order-paste-area"
        placeholder="ì‹œì‘ì¼&#9;ì¢…ë£Œì¼&#9;í‚¤ì›Œë“œ1,í‚¤ì›Œë“œ2,í‚¤ì›Œë“œ3&#9;ìƒí’ˆURL&#9;ìƒí’ˆëª…&#9;ì¼ìœ ì…&#9;ê²½ê³¼ì¼&#9;ëˆ„ì ìœ ì…
2025-02-24&#9;2025-02-28&#9;ì¥ë‡Œì‚¼,ì‚°ì‚¼,ì‚°ì–‘ì‚¼&#9;https://smartstore.naver.com/minkukss/products/5835104592&#9;ë„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼&#9;300&#9;5&#9;1500"></textarea>
      <div class="col-map">
        <span class="col-badge"><strong>1</strong> ì‹œì‘ì¼</span>
        <span class="col-badge"><strong>2</strong> ì¢…ë£Œì¼</span>
        <span class="col-badge"><strong>3</strong> í‚¤ì›Œë“œ(,êµ¬ë¶„)</span>
        <span class="col-badge"><strong>4</strong> ìƒí’ˆURL</span>
        <span class="col-badge"><strong>5</strong> ìƒí’ˆëª…</span>
        <span class="col-badge"><strong>6</strong> ì¼ìœ ì…</span>
        <span class="col-badge"><strong>7</strong> ê²½ê³¼ì¼</span>
        <span class="col-badge"><strong>8</strong> ëˆ„ì ìœ ì…</span>
      </div>
      <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="parsePaste()">ğŸ“‹ íŒŒì‹±í•˜ê¸°</button>
        <button class="btn btn-secondary btn-sm" onclick="addEmptyRow()">â• ë¹ˆ í–‰ ì¶”ê°€</button>
        <button class="btn btn-secondary btn-sm" onclick="loadDemoData()">ğŸ§ª ë°ëª¨ ë°ì´í„°</button>
        <button class="btn btn-danger btn-sm" onclick="clearOrders()">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- STEP 2: ë°œì£¼ í™•ì¸ í…Œì´ë¸” -->
    <div id="orderTablePanel" style="display:none;" class="panel">
      <div class="panel-title" style="justify-content:space-between;">
        <span>â‘¡ ë°œì£¼ í™•ì¸ <span id="rowCountBadge" style="color:#03c75a;font-weight:700;"></span></span>
        <button class="btn btn-rank btn-sm" onclick="checkAllRanks()">ğŸ” ìˆœìœ„ ì¼ê´„ í™•ì¸</button>
      </div>
      <div id="rankResultWrap" class="rank-result-wrap" style="display:none;"></div>
      <div class="order-table-wrap">
        <table class="order-table">
          <thead>
            <tr>
              <th><input type="checkbox" class="order-chk" onclick="toggleAllChk(this)"></th>
              <th>#</th><th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th>
              <th>í‚¤ì›Œë“œ ëª©ë¡</th>
              <th>ìƒí’ˆURL</th><th>ìƒí’ˆëª…</th>
              <th>ì—…ì²´ëª…(M)</th>
              <th>ì¼ìœ ì…</th><th>ê²½ê³¼ì¼</th><th>ëˆ„ì </th><th></th>
            </tr>
          </thead>
          <tbody id="orderTbody"></tbody>
        </table>
      </div>

      <!-- ë¯¸ì…˜ í…œí”Œë¦¿ -->
      <div style="margin-top:12px;">
        <div class="panel-title">ë¯¸ì…˜ë‚´ìš© í…œí”Œë¦¿</div>
        <div class="mission-tpl-wrap">
          <textarea id="missionTpl">ë„¤ì´ë²„ì—ì„œ [{keyword}]ë¡œ ê²€ìƒ‰í•˜ì‹  í›„, {blurred_name} ìƒí’ˆì„ ì°¾ì•„ êµ¬ë§¤í•˜ê³  ì •ë‹µë€ì— ì£¼ë¬¸ë²ˆí˜¸ ì• 5ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. íŒë§¤ì²˜: {store_name}</textarea>
          <div class="tpl-hint">ë³€ìˆ˜: {keyword} í•´ë‹¹ í–‰ í‚¤ì›Œë“œ Â· {blurred_name} ë¸”ëŸ¬ ì²˜ë¦¬ëœ ìƒí’ˆëª… Â· {store_name} ì—…ì²´ëª…</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button class="btn btn-primary" onclick="generateAll()" style="width:100%;font-size:.82rem;padding:9px;">
          âš¡ ìº í˜ì¸ ì‹œíŠ¸ ìƒì„±
        </button>
      </div>
    </div>

    <!-- STEP 3: ì‹œíŠ¸ ê²°ê³¼ -->
    <div id="resultPanel" style="display:none;" class="panel">
      <div class="panel-title">â‘¢ ìƒì„±ëœ ìº í˜ì¸ ì‹œíŠ¸</div>

      <div class="sheet-toolbar">
        <button class="btn btn-secondary btn-sm" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">ì„ íƒ í•´ì œ</button>
        <span id="selInfo" class="sel-info"></span>
      </div>

      <div class="camp-tabs-bar" id="campaignTabs"></div>

      <div class="sheet-wrap">
        <table class="isheet" id="isheet">
          <colgroup>
            <col class="row-hd">
            <col class="w-A"><col class="w-B"><col class="w-C"><col class="w-D">
            <col class="w-E"><col class="w-F"><col class="w-G"><col class="w-H">
            <col class="w-I"><col class="w-J"><col class="w-K"><col class="w-L">
            <col class="w-M"><col class="w-N"><col class="w-O">
          </colgroup>
          <thead>
            <tr>
              <th class="row-hd">#</th>
              <th class="w-A">A<br><span style="font-size:.52rem;color:#64748b;">êµ¬ë¶„</span></th>
              <th class="w-B">B<br><span style="font-size:.52rem;color:#f59e0b;">WEB/APP</span></th>
              <th class="w-C">C<br><span style="font-size:.52rem;color:#03c75a;">ì‹œì‘ì¼</span></th>
              <th class="w-D">D<br><span style="font-size:.52rem;color:#03c75a;">ì¢…ë£Œì¼</span></th>
              <th class="w-E">E<br><span style="font-size:.52rem;color:#1e3a5f;">ì´ì˜ˆì‚°</span></th>
              <th class="w-F">F<br><span style="font-size:.52rem;color:#1e3a5f;">ì´ì˜ˆì‚°â†‘</span></th>
              <th class="w-G">G<br><span style="font-size:.52rem;color:#1e3a5f;">ì¼ì˜ˆì‚°</span></th>
              <th class="w-H">H<br><span style="font-size:.52rem;color:#1e3a5f;">í¬ì¸íŠ¸</span></th>
              <th class="w-I">I<br><span style="font-size:.52rem;color:#3b82f6;">ê²€ìƒ‰ì–´</span></th>
              <th class="w-J">J<br><span style="font-size:.52rem;color:#e2e8f0;">ë¯¸ì…˜ë‚´ìš©</span></th>
              <th class="w-K">K<br><span style="font-size:.52rem;color:#94a3b8;">ì •ë‹µ</span></th>
              <th class="w-L">L<br><span style="font-size:.52rem;color:#3b82f6;">íŒíŠ¸URL</span></th>
              <th class="w-M">M<br><span style="font-size:.52rem;color:#a78bfa;">ì—…ì²´ëª…</span></th>
              <th class="w-N">N<br><span style="font-size:.52rem;color:#03c75a;">ì¼ìœ ì…</span></th>
              <th class="w-O">O<br><span style="font-size:.52rem;color:#1e3a5f;">ê¸€ììˆ˜</span></th>
            </tr>
          </thead>
          <tbody id="isheetBody"></tbody>
        </table>
      </div>

      <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
      <div class="dl-btns">
        <button class="btn-dl btn-dl-green" onclick="copySelected()">ğŸ“‹ ì„ íƒ ë³µì‚¬</button>
        <button class="btn-dl btn-dl-xlsx" id="btnXlsx" onclick="downloadXlsx()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ìƒìš©)</button>
        <button class="btn-dl btn-dl-fill" id="btnFill" onclick="fillTemplate()">â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn-dl btn-dl-gray" onclick="copyAllTSV()">ğŸ“„ TSV ë³µì‚¬</button>
      </div>
      <div style="font-size:.65rem;color:#475569;margin-top:5px;">
        â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ = í…œí”Œë¦¿ì— ë°ì´í„° ì‚½ì… Â· ğŸ“¥ ë¹„ìƒìš© = ìƒˆ xlsx íŒŒì¼ ìƒì„±
      </div>
    </div>


  </div><!-- /tab-reward -->

  <!-- â•â•â•â•â•â• í”Œë ˆì´ìŠ¤ íƒ­ â•â•â•â•â•â• -->
  <div id="tab-place" class="tab-panel">

    <!-- STEP 1: ë°œì£¼ ë¶™ì—¬ë„£ê¸° -->
    <div class="panel">
      <div class="panel-title">â‘  ë°œì£¼ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
      <div style="font-size:.68rem;color:#64748b;margin-bottom:6px;">
        ë°œì£¼ ì—‘ì…€ì—ì„œ í–‰ì„ ë³µì‚¬(Ctrl+C) í›„ ë¶™ì—¬ë„£ê¸° (Ctrl+V)<br>
        ì»¬ëŸ¼ ìˆœì„œ: <span class="col-badge"><strong>1</strong> ì‹œì‘ì¼</span>
        <span class="col-badge"><strong>2</strong> ì¢…ë£Œì¼</span>
        <span class="col-badge"><strong>3</strong> í‚¤ì›Œë“œ</span>
        <span class="col-badge"><strong>4</strong> í”Œë ˆì´ìŠ¤URL</span>
        <span class="col-badge"><strong>5</strong> í”Œë ˆì´ìŠ¤ëª…</span>
        <span class="col-badge"><strong>6</strong> ì¼ìœ ì…</span>
      </div>
      <textarea id="placeOrderPaste" class="order-paste-area" rows="3"
        placeholder="ë°œì£¼ ì—‘ì…€ì—ì„œ ë³µì‚¬ í›„ Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸°&#10;(íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ í–‰)"></textarea>
      <div style="margin-top:8px;display:flex;gap:6px;align-items:center;">
        <button class="btn btn-primary btn-sm" onclick="parsePlacePaste()">ğŸ“‹ íŒŒì‹±í•˜ê¸°</button>
        <button class="btn btn-secondary btn-sm" onclick="loadPlaceDemo()">ğŸ” ì˜ˆì‹œ ë°ì´í„°</button>
        <span id="placeRowCountBadge" style="font-size:.68rem;color:#64748b;"></span>
      </div>
    </div>

    <!-- STEP 2: ë°œì£¼ í™•ì¸ í…Œì´ë¸” -->
    <div id="placeOrderTablePanel" style="display:none;" class="panel">
      <div class="panel-title" style="justify-content:space-between;">
        <span>â‘¡ ë°œì£¼ í™•ì¸ Â· ìˆœìœ„ ì²´í¬</span>
        <button class="btn btn-secondary btn-sm" onclick="clearPlaceOrders()">ğŸ—‘ ì´ˆê¸°í™”</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="order-table" id="placeOrderTable">
          <thead><tr>
            <th><input type="checkbox" id="placeChkAll" onchange="placeToggleAll(this)"></th>
            <th>#</th>
            <th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th>í‚¤ì›Œë“œ</th>
            <th>í”Œë ˆì´ìŠ¤URL</th><th>í”Œë ˆì´ìŠ¤ëª… <small>(ìë™)</small></th>
            <th>ì¼ìœ ì…</th><th>ìˆœìœ„</th>
          </tr></thead>
          <tbody id="placeOrderTbody"></tbody>
        </table>
      </div>

      <!-- ëª…ì†Œëª… ì…ë ¥ -->
      <div style="margin-top:12px;background:#0d1525;border:1px solid #1e293b;border-radius:8px;padding:12px;">
        <div style="font-size:.7rem;color:#03c75a;font-weight:700;margin-bottom:6px;">ğŸ› ì •ë‹µ ëª…ì†Œëª… ì…ë ¥</div>
        <div style="font-size:.65rem;color:#64748b;margin-bottom:8px;">
          í”Œë ˆì´ìŠ¤ì˜ <strong style="color:#e2e8f0;">ì£¼ë³€ íƒ­ â†’ ëª…ì†Œ íƒ­</strong>ì—ì„œ 15ë²ˆì§¸ ëª…ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.<br>
          â€» ë„ì–´ì“°ê¸° ì—†ì´ ë¶™ì—¬ì„œ ì…ë ¥ (ì˜ˆ: <code style="color:#f59e0b;">ì°½ì›í–¥êµ</code>)
        </div>
        <input type="text" id="placeSpotAnswer" placeholder="ëª…ì†Œëª… ì…ë ¥ (ì˜ˆ: ì°½ì›í–¥êµ)"
          style="width:100%;background:#0a0f1a;border:1px solid #1e3a5f;color:#e2e8f0;
                 border-radius:6px;padding:7px 10px;font-size:.8rem;box-sizing:border-box;">
        <div id="placeSpotPreview" style="font-size:.65rem;color:#94a3b8;margin-top:5px;"></div>
      </div>

      <!-- ë¯¸ì…˜ í…œí”Œë¦¿ -->
      <div style="margin-top:12px;">
        <div class="panel-title">ë¯¸ì…˜ë‚´ìš© í…œí”Œë¦¿</div>
        <div class="mission-tpl-wrap">
          <textarea id="placeMissionTpl" rows="14">ë¯¸ì…˜ ìˆ˜í–‰í•˜ë©°,
ë¦¬ì›Œë“œ ì¦‰ì‹œ ì ë¦½ ë°›ìœ¼ì„¸ìš”!

1. í•˜ë‹¨ [ê²€ìƒ‰ì–´ ë³µì‚¬í•˜ê¸°] ë²„íŠ¼ì„ í´ë¦­ í•˜ê³ , í‚¤ì›Œë“œë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”.
2. íŒíŠ¸ë³´ëŸ¬ê°€ê¸° ë²„íŠ¼ í´ë¦­ í›„ ë„¤ì´ë²„ ì•±ì— ì ‘ì†í•´ì£¼ì„¸ìš”.
3. ë³µì‚¬ëœ í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰ ì°½ì— ë¶™ì—¬ë„£ê³  ê²€ìƒ‰í•´ì£¼ì„¸ìš”.
4.[*{blurred_name}]í”Œë ˆì´ìŠ¤ë¥¼ ë°©ë¬¸ í•˜ê³  [ ì£¼ë³€ ] íƒ­ì„ í´ë¦­ í•´ì£¼ì„¸ìš”.
â€» ë³µì‚¬ëœ í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹œ, í•´ë‹¹ í”Œë ˆì´ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° ì•„ë˜ 'í¼ì³ì„œ ë”ë³´ê¸°' í´ë¦­í•˜ì—¬ ì°¾ì•„ì£¼ì„¸ìš”.
5. [ ì£¼ë³€ ] íƒ­ì„ í´ë¦­ í›„ ë°”ë¡œ ì•„ë˜ [ ëª…ì†Œ ] íƒ­ì„ í´ë¦­ í•´ì£¼ì„¸ìš”.
6. [ ì´ˆì„±íŒíŠ¸ ]ë¥¼ ë³´ê³  [ ëª…ì†Œ ] íƒ­ì—ì„œ ì •ë‹µì„ ì°¾ì•„ì£¼ì„¸ìš”.

*í•´ë‹¹íƒ­ì´ ì‚¬ë¼ì§€ë©´ [ ëª…ì†Œ ]íƒ­ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
7. ì´ˆì„±íŒíŠ¸ : {{chosung}}
ì •ë‹µ : <{answer_len}> ê¸€ì
* ì •ë‹µë€ì— ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥ í›„ ì œì¶œí•´ì£¼ì„¸ìš”.</textarea>
          <div class="tpl-hint">ë³€ìˆ˜: {blurred_name} ì•ê¸€ì ë¸”ëŸ¬ì²˜ë¦¬ ì—…ì²´ëª… Â· {chosung} ì´ˆì„±íŒíŠ¸ ìë™ìƒì„± Â· {answer_len} ê¸€ììˆ˜ ìë™ê³„ì‚°</div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button class="btn btn-primary" onclick="generatePlaceAll()" style="width:100%;font-size:.82rem;padding:9px;">
          âš¡ í”Œë ˆì´ìŠ¤ ìº í˜ì¸ ì‹œíŠ¸ ìƒì„±
        </button>
      </div>
    </div>

    <!-- STEP 3: ì‹œíŠ¸ ê²°ê³¼ -->
    <div id="placeResultPanel" style="display:none;" class="panel">
      <div class="panel-title">â‘¢ ìƒì„±ëœ í”Œë ˆì´ìŠ¤ ìº í˜ì¸ ì‹œíŠ¸</div>

      <div class="sheet-toolbar">
        <button class="btn btn-secondary btn-sm" onclick="selectAllPlace()">ì „ì²´ ì„ íƒ</button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelectionPlace()">ì„ íƒ í•´ì œ</button>
        <span id="placeSelInfo" class="sel-info"></span>
      </div>

      <div class="camp-tabs-bar" id="placeCampaignTabs"></div>

      <div class="sheet-wrap">
        <table class="isheet" id="placeSheet">
          <colgroup>
            <col class="row-hd">
            <col class="w-A"><col class="w-B"><col class="w-C"><col class="w-D">
            <col class="w-E"><col class="w-F"><col class="w-G"><col class="w-H">
            <col class="w-I"><col class="w-J"><col class="w-K"><col class="w-L">
            <col class="w-M"><col class="w-N"><col class="w-O">
          </colgroup>
          <thead>
            <tr>
              <th class="row-hd">#</th>
              <th class="w-A">A<br><span style="font-size:.52rem;color:#64748b;">êµ¬ë¶„</span></th>
              <th class="w-B">B<br><span style="font-size:.52rem;color:#f97316;">APP</span></th>
              <th class="w-C">C<br><span style="font-size:.52rem;color:#03c75a;">ì‹œì‘ì¼</span></th>
              <th class="w-D">D<br><span style="font-size:.52rem;color:#03c75a;">ì¢…ë£Œì¼</span></th>
              <th class="w-E">E<br><span style="font-size:.52rem;color:#1e3a5f;">ì´ì˜ˆì‚°</span></th>
              <th class="w-F">F<br><span style="font-size:.52rem;color:#1e3a5f;">ì´ì˜ˆì‚°â†‘</span></th>
              <th class="w-G">G<br><span style="font-size:.52rem;color:#1e3a5f;">ì¼ì˜ˆì‚°</span></th>
              <th class="w-H">H<br><span style="font-size:.52rem;color:#1e3a5f;">í¬ì¸íŠ¸</span></th>
              <th class="w-I">I<br><span style="font-size:.52rem;color:#3b82f6;">ê²€ìƒ‰ì–´</span></th>
              <th class="w-J">J<br><span style="font-size:.52rem;color:#e2e8f0;">ë¯¸ì…˜ë‚´ìš©</span></th>
              <th class="w-K">K<br><span style="font-size:.52rem;color:#fbbf24;">ì •ë‹µ(ëª…ì†Œ)</span></th>
              <th class="w-L">L<br><span style="font-size:.52rem;color:#f97316;">ì•±ëœë”©</span></th>
              <th class="w-M">M<br><span style="font-size:.52rem;color:#a78bfa;">ì—…ì²´ëª…</span></th>
              <th class="w-N">N<br><span style="font-size:.52rem;color:#03c75a;">ì¼ìœ ì…</span></th>
              <th class="w-O">O<br><span style="font-size:.52rem;color:#1e3a5f;">ê¸€ììˆ˜</span></th>
            </tr>
          </thead>
          <tbody id="placeSheetBody"></tbody>
        </table>
      </div>

      <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ - ë©”ì¸ ë²„íŠ¼ í¬ê²Œ -->
      <div style="margin-top:12px;">
        <button id="btnPlaceFill" onclick="fillPlaceTemplate()"
          style="width:100%;padding:12px;font-size:.9rem;font-weight:700;
                 background:linear-gradient(135deg,#03c75a,#059c46);color:#fff;
                 border:none;border-radius:8px;cursor:pointer;letter-spacing:.03em;">
          â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
      <div class="dl-btns" style="margin-top:8px;">
        <button class="btn-dl btn-dl-green" onclick="copySelectedPlace()">ğŸ“‹ ì„ íƒ ë³µì‚¬</button>
        <button class="btn-dl btn-dl-xlsx" id="btnPlaceXlsx" onclick="downloadPlaceXlsx()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ìƒìš©)</button>
        <button class="btn-dl btn-dl-gray" onclick="copyPlaceTSV()">ğŸ“„ TSV ë³µì‚¬</button>
      </div>
    </div>

  </div><!-- /tab-place -->

  <!-- ì¼ê´„ì²˜ë¦¬ íƒ­ -->
  <div id="tab-bulk" class="tab-panel">
    <div class="panel">
      <div style="text-align:center;padding:36px;color:#475569;">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸ”§</div>
        <div style="font-size:.9rem;font-weight:600;color:#64748b;">ì¤€ë¹„ ì¤‘</div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_script %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì „ì—­ ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let orderRows    = [];   // [{start,end,keywords:[],url,name,store,daily,elapsed,total,pid}]
let campaignData = [];   // [{meta, rows:[ [15ì—´], ...Ã—5 ]}]
let selStart     = null;
let selEnd       = null;
let isDragging   = false;
let rankBlocked  = false; // ìˆœìœ„ ë¯¸ë‹¬ë¡œ ì°¨ë‹¨ ì¤‘ ì—¬ë¶€

// ì»¬ëŸ¼ ì •ì˜ (0-based: A=0 ... O=14)
const COL_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O'];

// ë³‘í•© ì—´ ì¸ë±ìŠ¤ (0-based):
// A=0, C=2, D=3, E=4, F=5, G=6, H=7(í¬ì¸íŠ¸10 ìˆ˜ì‹), N=13, O=14
const MERGE_COLS_IDX = new Set([0,2,3,4,5,6,7,13,14]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.auto-tab').forEach((el,i)=>{
    el.classList.toggle('active',['reward','bulk'][i]===t);
  });
  document.querySelectorAll('.tab-panel').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  URL íŒŒì‹± ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function extractPid(url){
  if(!url) return '';
  const m1 = url.match(/\/products\/(\d+)/);
  const m2 = url.match(/[?&]itemId=(\d+)/);
  const m3 = url.match(/catalog\/(\d+)/);
  return (m1||m2||m3||['',''])[1];
}
function extractSlug(url){
  if(!url) return '';
  const ms = url.match(/smartstore\.naver\.com\/([^\/\?#]+)/);
  const mf = url.match(/storefarm\.naver\.com\/([^\/\?#]+)/);
  return ms ? ms[1] : (mf ? mf[1] : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íŒíŠ¸URL ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeHintUrl(keyword){
  if(!keyword) return '';
  const query = keyword.replace(/ /g,'+');
  const words = keyword.split(/\s+/).filter(Boolean);
  let acq;
  if(words.length===1){
    const w=words[0];
    if(w.length<=2) acq=w.slice(0,1);
    else if(w.length===3) acq=w.slice(0,2);
    else acq=w.slice(0,3);
  } else {
    acq=words[Math.floor(Math.random()*words.length)];
  }
  const acr=Math.floor(Math.random()*9)+1;
  return `https://m.search.naver.com/search.naver?sm=mtp_sug.top&where=m&query=${query}&ackey=mbauljxv&acq=${encodeURIComponent(acq)}&acr=${acr}&qdt=0`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°œì£¼ íŒŒì‹±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parsePaste(){
  const raw = document.getElementById('orderPaste').value.trim();
  if(!raw){ alert('ë¶™ì—¬ë„£ê¸° ì˜ì—­ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }

  const lines = raw.split(/\r?\n/).filter(l=>l.trim());
  const parsed = [];
  for(const line of lines){
    const cols = line.split('\t').map(c=>c.trim());
    if(cols.length < 4) continue;
    // í‚¤ì›Œë“œ: 3ë²ˆì§¸ ì—´, ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ ë¶„ë¦¬
    const kwRaw = cols[2]||'';
    const keywords = kwRaw.split(/[,\/]/).map(k=>k.trim()).filter(Boolean);
    const row = {
      start:   cols[0]||'',
      end:     cols[1]||'',
      keywords: keywords.length ? keywords : [''],
      url:     cols[3]||'',
      name:    cols[4]||'',
      store:   '',          // URLì—ì„œë§Œ ì¶”ì¶œ
      daily:   cols[5]||'',
      elapsed: cols[6]||'',
      total:   cols[7]||'',
    };
    row.pid = extractPid(row.url);
    parsed.push(row);
  }
  if(!parsed.length){ alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—´ ìˆœì„œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'); return; }

  orderRows = parsed;
  renderOrderTable();
  document.getElementById('orderPaste').value = '';

  // Mì—´ ìŠ¤í† ì–´ëª… ë¹„ë™ê¸° ì¡°íšŒ
  parsed.forEach((row, idx) => {
    const slug = extractSlug(row.url);
    if(slug){
      row.store = slug;
      fetchStoreName(slug, row.pid, idx);
    }
  });
}

function loadDemoData(){
  document.getElementById('orderPaste').value =
    '2025-02-24\t2025-02-28\tì¥ë‡Œì‚¼,ì‚°ì‚¼,ì‚°ì–‘ì‚¼\thttps://smartstore.naver.com/minkukss/products/5835104592\të„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼ ì‚°ì‚¼ 6ë…„ê·¼\t300\t5\t1500';
  parsePaste();
}

function addEmptyRow(){
  orderRows.push({start:'',end:'',keywords:[''],url:'',name:'',store:'',daily:'',elapsed:'',total:'',pid:''});
  renderOrderTable();
}

function clearOrders(){
  orderRows=[]; campaignData=[];
  rankBlocked=false;
  document.getElementById('orderTablePanel').style.display='none';
  document.getElementById('resultPanel').style.display='none';
  document.getElementById('orderPaste').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Mì—´ ìŠ¤í† ì–´ëª… ë¹„ë™ê¸° ì¡°íšŒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fetchStoreName(slug, pid, rowIdx){
  if(!slug) return;
  const params = new URLSearchParams({slug});
  if(pid) params.set('pid', pid);
  fetch(`/api/fetch-store-name?${params}`)
    .then(r=>r.json())
    .then(d=>{
      const name = (d.ok && d.name) ? d.name : slug;
      orderRows[rowIdx].store = name;
      const el = document.getElementById(`store-input-${rowIdx}`);
      if(el){
        el.value = name;
        el.style.color = (d.ok && d.name && d.name !== slug) ? '#a78bfa' : '#f59e0b';
      }
    })
    .catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìˆœìœ„ ì¼ê´„ í™•ì¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAllRanks(){
  const checkboxes = [...document.querySelectorAll('.row-chk')];
  const selected = orderRows.filter((_,i)=>checkboxes[i]&&checkboxes[i].checked);
  if(!selected.length){ alert('í™•ì¸í•  ë°œì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const wrap = document.getElementById('rankResultWrap');
  wrap.style.display='block';
  wrap.innerHTML = '<div class="info-bar" style="margin-bottom:6px;">â³ í‚¤ì›Œë“œ ìˆœìœ„ í™•ì¸ ì¤‘...</div>';

  const jobs = selected.map(r=>({ pid: r.pid, url: r.url, keywords: r.keywords }));

  fetch('/api/check-rank', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ jobs })
  })
  .then(r=>r.json())
  .then(data=>{
    if(!data.ok){ wrap.innerHTML=`<div class="info-bar err">ì˜¤ë¥˜: ${escHtml(data.error||'API ì˜¤ë¥˜')}</div>`; return; }

    let hasWarn = false;
    let html = '';
    data.results.forEach(job=>{
      html += `<div style="margin-bottom:6px;"><div style="font-size:.68rem;color:#475569;margin-bottom:3px;">ğŸ“¦ ${escHtml(job.url||'')}</div>`;
      job.keywords.forEach(kw=>{
        const r = kw.rank;
        let cls, txt;
        if(r===null||r===undefined){ cls='rank-pending'; txt='ì¡°íšŒ ì‹¤íŒ¨'; }
        else if(r<=0){ cls='rank-fail'; txt='ë¯¸ê²€ìƒ‰'; hasWarn=true; }
        else if(r<=15){ cls='rank-ok'; txt=`${r}ìœ„`; }
        else { cls='rank-warn'; txt=`${r}ìœ„`; hasWarn=true; }
        html+=`<div class="rank-item"><span class="rank-badge ${cls}">${txt}</span>
          <span class="rank-kw">${escHtml(kw.keyword)}</span>
          <span class="rank-note">${r>15?'âš ï¸ 15ìœ„ ì´ˆê³¼':r<=0?'âŒ ë…¸ì¶œ ì—†ìŒ':r<=15?'âœ… ì •ìƒ':''}</span></div>`;
      });
      html += '</div>';
    });

    if(hasWarn){
      html = `<div class="info-bar warn">âš ï¸ 15ìœ„ ì´ë‚´ ë¯¸í¬í•¨ í‚¤ì›Œë“œê°€ ìˆìŠµë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ê°•í–‰ ìƒì„±í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>` + html;
      rankBlocked = true;
    } else {
      html = `<div class="info-bar ok">âœ… ëª¨ë“  í‚¤ì›Œë“œê°€ 15ìœ„ ì´ë‚´ì…ë‹ˆë‹¤.</div>` + html;
      rankBlocked = false;
    }
    wrap.innerHTML = html;
  })
  .catch(e=>{
    wrap.innerHTML=`<div class="info-bar err">ìˆœìœ„ í™•ì¸ ì‹¤íŒ¨: ${escHtml(e.message)}</div>`;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°œì£¼ í…Œì´ë¸” ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOrderTable(){
  if(!orderRows.length){
    document.getElementById('orderTablePanel').style.display='none';
    return;
  }
  document.getElementById('orderTablePanel').style.display='block';
  const badge = document.getElementById('rowCountBadge');
  if(badge) badge.textContent = `ì´ ${orderRows.length}ê±´`;

  const tbody = document.getElementById('orderTbody');
  tbody.innerHTML = orderRows.map((r,i)=>`
    <tr id="orow-${i}">
      <td style="text-align:center;"><input type="checkbox" class="order-chk row-chk" checked></td>
      <td style="color:#475569;text-align:center;">${i+1}</td>
      <td><input value="${escAttr(r.start)}" onchange="orderRows[${i}].start=this.value" style="min-width:82px;" placeholder="YYYY-MM-DD"></td>
      <td><input value="${escAttr(r.end)}"   onchange="orderRows[${i}].end=this.value"   style="min-width:82px;" placeholder="YYYY-MM-DD"></td>
      <td><input value="${escAttr((r.keywords||[]).join(','))}"
        onchange="orderRows[${i}].keywords=this.value.split(',').map(k=>k.trim()).filter(Boolean)"
        style="color:#3b82f6;min-width:100px;" placeholder="í‚¤ì›Œë“œ1,í‚¤ì›Œë“œ2"></td>
      <td><input value="${escAttr(r.url)}"   onchange="orderRows[${i}].url=this.value;orderRows[${i}].pid=extractPid(this.value);" style="min-width:160px;font-size:.65rem;color:#64748b;"></td>
      <td><input value="${escAttr(r.name)}"  onchange="orderRows[${i}].name=this.value"  style="min-width:110px;"></td>
      <td>
        <div style="display:flex;align-items:center;gap:3px;">
          <input id="store-input-${i}" value="${escAttr(r.store||'')}"
            onchange="orderRows[${i}].store=this.value"
            style="color:${r.store&&r.store!==extractSlug(r.url)?'#a78bfa':'#f59e0b'};min-width:70px;"
            placeholder="ìë™ì¡°íšŒì¤‘...">
          <button onclick="fetchStoreName(extractSlug(orderRows[${i}].url),orderRows[${i}].pid,${i})"
            style="background:none;border:none;cursor:pointer;color:#03c75a;font-size:.7rem;"
            title="ì¬ì¡°íšŒ">ğŸ”„</button>
        </div>
      </td>
      <td><input type="number" id="daily-${i}"   value="${escAttr(r.daily)}"   onchange="orderRows[${i}].daily=this.value;autoCalcTotal(${i});"   style="min-width:44px;text-align:right;"></td>
      <td><input type="number" id="elapsed-${i}" value="${escAttr(r.elapsed)}" onchange="orderRows[${i}].elapsed=this.value;autoCalcTotal(${i});" style="min-width:40px;text-align:right;"></td>
      <td><input type="number" id="total-${i}"   value="${escAttr(r.total)}"   onchange="orderRows[${i}].total=this.value"                         style="min-width:52px;text-align:right;color:#64748b;"></td>
      <td><button class="btn-row-del" onclick="deleteOrderRow(${i})" title="ì‚­ì œ">âœ•</button></td>
    </tr>
  `).join('');
}

function escAttr(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function autoCalcTotal(i){
  const d=parseFloat(orderRows[i].daily)||0, e=parseFloat(orderRows[i].elapsed)||0;
  if(d&&e){ orderRows[i].total=Math.round(d*e); const el=document.getElementById('total-'+i); if(el)el.value=orderRows[i].total; }
}
function deleteOrderRow(i){ orderRows.splice(i,1); renderOrderTable(); }
function toggleAllChk(el){ document.querySelectorAll('.row-chk').forEach(c=>c.checked=el.checked); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë¸”ëŸ¬ ì²˜ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function blurWord(w){
  if(!w) return w;
  if(w.length<=1) return w;
  if(w.length===2) return '*'+w[1];
  return w[0]+'*'+w.slice(2);
}
function blurName(name){
  if(!name) return '';
  const words = name.split(/\s+/);
  return words.map((w,i)=>i===0?w:blurWord(w)).join(' ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìº í˜ì¸ ìƒì„± â€” v15 ì»¬ëŸ¼ êµ¬ì¡° (A~O, 15ì—´)
//  A(0)=êµ¬ë¶„, B(1)=WEB, C(2)=ì‹œì‘ì¼, D(3)=ì¢…ë£Œì¼,
//  E(4)=ì´ì˜ˆì‚°ìˆ˜ì‹, F(5)=ì´ì˜ˆì‚°ìˆ˜ì‹2, G(6)=ì¼ì˜ˆì‚°ìˆ˜ì‹, H(7)=í¬ì¸íŠ¸(ìˆ˜ì‹),
//  I(8)=ê²€ìƒ‰ì–´(PIDì•3), J(9)=ë¯¸ì…˜ë‚´ìš©, K(10)=ì •ë‹µ(PIDì•5),
//  L(11)=íŒíŠ¸URL, M(12)=ì—…ì²´ëª…, N(13)=ì¼ìœ ì…ëª©í‘œ, O(14)=ê¸€ììˆ˜ìˆ˜ì‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateAll(){
  const checkboxes = [...document.querySelectorAll('.row-chk')];
  const selected = orderRows.filter((_,i)=>checkboxes[i]&&checkboxes[i].checked);
  if(!selected.length){ alert('ìƒì„±í•  ë°œì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  if(rankBlocked){
    if(!confirm('âš ï¸ 15ìœ„ ì´ˆê³¼ í‚¤ì›Œë“œê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  }

  const tpl = document.getElementById('missionTpl').value;
  campaignData = [];

  for(const r of selected){
    const blurred = blurName(r.name);
    const pid  = r.pid || extractPid(r.url);
    const pid3 = pid.substring(0,3);
    const pid5 = pid.substring(0,5);

    // í‚¤ì›Œë“œ 5ê°œë¡œ ë§ì¶”ê¸° (ë¶€ì¡±í•˜ë©´ ìˆœí™˜ ë³µì œ)
    let kws = (r.keywords||[]).filter(Boolean);
    if(!kws.length) kws = [''];
    const kwList = [];
    for(let i=0;i<5;i++) kwList.push(kws[i % kws.length]);

    // ê° ìº í˜ì¸: 5í–‰ Ã— 15ì—´
    const rows = [];
    for(let i=0;i<5;i++){
      const kw = kwList[i];
      const mission = tpl
        .replace(/\{blurred_name\}/g, blurred||r.name)
        .replace(/\{store_name\}/g,   r.store||'íŒë§¤ì²˜')
        .replace(/\{keyword\}/g,      kw||'í‚¤ì›Œë“œ')
        .replace(/\{product_name\}/g, r.name);
      const hintUrl = makeHintUrl(kw);

      rows.push([
        i===0 ? 'ì¼ë°˜'  : '__merge__',  // [0] A â€” êµ¬ë¶„ (ë³‘í•©)
        'WEB',                           // [1] B
        i===0 ? r.start : '__merge__',  // [2] C â€” ì‹œì‘ì¼ (ë³‘í•©)
        i===0 ? r.end   : '__merge__',  // [3] D â€” ì¢…ë£Œì¼ (ë³‘í•©)
        i===0 ? ''      : '__merge__',  // [4] E â€” ì´ì˜ˆì‚°ìˆ˜ì‹ (ë³‘í•©, ìˆ˜ì‹ìœ ì§€)
        i===0 ? ''      : '__merge__',  // [5] F â€” ì´ì˜ˆì‚°ìˆ˜ì‹ (ë³‘í•©, ìˆ˜ì‹ìœ ì§€)
        i===0 ? ''      : '__merge__',  // [6] G â€” ì¼ì˜ˆì‚°ìˆ˜ì‹ (ë³‘í•©, ìˆ˜ì‹ìœ ì§€)
        i===0 ? ''      : '__merge__',  // [7] H â€” í¬ì¸íŠ¸(10) ìˆ˜ì‹ (ë³‘í•©, ìˆ˜ì‹ìœ ì§€)
        pid3,                           // [8] I â€” ê²€ìƒ‰ì–´ (PIDì•3)
        mission,                        // [9] J â€” ë¯¸ì…˜ë‚´ìš©
        pid5,                           // [10] K â€” ì •ë‹µ (PIDì•5)
        hintUrl,                        // [11] L â€” íŒíŠ¸URL
        r.store||'',                    // [12] M â€” ì—…ì²´ëª… (URLì¶”ì¶œ)
        i===0 ? String(r.daily||'') : '__merge__', // [13] N â€” ì¼ìœ ì…ëª©í‘œ (ë³‘í•©)
        i===0 ? ''      : '__merge__',  // [14] O â€” ê¸€ììˆ˜ìˆ˜ì‹ (ë³‘í•©, ìˆ˜ì‹ìœ ì§€)
      ]);
    }
    campaignData.push({ meta: r, rows });
  }

  renderSheet();
  document.getElementById('resultPanel').style.display='block';
  document.getElementById('resultPanel').scrollIntoView({behavior:'smooth',block:'start'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CELL_TYPES = [
  'c-type',    // [0] A
  'c-web',     // [1] B
  'c-date',    // [2] C
  'c-date',    // [3] D
  'c-formula', // [4] E
  'c-formula', // [5] F
  'c-formula', // [6] G
  'c-pts',     // [7] H
  'c-kw',      // [8] I
  'c-mission', // [9] J
  'c-pid',     // [10] K
  'c-url',     // [11] L
  'c-store',   // [12] M
  'c-qty',     // [13] N
  'c-formula', // [14] O
];

function renderSheet(){
  const tbody = document.getElementById('isheetBody');
  const tabs  = document.getElementById('campaignTabs');
  tabs.innerHTML = campaignData.map((c,i)=>
    `<div class="camp-tab ${i===0?'active':''}" onclick="scrollToCamp(${i})" id="ctab-${i}">
      ìº í˜ì¸${i+1}${c.meta.keywords&&c.meta.keywords[0]?' â€” '+c.meta.keywords[0]:''}
    </div>`
  ).join('');

  let globalRowNum = 3; // v15: ë°ì´í„°ëŠ” 3í–‰ë¶€í„° (í—¤ë” 2í–‰)
  let html = '';

  campaignData.forEach((camp, ci)=>{
    const campStartRow = globalRowNum;

    camp.rows.forEach((rowData, ri)=>{
      const isCampStart = ri===0;
      const isFirst = ci===0 && ri===0;
      const trClass = isCampStart ? (isFirst ? 'camp-first' : 'camp-start') : '';
      html += `<tr class="${trClass}" id="camp-${ci}-row-${ri}">`;
      html += `<td class="row-num" data-r="${globalRowNum}" data-c="-1">${globalRowNum}</td>`;

      rowData.forEach((val, colIdx)=>{
        const isMergeCol = MERGE_COLS_IDX.has(colIdx);
        const cType = CELL_TYPES[colIdx]||'';

        if(isMergeCol){
          if(ri===0){
            const display = escHtml(String(val==='__merge__'?'':val||''));
            html += `<td class="${cType} merged" rowspan="5"
              data-r="${campStartRow}" data-c="${colIdx}" data-camp="${ci}"
              data-merge-val="${escAttr(String(val==='__merge__'?'':val||''))}"
              data-merge-end="${campStartRow+4}">` +
              `<div class="cell-inner">${display}</div></td>`;
          }
        } else {
          const display = escHtml(String(val||''));
          html += `<td class="${cType}" data-r="${globalRowNum}" data-c="${colIdx}" data-camp="${ci}">` +
                  `<div class="cell-inner" contenteditable="true">${display}</div></td>`;
        }
      });

      html += '</tr>';
      globalRowNum++;
    });
  });

  tbody.innerHTML = html;
  initSheetEvents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì…€ ì„ íƒ Â· ë“œë˜ê·¸ Â· Ctrl+C
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSheetEvents(){
  const sheet = document.getElementById('isheet');
  sheet.addEventListener('mousedown', e=>{
    const td = e.target.closest('td[data-r][data-c]');
    if(!td || td.dataset.c==='-1') return;
    const r=+td.dataset.r, c=+td.dataset.c;
    if(!e.shiftKey){ selStart={r,c}; selEnd={r,c}; isDragging=true; }
    else { if(!selStart) selStart={r,c}; selEnd={r,c}; }
    updateSelection();
    e.preventDefault();
  });
  sheet.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    const td = e.target.closest('td[data-r][data-c]');
    if(!td || td.dataset.c==='-1') return;
    selEnd={r:+td.dataset.r, c:+td.dataset.c};
    updateSelection();
  });
  sheet.addEventListener('click', e=>{
    const inner = e.target.closest('.cell-inner[contenteditable]');
    if(inner){ inner.focus(); isDragging=false; }
  });
}

document.addEventListener('mouseup', ()=>{ isDragging=false; });
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='c'){
    const active = document.activeElement;
    if(active && active.contentEditable==='true') return;
    if(selStart){ e.preventDefault(); copySelected(); }
  }
});

function updateSelection(){
  document.querySelectorAll('#isheet td.selected').forEach(td=>td.classList.remove('selected'));
  if(!selStart||!selEnd) return;
  const r1=Math.min(selStart.r,selEnd.r), r2=Math.max(selStart.r,selEnd.r);
  const c1=Math.min(selStart.c,selEnd.c), c2=Math.max(selStart.c,selEnd.c);

  let count=0;
  document.querySelectorAll('#isheet td[data-r][data-c]').forEach(td=>{
    if(td.dataset.c==='-1') return;
    const r=+td.dataset.r, c=+td.dataset.c;
    const mergeEnd = td.dataset.mergeEnd ? +td.dataset.mergeEnd : r;
    const inRow = (r>=r1&&r<=r2) || (mergeEnd>=r1&&r<=r2);
    const inCol = c>=c1&&c<=c2;
    if(inRow&&inCol){ td.classList.add('selected'); count++; }
  });

  const info = `ì„ íƒ: í–‰${r1}~${r2}, ${COL_LETTERS[c1]||c1}~${COL_LETTERS[c2]||c2}ì—´ (${count}ì…€)`;
  document.getElementById('selInfo').textContent=info;
}

function copySelected(){
  if(!selStart){ alert('ë³µì‚¬í•  ì…€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
  const r1=Math.min(selStart.r,selEnd.r), r2=Math.max(selStart.r,selEnd.r);
  const c1=Math.min(selStart.c,selEnd.c), c2=Math.max(selStart.c,selEnd.c);

  const grid={};
  document.querySelectorAll('#isheet td[data-r][data-c]').forEach(td=>{
    if(td.dataset.c==='-1') return;
    const c=+td.dataset.c;
    if(c<c1||c>c2) return;
    const inner = td.querySelector('.cell-inner');
    let text = inner ? (inner.innerText||inner.textContent||'').trim() : '';

    if(td.dataset.mergeEnd){
      const mStart=+td.dataset.r, mEnd=+td.dataset.mergeEnd;
      const mergeVal = td.dataset.mergeVal || text;
      for(let rr=Math.max(r1,mStart); rr<=Math.min(r2,mEnd); rr++){
        if(!grid[rr]) grid[rr]={};
        grid[rr][c] = mergeVal;
      }
    } else {
      const r=+td.dataset.r;
      if(r<r1||r>r2) return;
      if(!grid[r]) grid[r]={};
      grid[r][c] = text;
    }
  });

  const tsv=[];
  for(let r=r1;r<=r2;r++){
    const cols=[];
    for(let c=c1;c<=c2;c++) cols.push((grid[r]||{})[c]||'');
    tsv.push(cols.join('\t'));
  }
  const text=tsv.join('\n');
  const btn = document.querySelector('.btn-dl-green');
  const copy=(b)=>{ if(b){ b.textContent='âœ… ë³µì‚¬ë¨!'; setTimeout(()=>b.textContent='ğŸ“‹ ì„ íƒ ë³µì‚¬',1800); }};
  if(navigator.clipboard&&window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=>copy(btn)).catch(()=>fallbackCopy(text,btn));
  } else { fallbackCopy(text,btn); }
}

function fallbackCopy(text, btn){
  const el=document.createElement('textarea');
  el.value=text; el.style.position='fixed'; el.style.opacity='0';
  document.body.appendChild(el); el.select();
  try{ document.execCommand('copy'); if(btn){btn.textContent='âœ… ë³µì‚¬ë¨!'; setTimeout(()=>btn.textContent='ğŸ“‹ ì„ íƒ ë³µì‚¬',1800); }}
  catch(e){ alert('ë³µì‚¬ ì‹¤íŒ¨: '+e.message); }
  document.body.removeChild(el);
}

function selectAll(){
  const tds=document.querySelectorAll('#isheet td[data-r][data-c]');
  if(!tds.length) return;
  let minR=9999,maxR=0,minC=9999,maxC=0;
  tds.forEach(td=>{
    if(td.dataset.c==='-1') return;
    const r=+td.dataset.r, c=+td.dataset.c;
    const mEnd = td.dataset.mergeEnd ? +td.dataset.mergeEnd : r;
    minR=Math.min(minR,r); maxR=Math.max(maxR,mEnd);
    minC=Math.min(minC,c); maxC=Math.max(maxC,c);
  });
  selStart={r:minR,c:minC}; selEnd={r:maxR,c:maxC};
  updateSelection();
}
function clearSelection(){
  selStart=null; selEnd=null; updateSelection();
  document.getElementById('selInfo').textContent='ì„ íƒ í•´ì œë¨';
}
function copyAllTSV(){ selectAll(); setTimeout(()=>copySelected(),50); }

function scrollToCamp(i){
  document.querySelectorAll('.camp-tab').forEach((t,idx)=>t.classList.toggle('active',idx===i));
  const el=document.getElementById(`camp-${i}-row-0`);
  if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XLSX ë‹¤ìš´ë¡œë“œ (ìƒˆ íŒŒì¼)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPayload(){
  return { campaigns: campaignData.map(c=>({meta:c.meta, rows:c.rows})) };
}

function downloadXlsx(){
  if(!campaignData.length){ alert('ë¨¼ì € ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.'); return; }
  const btn = document.getElementById('btnXlsx');
  btn.textContent='â³ ìƒì„± ì¤‘...'; btn.disabled=true;

  fetch('/api/automation/excel-export', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(buildPayload())
  })
  .then(r=>{ if(!r.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜ '+r.status); return r.blob(); })
  .then(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`campaign_${new Date().toISOString().slice(0,10)}.xlsx`; a.click();
    URL.revokeObjectURL(url);
    btn.textContent='âœ… ì™„ë£Œ'; setTimeout(()=>{ btn.textContent='ğŸ“¥ ìƒˆ .xlsx'; btn.disabled=false; },2000);
  })
  .catch(e=>{ alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: '+e.message); btn.textContent='ğŸ“¥ ìƒˆ .xlsx'; btn.disabled=false; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í…œí”Œë¦¿ì— ì±„ìš°ê¸° (ê¸°ë³¸ í…œí”Œë¦¿ ì‚¬ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillTemplate(){
  if(!campaignData.length){ alert('ë¨¼ì € ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.'); return; }
  const btn = document.getElementById('btnFill');
  btn.textContent='â³ ìƒì„± ì¤‘...'; btn.disabled=true;

  const formData = new FormData();
  formData.append('use_default', '1');
  formData.append('payload', JSON.stringify(buildPayload()));
  formData.append('start_row', '3');
  formData.append('start_col', 'A');

  fetch('/api/automation/excel-fill', {method:'POST', body:formData})
    .then(r=>{ if(!r.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜'); return r.blob(); })
    .then(blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`[SKP-ì¬í¥ê´‘ê³ ê¸°íš] ë¯¸ì…˜ê´‘ê³  ë¦¬ìŠ¤íŠ¸_${new Date().toISOString().slice(0,10)}.xlsx`;
      a.click();
      URL.revokeObjectURL(url);
      btn.textContent='âœ… ì™„ë£Œ'; setTimeout(()=>{ btn.textContent='ğŸ“ í…œí”Œë¦¿ì— ì±„ìš°ê¸°'; btn.disabled=false; },2000);
    })
    .catch(e=>{ alert('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+e.message); btn.textContent='ğŸ“ í…œí”Œë¦¿ì— ì±„ìš°ê¸°'; btn.disabled=false; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í”Œë ˆì´ìŠ¤ íƒ­ ë¡œì§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let placeOrderRows = [];
let placeCampaignData = [];
let placeRankBlocked = false;

// ì´ˆì„± ìƒì„± í•¨ìˆ˜
function getChosung(str) {
  const CHO = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
  return [...str].map(ch => {
    const code = ch.charCodeAt(0) - 0xAC00;
    if(code < 0 || code > 11171) return '';
    return CHO[Math.floor(code/588)];
  }).join('');
}

// ë°œì£¼ íŒŒì‹± (í”Œë ˆì´ìŠ¤)
function parsePlacePaste(){
  const raw = document.getElementById('placeOrderPaste').value.trim();
  if(!raw){ alert('ë¶™ì—¬ë„£ê¸° í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
  placeOrderRows = [];
  for(const line of lines){
    const cols = line.split('\t');
    // ì»¬ëŸ¼: ì‹œì‘ì¼, ì¢…ë£Œì¼, í‚¤ì›Œë“œ(ë³µìˆ˜ ì‰¼í‘œ/ìŠ¬ë˜ì‹œ), í”Œë ˆì´ìŠ¤URL, í”Œë ˆì´ìŠ¤ëª…, ì¼ìœ ì…
    const start   = cols[0]||'';
    const end     = cols[1]||'';
    const kwRaw   = cols[2]||'';
    const url     = cols[3]||'';
    const name    = cols[4]||'';
    const daily   = cols[5]||'';
    const keywords = kwRaw.split(/[,\/]/).map(k=>k.trim()).filter(Boolean);
    placeOrderRows.push({ start, end, keywords, url, name, daily,
      store:'', pid:'', rankResults:[] });
  }
  renderPlaceOrderTable();
  document.getElementById('placeOrderTablePanel').style.display = 'block';
  document.getElementById('placeOrderTablePanel').scrollIntoView({behavior:'smooth'});
  document.getElementById('placeOrderPaste').value = '';

  // í”Œë ˆì´ìŠ¤ëª… ìë™ ì¡°íšŒ
  placeOrderRows.forEach((r,i) => {
    if(r.url && !r.name){
      fetch('/api/fetch-place-name?url='+encodeURIComponent(r.url))
        .then(res=>res.json())
        .then(d=>{
          if(d.ok){
            placeOrderRows[i].name = d.name;
            placeOrderRows[i].pid  = d.pid||'';
          }
          renderPlaceOrderTable();
        }).catch(()=>{});
    } else if(r.url && !r.pid){
      // URLì—ì„œ pid ì¶”ì¶œ
      const m = r.url.match(/\/(\d{7,})/);
      if(m) placeOrderRows[i].pid = m[1];
    }
  });
}

function loadPlaceDemo(){
  document.getElementById('placeOrderPaste').value =
    "2025-02-24\t2025-03-24\tê°•ë‚¨ë§›ì§‘,ì‚¼ì„±ì—­ë§›ì§‘\thttps://m.place.naver.com/restaurant/1326727196/home\tíŠ¸ë¼ê°€ ì‚¼ì„±ì \t100";
  parsePlacePaste();
}

function clearPlaceOrders(){
  placeOrderRows = [];
  placeCampaignData = [];
  document.getElementById('placeOrderTablePanel').style.display='none';
  document.getElementById('placeResultPanel').style.display='none';
}

function placeToggleAll(cb){
  document.querySelectorAll('.place-row-chk').forEach(c=>{ c.checked=cb.checked; });
}

function renderPlaceOrderTable(){
  const tbody = document.getElementById('placeOrderTbody');
  const badge = document.getElementById('placeRowCountBadge');
  badge.textContent = `${placeOrderRows.length}ê±´`;

  tbody.innerHTML = placeOrderRows.map((r,i)=>`
    <tr>
      <td><input type="checkbox" class="place-row-chk" checked></td>
      <td>${i+1}</td>
      <td>${r.start}</td><td>${r.end}</td>
      <td>${r.keywords.join(', ')}</td>
      <td style="font-size:.62rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;">
        <a href="${r.url}" target="_blank" style="color:#3b82f6;">${r.url.slice(0,40)}...</a></td>
      <td>
        <input type="text" value="${r.name}" onchange="placeOrderRows[${i}].name=this.value"
          style="background:#0a0f1a;border:1px solid #1e3a5f;color:#e2e8f0;border-radius:4px;padding:3px 6px;font-size:.72rem;width:110px;">
        ${r.pid?'<span style="font-size:.6rem;color:#64748b;">ID:'+r.pid+'</span>':''}
      </td>
      <td><input type="number" value="${r.daily}" onchange="placeOrderRows[${i}].daily=this.value"
        style="background:#0a0f1a;border:1px solid #1e3a5f;color:#e2e8f0;border-radius:4px;padding:3px 6px;font-size:.72rem;width:60px;"></td>
      <td id="placeRank_${i}">
        ${r.rankResults.length?
          r.rankResults.map(rr=>`<span style="font-size:.65rem;color:${rr.rank&&rr.rank<=10?'#03c75a':'#ef4444'};">${rr.keyword}: ${rr.message||'-'}</span>`).join('<br>')
          :'<button class="btn btn-secondary btn-sm" onclick="checkPlaceRankRow('+i+')" style="font-size:.62rem;padding:2px 6px;">ìˆœìœ„ í™•ì¸</button>'}
      </td>
    </tr>
  `).join('');
}

// ê°œë³„ í–‰ ìˆœìœ„ í™•ì¸
function checkPlaceRankRow(idx){
  const r = placeOrderRows[idx];
  if(!r.url){ alert('í”Œë ˆì´ìŠ¤ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  const cell = document.getElementById('placeRank_'+idx);
  cell.innerHTML = '<span style="color:#94a3b8;font-size:.65rem;">í™•ì¸ ì¤‘...</span>';

  fetch('/api/check-place-rank', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ keywords: r.keywords, url: r.url })
  }).then(res=>res.json()).then(d=>{
    if(d.ok){
      placeOrderRows[idx].rankResults = d.results;
      if(d.rank_blocked) placeRankBlocked = true;
      renderPlaceOrderTable();
    }
  }).catch(e=>{ cell.innerHTML = '<span style="color:#ef4444;font-size:.65rem;">ì˜¤ë¥˜</span>'; });
}

// ëª…ì†Œëª… ì…ë ¥ ì‹œ ì´ˆì„±/ê¸€ììˆ˜ ë¯¸ë¦¬ë³´ê¸°
document.addEventListener('DOMContentLoaded', ()=>{
  const spotInput = document.getElementById('placeSpotAnswer');
  const spotPreview = document.getElementById('placeSpotPreview');
  if(spotInput){
    spotInput.addEventListener('input', ()=>{
      const v = spotInput.value.replace(/\s/g,'');
      spotInput.value = v;  // ê³µë°± ì‹¤ì‹œê°„ ì œê±°
      if(v){
        const cho = getChosung(v);
        spotPreview.innerHTML = `ì´ˆì„±íŒíŠ¸: <strong style="color:#f59e0b;">{${cho}}</strong>  /  ê¸€ììˆ˜: <strong style="color:#03c75a;">${v.length}ê¸€ì</strong>`;
      } else {
        spotPreview.textContent = '';
      }
    });
  }
});

// í”Œë ˆì´ìŠ¤ ìº í˜ì¸ ì‹œíŠ¸ ìƒì„±
function generatePlaceAll(){
  const checkboxes = [...document.querySelectorAll('.place-row-chk')];
  const selected = placeOrderRows.filter((_,i)=>checkboxes[i]&&checkboxes[i].checked);
  if(!selected.length){ alert('ìƒì„±í•  ë°œì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  if(placeRankBlocked){
    if(!confirm('âš ï¸ í”Œë ˆì´ìŠ¤ êµ¬ì¢Œ ì—†ìŒ ë˜ëŠ” 10ìœ„ ë°– í‚¤ì›Œë“œê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  }

  const tpl = document.getElementById('placeMissionTpl').value;
  const spotAnswer = document.getElementById('placeSpotAnswer').value.replace(/\s/g,'');

  if(!spotAnswer){ alert('ì •ë‹µ ëª…ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

  const chosung = getChosung(spotAnswer);
  const answerLen = spotAnswer.length;

  placeCampaignData = [];

  for(const r of selected){
    const blurred = r.name ? ('â– '+r.name.slice(1)) : 'â– ì—…ì²´ëª…';
    const pid = r.pid || (r.url.match(/\/(\d{7,})/)||[])[1] || '';

    let kws = (r.keywords||[]).filter(Boolean);
    if(!kws.length) kws=[''];
    const kwList = [];
    for(let i=0;i<5;i++) kwList.push(kws[i%kws.length]);

    const rows = [];
    for(let i=0;i<5;i++){
      const kw = kwList[i];
      const mission = tpl
        .replace(/\{blurred_name\}/g, blurred)
        .replace(/\{store_name\}/g,   r.name||'ì—…ì²´ëª…')
        .replace(/\{keyword\}/g,      kw||'í‚¤ì›Œë“œ')
        .replace(/\{chosung\}/g,      chosung)
        .replace(/\{answer_len\}/g,   answerLen);

      rows.push([
        i===0?'ì¼ë°˜':'__merge__',     // [0] A
        'APP',                         // [1] B â† í”Œë ˆì´ìŠ¤ëŠ” APP
        i===0?r.start:'__merge__',    // [2] C
        i===0?r.end:'__merge__',      // [3] D
        i===0?'':'__merge__',         // [4] E
        i===0?'':'__merge__',         // [5] F
        i===0?'':'__merge__',         // [6] G
        i===0?'':'__merge__',         // [7] H
        kw,                            // [8] I ê²€ìƒ‰ì–´
        mission,                       // [9] J ë¯¸ì…˜ë‚´ìš©
        spotAnswer,                    // [10] K ì •ë‹µ(ëª…ì†Œëª…)
        'ë„¤ì´ë²„ì•±ëœë”©',                // [11] L
        blurred,                       // [12] M ì—…ì²´ëª…(ë¸”ëŸ¬)
        i===0?String(r.daily||''):'__merge__', // [13] N
        i===0?'':'__merge__',         // [14] O
      ]);
    }
    placeCampaignData.push({ meta:r, rows });
  }

  renderPlaceSheet();
  document.getElementById('placeResultPanel').style.display='block';
  document.getElementById('placeResultPanel').scrollIntoView({behavior:'smooth',block:'start'});
}

// í”Œë ˆì´ìŠ¤ ì‹œíŠ¸ ë Œë”ë§
function renderPlaceSheet(){
  const tbody = document.getElementById('placeSheetBody');
  const tabsBar = document.getElementById('placeCampaignTabs');
  if(!tbody||!placeCampaignData.length) return;

  tabsBar.innerHTML = placeCampaignData.map((c,i)=>`
    <button class="camp-tab" onclick="scrollToPlaceCamp(${i})">
      ğŸ“ ìº í˜ì¸ ${i+1}: ${(c.meta.keywords||[]).slice(0,2).join(',')}
    </button>`).join('');

  let html = '';
  placeCampaignData.forEach((camp, ci)=>{
    camp.rows.forEach((rd, ri)=>{
      const globalIdx = ci*5+ri;
      const isMerge = [0,2,3,4,5,6,7,13,14];
      const isFirst = ri===0;
      html += `<tr data-camp="${ci}" data-row="${ri}" ${isFirst?`id="placeCamp${ci}"`:''}
        style="${isFirst?'border-top:2px solid #1e3a5f;':''}">`;
      html += `<td class="row-hd">${isFirst?`<input type="checkbox" class="place-cell-chk" checked data-camp="${ci}">`:''}</td>`;
      rd.forEach((val,colIdx)=>{
        if(isMerge.includes(colIdx)&&ri>0) return;
        const display = val==='__merge__'?'':val;
        const rowspan = isMerge.includes(colIdx)?5:1;
        const CELL_TYPES=['c-type','c-web','c-date','c-date','c-formula','c-formula','c-formula','c-formula','c-kw','c-mission','c-answer','c-hint','c-store','c-daily','c-formula'];
        html += `<td class="${CELL_TYPES[colIdx]||''}" rowspan="${rowspan}"
          contenteditable="true"
          onmousedown="handlePlaceCellDown(event,${ci},${ri},${colIdx})"
          style="${colIdx===9?'text-align:left;white-space:pre-wrap;font-size:.62rem;':''}">
          ${display.replace(/\n/g,'<br>')}
        </td>`;
      });
      html += '</tr>';
    });
  });
  tbody.innerHTML = html;
  document.getElementById('placeSelInfo').textContent = `${placeCampaignData.length}ê°œ ìº í˜ì¸ (${placeCampaignData.length*5}í–‰)`;
}

function scrollToPlaceCamp(idx){
  const el = document.getElementById('placeCamp'+idx);
  if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
}

function handlePlaceCellDown(e,ci,ri,col){ /* ì„ íƒ ì²˜ë¦¬ - ê°„ë‹¨ */ }
function selectAllPlace(){ document.querySelectorAll('.place-cell-chk').forEach(c=>c.checked=true); }
function clearSelectionPlace(){ document.querySelectorAll('.place-cell-chk').forEach(c=>c.checked=false); }

// í”Œë ˆì´ìŠ¤ TSV ë³µì‚¬
function copyPlaceTSV(){
  if(!placeCampaignData.length){ alert('ìƒì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  let tsv='';
  placeCampaignData.forEach(c=>{
    c.rows.forEach(rd=>{
      tsv += rd.map(v=>v==='__merge__'?'':String(v||'').replace(/\t/g,' ')).join('\t')+'\n';
    });
  });
  navigator.clipboard.writeText(tsv).then(()=>alert('TSV ë³µì‚¬ ì™„ë£Œ!')).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=tsv; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    alert('TSV ë³µì‚¬ ì™„ë£Œ!');
  });
}

function copySelectedPlace(){
  copyPlaceTSV();
}

// í”Œë ˆì´ìŠ¤ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ìƒìš© - ìƒˆ xlsx)
function downloadPlaceXlsx(){
  if(!placeCampaignData.length){ alert('ìƒì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const btn = document.getElementById('btnPlaceXlsx');
  btn.disabled=true; btn.textContent='â³ ìƒì„± ì¤‘...';

  const campaigns = placeCampaignData.map(c=>({
    rows: c.rows,
    meta: { start:c.meta.start, end:c.meta.end, keywords:c.meta.keywords, url:c.meta.url,
            name:c.meta.name, daily:c.meta.daily }
  }));

  fetch('/api/automation/excel-export', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ campaigns, type:'place' })
  }).then(r=>r.blob()).then(blob=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='place_campaign.xlsx';
    a.click();
    btn.disabled=false; btn.textContent='ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ìƒìš©)';
  }).catch(e=>{ alert('ì˜¤ë¥˜: '+e.message); btn.disabled=false; btn.textContent='ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë¹„ìƒìš©)'; });
}

// í”Œë ˆì´ìŠ¤ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ë©”ì¸ - í…œí”Œë¦¿ ì±„ìš°ê¸°)
function fillPlaceTemplate(){
  if(!placeCampaignData.length){ alert('ìƒì„±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const btn = document.getElementById('btnPlaceFill');
  btn.disabled=true; btn.textContent='â³ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...';

  const campaigns = placeCampaignData.map(c=>({
    rows: c.rows,
    meta: { start:c.meta.start, end:c.meta.end, keywords:c.meta.keywords,
            url:c.meta.url, name:c.meta.name, daily:c.meta.daily }
  }));

  const fd = new FormData();
  fd.append('use_default','1');
  fd.append('start_row','3');
  fd.append('start_col','A');
  fd.append('payload', JSON.stringify({ campaigns }));

  fetch('/api/automation/place-excel-fill', { method:'POST', body:fd })
    .then(r=>{
      if(!r.ok) return r.text().then(t=>{ throw new Error(t.slice(0,200)); });
      return r.blob();
    })
    .then(blob=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='[SKP-ì¬í¥ê´‘ê³ ê¸°íš] ë¯¸ì…˜ê´‘ê³  ë¦¬ìŠ¤íŠ¸ (í”Œë ˆì´ìŠ¤).xlsx';
      a.click();
      btn.disabled=false; btn.textContent='â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ';
    })
    .catch(e=>{ alert('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: '+e.message); btn.disabled=false; btn.textContent='â¬‡ï¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ'; });
}

</script>
{% endblock %}
