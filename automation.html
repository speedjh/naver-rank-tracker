{% extends "base.html" %}
{% block title %}ì—…ë¬´ ìë™í™” - ë„¤ì´ë²„ ìˆœìœ„ íŠ¸ë˜ì»¤{% endblock %}

{% block extra_style %}
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì „ì²´ ë ˆì´ì•„ì›ƒ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.auto-tabs{display:flex;gap:0;border-bottom:2px solid #334155;margin-bottom:24px;}
.auto-tab{padding:10px 22px;cursor:pointer;font-size:.875rem;font-weight:600;color:#64748b;
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:.15s;}
.auto-tab.active{color:#03c75a;border-bottom-color:#03c75a;}
.auto-tab:hover:not(.active){color:#e2e8f0;background:#1e2433;border-radius:6px 6px 0 0;}
.tab-panel{display:none;}.tab-panel.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íŒ¨ë„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:#161d2e;border:1px solid #1e293b;border-radius:12px;padding:20px;margin-bottom:16px;}
.panel-title{font-size:.75rem;font-weight:700;color:#475569;text-transform:uppercase;
  letter-spacing:.06em;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.panel-title::before{content:'';display:inline-block;width:3px;height:13px;background:#03c75a;border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì…ë ¥ í•„ë“œ â€” ë‹¤í¬ í…Œë§ˆ ì™„ì „ ê°•ì œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.f-grid{display:grid;gap:10px;margin-bottom:12px;}
.f-grid-3{grid-template-columns:repeat(3,1fr);}
.f-grid-2{grid-template-columns:1fr 1fr;}
.f-grid-4{grid-template-columns:repeat(4,1fr);}
.f-group label{font-size:.75rem;color:#64748b;margin-bottom:4px;display:block;font-weight:600;}
.f-group input,
.f-group select,
.f-group textarea{
  width:100%;
  background:#0d1220 !important;
  border:1px solid #253048 !important;
  color:#e2e8f0 !important;
  padding:8px 11px;
  border-radius:7px;
  font-size:.83rem;
  transition:.15s;
  -webkit-appearance:none;
  -moz-appearance:none;
  appearance:none;
  box-shadow:none !important;
}
.f-group input::placeholder,
.f-group textarea::placeholder{color:#475569 !important;}
.f-group input:focus,
.f-group select:focus,
.f-group textarea:focus{
  border-color:#03c75a !important;
  outline:none !important;
  box-shadow:0 0 0 2px #03c75a18 !important;
}
input[type=number]{
  background:#0d1220 !important;
  color:#e2e8f0 !important;
  border:1px solid #253048 !important;
}
input[type=number]::-webkit-inner-spin-button{opacity:.4;}
.f-hint{font-size:.7rem;color:#334155;margin-top:3px;}
.f-hint.ok{color:#03c75a;}
.f-hint.warn{color:#f59e0b;}
.f-hint.err{color:#ef4444;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°œì£¼ ë¶™ì—¬ë„£ê¸° ì˜ì—­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.order-paste-wrap{position:relative;}
.order-paste-area{
  width:100%;min-height:90px;max-height:180px;resize:vertical;overflow:auto;
  background:#0d1220 !important;border:1.5px dashed #253048 !important;
  color:#94a3b8 !important;padding:12px;border-radius:8px;
  font-size:.8rem;line-height:1.6;font-family:'Courier New',monospace;
}
.order-paste-area:focus{border-color:#03c75a !important;outline:none;}
.col-map{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
.col-badge{background:#0d1220;border:1px solid #253048;border-radius:5px;
  padding:3px 10px;font-size:.7rem;color:#64748b;}
.col-badge strong{color:#03c75a;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°œì£¼ ë°ì´í„° í…Œì´ë¸”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.order-table-wrap{overflow-x:auto;border-radius:8px;border:1px solid #1e293b;margin-top:12px;}
.order-table{border-collapse:collapse;width:100%;min-width:900px;font-size:.75rem;}
.order-table th{
  background:#111827;color:#64748b;padding:7px 10px;
  border-bottom:1px solid #1e293b;text-align:left;
  font-size:.68rem;font-weight:600;text-transform:uppercase;white-space:nowrap;
}
.order-table td{
  padding:4px 6px;border-bottom:1px solid #111827;
  color:#94a3b8;vertical-align:middle;
  background:#0d1220;
}
.order-table tr:last-child td{border-bottom:none;}
.order-table tr.selected td{background:#0d1a2d;}
.order-table tr:hover td{background:#111827;}
/* í…Œì´ë¸” ë‚´ ì¸í’‹ â€” ë‹¤í¬ ê°•ì œ */
.order-table td input{
  background:#0d1220 !important;
  border:1px solid transparent !important;
  color:#e2e8f0 !important;
  font-size:.75rem;
  width:100%;padding:3px 5px;
  min-width:60px;
  border-radius:4px;
}
.order-table td input:focus{
  background:#0d1624 !important;
  border:1px solid #03c75a44 !important;
  outline:none !important;
  color:#e2e8f0 !important;
}
.order-table td input::placeholder{color:#334155 !important;}
.order-chk{width:16px;height:16px;cursor:pointer;accent-color:#03c75a;}
.store-cell{display:flex;align-items:center;gap:5px;}
.store-spinner{width:10px;height:10px;border:1.5px solid #03c75a44;border-top-color:#03c75a;
  border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
.btn-row-del{background:none;border:none;color:#334155;cursor:pointer;font-size:.85rem;padding:2px 5px;}
.btn-row-del:hover{color:#ef4444;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ (ì—‘ì…€í˜•)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-wrap{overflow:auto;border:1px solid #1e293b;border-radius:10px;
  max-height:520px;position:relative;user-select:none;}
.isheet{border-collapse:collapse;font-size:.75rem;min-width:max-content;}
.isheet th{
  position:sticky;top:0;z-index:10;
  background:#0d1220;color:#475569;padding:6px 10px;
  border:1px solid #1e293b;font-size:.68rem;font-weight:600;
  white-space:nowrap;text-align:center;
}
.isheet th.row-hd{position:sticky;left:0;top:0;z-index:20;background:#0a0e1a;min-width:36px;}
.isheet td{
  border:1px solid #131c2e;padding:0;
  vertical-align:middle;position:relative;
  min-width:60px;background:#0d1220;
}
.isheet td.row-num{
  position:sticky;left:0;z-index:5;
  background:#0a0e1a;color:#334155;
  font-size:.65rem;font-weight:600;
  text-align:center;padding:4px 6px;
  border-right:2px solid #1e293b;
  cursor:default;user-select:none;
  min-width:36px;
}
.isheet td .cell-inner{
  display:block;padding:5px 8px;min-height:28px;
  outline:none;white-space:pre-wrap;word-break:break-all;
  line-height:1.4;color:#e2e8f0;
}
/* ì„ íƒ í•˜ì´ë¼ì´íŠ¸ */
.isheet td.selected{background:#1a2d4a !important;outline:1px solid #3b82f633;}
/* ì…€ íƒ€ì…ë³„ ìƒ‰ìƒ */
.isheet td.c-web .cell-inner{color:#f59e0b;font-weight:700;}
.isheet td.c-date .cell-inner{color:#03c75a;font-weight:600;}
.isheet td.c-formula .cell-inner{color:#1e3a5f;font-style:italic;}
.isheet td.c-kw .cell-inner{color:#3b82f6;font-weight:600;}
.isheet td.c-mission .cell-inner{font-size:.7rem;line-height:1.4;white-space:pre-wrap;word-break:break-all;min-width:200px;}
.isheet td.c-pid .cell-inner{color:#e2e8f0;}
.isheet td.c-url .cell-inner{color:#3b82f6;font-size:.68rem;min-width:150px;}
.isheet td.c-store .cell-inner{color:#a78bfa;}
.isheet td.c-qty .cell-inner{color:#03c75a;font-weight:600;}
.isheet td.c-merge-placeholder .cell-inner{color:#1e3a5f;font-style:italic;font-size:.65rem;}
/* ìº í˜ì¸ ì²« í–‰ êµ¬ë¶„ì„  */
.isheet tr.camp-start td{border-top:2px solid #03c75a55 !important;}
/* í¬ì»¤ìŠ¤ ì…€ */
.isheet td.focused{box-shadow:inset 0 0 0 2px #03c75a !important;z-index:2;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì‹œíŠ¸ íˆ´ë°”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.sheet-toolbar .btn-sm{padding:6px 14px;font-size:.78rem;}
.sel-info{font-size:.72rem;color:#475569;margin-left:auto;}
.campaign-tabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap;}
.camp-tab{padding:4px 12px;border-radius:5px;cursor:pointer;font-size:.72rem;font-weight:600;
  border:1px solid #1e293b;color:#64748b;transition:.1s;}
.camp-tab.active{background:#03c75a22;color:#03c75a;border-color:#03c75a44;}
.camp-tab:hover:not(.active){background:#1e2433;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dl-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
.btn-dl{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;
  border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;border:none;transition:.15s;}
.btn-dl-green{background:#03c75a;color:#fff;}
.btn-dl-green:hover{background:#02b350;}
.btn-dl-xlsx{background:#1d6f42;color:#fff;}
.btn-dl-xlsx:hover{background:#185834;}
.btn-dl-gray{background:#253048;color:#94a3b8;border:1px solid #334155;}
.btn-dl-gray:hover{background:#2d3a56;color:#e2e8f0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë¯¸ì…˜ í…ìŠ¤íŠ¸ í¸ì§‘ê¸°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mission-editor{
  background:#0d1220 !important;border:1px solid #253048 !important;border-radius:8px;
  padding:12px;font-size:.8rem;color:#94a3b8 !important;line-height:1.7;
  white-space:pre-wrap;min-height:120px;resize:vertical;
  width:100%;font-family:inherit;
}
.mission-editor:focus{border-color:#03c75a !important;outline:none !important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì•Œë¦¼/ì •ë³´ ë°•ìŠ¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.info-bar{background:#03c75a0d;border:1px solid #03c75a33;border-radius:8px;
  padding:11px 14px;font-size:.78rem;color:#94a3b8;margin-bottom:12px;line-height:1.6;}
.info-bar strong{color:#03c75a;}
.warn-bar{background:#f59e0b0d;border:1px solid #f59e0b33;border-radius:8px;
  padding:11px 14px;font-size:.78rem;color:#94a3b8;margin-top:10px;line-height:1.6;}
.warn-bar strong{color:#f59e0b;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   íŒŒì¼ ì—…ë¡œë“œ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.upload-zone{
  border:2px dashed #253048;border-radius:10px;padding:28px;text-align:center;
  cursor:pointer;transition:.2s;background:#0d1220;
}
.upload-zone:hover,.upload-zone.drag{border-color:#03c75a;background:#03c75a0a;}
.upload-zone input{display:none;}
.upload-icon{font-size:2rem;margin-bottom:8px;}
.upload-text{font-size:.85rem;color:#64748b;}
.upload-text strong{color:#03c75a;}
.upload-file-name{font-size:.8rem;color:#03c75a;margin-top:8px;font-weight:600;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°˜ì‘í˜•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  .f-grid-3,.f-grid-4{grid-template-columns:1fr 1fr;}
  .f-grid-2{grid-template-columns:1fr;}
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">ğŸš€ ì—…ë¬´ ìë™í™”</div>
  <div class="page-sub">ë¦¬ì›Œë“œ ë§ˆì¼€íŒ… ìº í˜ì¸ ì‹œíŠ¸ ìë™ ìƒì„± Â· ë‹¤ì¤‘ ë°œì£¼ ì¼ê´„ ì²˜ë¦¬</div>
</div>

<!-- ë©”ì¸ íƒ­ -->
<div class="auto-tabs">
  <div class="auto-tab active" onclick="switchTab('reward')">ğŸ¯ ë¦¬ì›Œë“œ ë§ˆì¼€íŒ…</div>
  <div class="auto-tab" onclick="switchTab('bulk')">ğŸ“‹ ì¼ê´„ ì²˜ë¦¬ (ì¤€ë¹„ì¤‘)</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë¦¬ì›Œë“œ ë§ˆì¼€íŒ… íƒ­ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-reward" class="tab-panel active">

  <!-- STEP 1: ë°œì£¼ ë°ì´í„° ì…ë ¥ -->
  <div class="panel">
    <div class="panel-title">â‘  ë°œì£¼ ë°ì´í„° ì…ë ¥ â€” ì—‘ì…€ì—ì„œ í–‰ ë³µì‚¬ ë¶™ì—¬ë„£ê¸°</div>

    <div class="info-bar">
      <strong>ğŸ“‹ ì‚¬ìš©ë²•:</strong> ë°œì£¼ ì—‘ì…€ì—ì„œ ë°ì´í„° í–‰ì„ ë³µì‚¬(Ctrl+C) â†’ ì•„ë˜ ì˜ì—­ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)<br>
      ì—¬ëŸ¬ í–‰ì„ í•œë²ˆì— ë¶™ì—¬ë„£ìœ¼ë©´ <strong>ë‹¤ì¤‘ ìº í˜ì¸ì´ í•œ ë²ˆì— ìƒì„±</strong>ë©ë‹ˆë‹¤.
    </div>

    <!-- ì—´ ìˆœì„œ ì•ˆë‚´ -->
    <div class="col-map">
      <div class="col-badge"><strong>1ì—´</strong> ì‹œì‘ì¼</div>
      <div class="col-badge"><strong>2ì—´</strong> ì¢…ë£Œì¼</div>
      <div class="col-badge"><strong>3ì—´</strong> í‚¤ì›Œë“œ</div>
      <div class="col-badge"><strong>4ì—´</strong> ìƒí’ˆURL</div>
      <div class="col-badge"><strong>5ì—´</strong> ìƒí’ˆëª…</div>
      <div class="col-badge"><strong>6ì—´</strong> ì—…ì²´ëª…(ì„ íƒ)</div>
      <div class="col-badge"><strong>7ì—´</strong> ì¼ì¼íŠ¸ë˜í”½</div>
      <div class="col-badge"><strong>8ì—´</strong> ê²½ê³¼ì¼ìˆ˜</div>
      <div class="col-badge"><strong>9ì—´</strong> ì´íŠ¸ë˜í”½(ì„ íƒ)</div>
    </div>

    <div class="order-paste-wrap" style="margin-top:12px;">
      <textarea class="order-paste-area" id="orderPaste"
        placeholder="ì—¬ê¸°ì— ì—‘ì…€ í–‰ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (ì—¬ëŸ¬ í–‰ ê°€ëŠ¥)
ì˜ˆì‹œ (íƒ­ìœ¼ë¡œ êµ¬ë¶„):
2025-02-24	2025-02-28	ì¥ë‡Œì‚¼	https://smartstore.naver.com/minkukss/products/5835100001	ë„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼	ë„ë‹´ì‚°ì‚¼	300	5	1500
2025-03-01	2025-03-07	ì‚°ì‚¼	https://smartstore.naver.com/store2/products/87654321	ìƒí’ˆëª… ì˜ˆì‹œ		200	7	1400"></textarea>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
      <button class="btn btn-primary btn-sm" onclick="parsePaste()">ğŸ“¥ ë¶™ì—¬ë„£ê¸° íŒŒì‹±</button>
      <button class="btn btn-secondary btn-sm" onclick="addEmptyRow()">â• ë¹ˆ í–‰ ì¶”ê°€</button>
      <button class="btn btn-secondary btn-sm" onclick="loadDemoData()">ğŸ§ª ë°ëª¨ ë°ì´í„°</button>
      <button class="btn btn-secondary btn-sm" onclick="clearOrders()">ğŸ—‘ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- STEP 2: ë°œì£¼ í™•ì¸ í…Œì´ë¸” -->
  <div class="panel" id="orderTablePanel" style="display:none;">
    <div class="panel-title">â‘¡ ë°œì£¼ í™•ì¸ Â· ìˆ˜ì • <span id="rowCountBadge" style="background:#03c75a22;color:#03c75a;border-radius:5px;padding:2px 8px;font-size:.7rem;margin-left:8px;"></span></div>
    <div class="order-table-wrap">
      <table class="order-table" id="orderTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="chkAll" class="order-chk" onchange="toggleAllChk(this)"></th>
            <th>#</th>
            <th>ì‹œì‘ì¼</th><th>ì¢…ë£Œì¼</th><th>í‚¤ì›Œë“œ</th>
            <th>ìƒí’ˆURL</th><th>ìƒí’ˆëª…</th>
            <th>ì—…ì²´ëª… (Mì—´)</th>
            <th style="min-width:55px;">ì¼ì¼</th>
            <th style="min-width:50px;">ê²½ê³¼</th>
            <th style="min-width:60px;">ì´íŠ¸ë˜í”½</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="orderTbody"></tbody>
      </table>
    </div>

    <!-- ë¯¸ì…˜ í…ìŠ¤íŠ¸ ê³µí†µ ì„¤ì • -->
    <div style="margin-top:16px;">
      <div class="panel-title" style="margin-bottom:8px;">Jì—´ ë¯¸ì…˜ í…ìŠ¤íŠ¸ (ì „ì²´ ê³µí†µ ì ìš©)</div>
      <div class="f-grid f-grid-2">
        <div>
          <textarea class="mission-editor" id="missionTpl" rows="12">ë¯¸ì…˜ ìˆ˜í–‰í•˜ë©°,
ë¦¬ì›Œë“œ ì¦‰ì‹œ ì ë¦½ ë°›ìœ¼ì„¸ìš”!

1. í•˜ë‹¨ [ê²€ìƒ‰ì–´ ë³µì‚¬í•˜ê¸°] ë²„íŠ¼ì„ í´ë¦­ í•˜ê³ , í‚¤ì›Œë“œë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”.
2. [íŒíŠ¸ ë³´ê¸°] ë²„íŠ¼ì„ í´ë¦­í•´ì„œ ë„¤ì´ë²„ì— ì ‘ì†í•´ì£¼ì„¸ìš”.
3. ë³µì‚¬ëœ í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰ ì°½ì— ë¶™ì—¬ ë„£ê³  ê²€ìƒ‰í•´ì£¼ì„¸ìš”.
4. ì•„ë˜ ìƒí’ˆì„ í´ë¦­ í•´ì£¼ì„¸ìš”.

{blurred_name}
( 'ê´‘ê³ ' í´ë¦­ ì ˆëŒ€ ê¸ˆì§€ )

â–¶íŒë§¤ì²˜ : {store_name}

5. ìƒì„¸í˜ì´ì§€ í•˜ë‹¨ êµ¬ë§¤ ì¶”ê°€ì •ë³´ì—ì„œ ìƒí’ˆë²ˆí˜¸ ì• 5ìë¦¬ë¥¼
ì•„ë˜ ì •ë‹µë€ì— ì…ë ¥ í›„ ì œì¶œí•´ì£¼ì„¸ìš”.</textarea>
          <div class="f-hint" style="margin-top:6px;">ğŸ’¡ <strong style="color:#03c75a;">{blurred_name}</strong> = ë¸”ëŸ¬ì²˜ë¦¬ ìƒí’ˆëª… &nbsp;|&nbsp; <strong style="color:#03c75a;">{store_name}</strong> = ì—…ì²´ëª… ìë™ ì‚½ì…</div>
        </div>
        <div>
          <div style="background:#0d1220;border:1px solid #1e293b;border-radius:8px;padding:14px;">
            <div style="font-size:.72rem;color:#475569;font-weight:700;margin-bottom:10px;">ğŸ“Œ ìƒì„± ê·œì¹™</div>
            <div style="font-size:.75rem;color:#94a3b8;line-height:1.8;">
              <div>â€¢ <strong style="color:#f59e0b;">Bì—´</strong> â†’ WEB ê³ ì •</div>
              <div>â€¢ <strong style="color:#03c75a;">Cì—´</strong> â†’ ì‹œì‘ì¼ (5í–‰ ë³‘í•©)</div>
              <div>â€¢ <strong style="color:#03c75a;">Dì—´</strong> â†’ ì¢…ë£Œì¼ (5í–‰ ë³‘í•©)</div>
              <div>â€¢ <strong style="color:#64748b;">E~Hì—´</strong> â†’ ìˆ˜ì‹ (ë¹ˆì¹¸)</div>
              <div>â€¢ <strong style="color:#3b82f6;">Iì—´</strong> â†’ ìƒí’ˆë²ˆí˜¸ ì• 3ìë¦¬</div>
              <div>â€¢ <strong style="color:#e2e8f0;">Jì—´</strong> â†’ ë¯¸ì…˜í…ìŠ¤íŠ¸ Ã— 5í–‰</div>
              <div>â€¢ <strong style="color:#e2e8f0;">Kì—´</strong> â†’ ìƒí’ˆë²ˆí˜¸ ì• 5ìë¦¬</div>
              <div>â€¢ <strong style="color:#3b82f6;">Lì—´</strong> â†’ ìƒí’ˆ URL</div>
              <div>â€¢ <strong style="color:#a78bfa;">Mì—´</strong> â†’ ìŠ¤í† ì–´ëª… ìë™ì¡°íšŒ</div>
              <div>â€¢ <strong style="color:#03c75a;">Nì—´</strong> â†’ ì¼ì¼íŠ¸ë˜í”½ (5í–‰ ë³‘í•©)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:18px;">
      <button class="btn btn-primary" style="padding:11px 40px;font-size:.9rem;" onclick="generateAll()">
        âœ¨ ì„ íƒ ë°œì£¼ ì‹œíŠ¸ ìƒì„±
      </button>
    </div>
  </div>

  <!-- STEP 3: ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ ê²°ê³¼ -->
  <div class="panel" id="resultPanel" style="display:none;">
    <div class="panel-title">â‘¢ ìƒì„±ëœ ì‹œíŠ¸ â€” ë“œë˜ê·¸ ì„ íƒ í›„ Ctrl+C ë³µì‚¬ ê°€ëŠ¥</div>

    <div class="warn-bar">
      <strong>ğŸ“‹ Google Sheets ë¶™ì—¬ë„£ê¸° ë°©ë²•:</strong>
      ì›í•˜ëŠ” ì…€ ë²”ìœ„ë¥¼ <strong>ë“œë˜ê·¸ ì„ íƒ</strong> â†’ <strong>Ctrl+C</strong> â†’
      Google Sheets <strong>B3 ì…€</strong>ì— <strong>Ctrl+V</strong><br>
      <strong>âš ï¸ ë³‘í•©(CÂ·DÂ·Nì—´)ì€ ë¶™ì—¬ë„£ê¸° í›„ ì§ì ‘ ë³‘í•©(Alt+Hâ†’Mâ†’M)ì„ ì ìš©í•˜ê±°ë‚˜ .xlsx íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì´ìš©í•˜ì„¸ìš”.</strong>
    </div>

    <!-- ìº í˜ì¸ íƒ­ -->
    <div class="campaign-tabs" id="campaignTabs"></div>

    <!-- ì‹œíŠ¸ íˆ´ë°” -->
    <div class="sheet-toolbar">
      <button class="btn btn-secondary btn-sm" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
      <button class="btn btn-secondary btn-sm" onclick="clearSelection()">ì„ íƒ í•´ì œ</button>
      <span class="sel-info" id="selInfo">ì…€ì„ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì„ íƒí•˜ì„¸ìš”</span>
      <button class="btn-dl btn-dl-green" style="padding:6px 16px;font-size:.78rem;" onclick="copySelected()">ğŸ“‹ ë³µì‚¬ (Ctrl+C)</button>
    </div>

    <!-- ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ í…Œì´ë¸” -->
    <div class="sheet-wrap" id="sheetWrap">
      <table class="isheet" id="isheet">
        <thead>
          <tr>
            <th class="row-hd">í–‰</th>
            <th>B<br><span style="font-size:.6rem;color:#334155;">WEB</span></th>
            <th>C<br><span style="font-size:.6rem;color:#334155;">ì‹œì‘ì¼</span></th>
            <th>D<br><span style="font-size:.6rem;color:#334155;">ì¢…ë£Œì¼</span></th>
            <th>E</th><th>F</th><th>G</th><th>H</th>
            <th>I<br><span style="font-size:.6rem;color:#334155;">í‚¤ì›Œë“œíŒíŠ¸</span></th>
            <th>J<br><span style="font-size:.6rem;color:#334155;">ë¯¸ì…˜</span></th>
            <th>K<br><span style="font-size:.6rem;color:#334155;">ì •ë‹µ</span></th>
            <th>L<br><span style="font-size:.6rem;color:#334155;">íŒíŠ¸URL</span></th>
            <th>M<br><span style="font-size:.6rem;color:#334155;">ì—…ì²´</span></th>
            <th>N<br><span style="font-size:.6rem;color:#334155;">ìˆ˜ëŸ‰</span></th>
          </tr>
        </thead>
        <tbody id="isheetBody"></tbody>
      </table>
    </div>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div class="dl-btns">
      <button class="btn-dl btn-dl-green" onclick="copySelected()">ğŸ“‹ ì„ íƒ ë³µì‚¬</button>
      <button class="btn-dl btn-dl-xlsx" onclick="downloadXlsx()">ğŸ“¥ .xlsx ë‹¤ìš´ë¡œë“œ (ë³‘í•© í¬í•¨)</button>
      <button class="btn-dl btn-dl-gray" onclick="copyAllTSV()">ğŸ“„ ì „ì²´ TSV ë³µì‚¬</button>
    </div>

    <!-- ê¸°ì¡´ ì†¡ì¶œ íŒŒì¼ì— ì±„ì›Œë„£ê¸° -->
    <div style="margin-top:20px;padding-top:18px;border-top:1px solid #1e293b;">
      <div class="panel-title">ğŸ“‚ ê¸°ì¡´ ì†¡ì¶œ íŒŒì¼ì— ì§ì ‘ ì±„ì›Œë„£ê¸° (ì„ íƒ)</div>
      <div class="info-bar" style="margin-bottom:12px;">
        ì‹¤ì œ ì‚¬ìš© ì¤‘ì¸ .xlsx íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ <strong>ìƒì„±ëœ ë°ì´í„°ë¥¼ í•´ë‹¹ íŒŒì¼ì˜ ì§€ì • í–‰ì— ìë™ ì±„ì›Œì„œ ë‹¤ìš´ë¡œë“œ</strong>í•©ë‹ˆë‹¤.
      </div>
      <div class="f-grid f-grid-2">
        <div>
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('xlsxInput').click()"
               ondragover="event.preventDefault();this.classList.add('drag')"
               ondragleave="this.classList.remove('drag')"
               ondrop="handleDrop(event)">
            <input type="file" id="xlsxInput" accept=".xlsx,.xls" onchange="handleFileSelect(this)">
            <div class="upload-icon">ğŸ“Š</div>
            <div class="upload-text">ì†¡ì¶œ íŒŒì¼ ë“œë˜ê·¸ ë˜ëŠ” <strong>í´ë¦­í•´ì„œ ì—…ë¡œë“œ</strong></div>
            <div class="upload-text" style="font-size:.72rem;margin-top:4px;">.xlsx / .xls ì§€ì›</div>
            <div class="upload-file-name" id="uploadFileName"></div>
          </div>
        </div>
        <div>
          <div class="f-group" style="margin-bottom:10px;">
            <label>ë°ì´í„° ì‹œì‘ í–‰ ë²ˆí˜¸ (ê¸°ë³¸: 3)</label>
            <input type="number" id="startRowNum" value="3" min="1">
            <div class="f-hint">ì²« ë²ˆì§¸ ìº í˜ì¸ì´ ë“¤ì–´ê°ˆ í–‰ ë²ˆí˜¸</div>
          </div>
          <div class="f-group">
            <label>ë°ì´í„° ì‹œì‘ ì—´ (ê¸°ë³¸: B)</label>
            <input type="text" id="startColLetter" value="B" maxlength="2">
            <div class="f-hint">Bì—´ë¶€í„° Nì—´ ìˆœì„œë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤</div>
          </div>
          <button class="btn btn-primary" style="margin-top:10px;width:100%;" onclick="exportToFile()">
            ğŸ“¥ íŒŒì¼ì— ì±„ì›Œì„œ ë‹¤ìš´ë¡œë“œ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì¼ê´„ì²˜ë¦¬ íƒ­ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-bulk" class="tab-panel">
  <div class="panel">
    <div style="text-align:center;padding:48px;color:#475569;">
      <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ”§</div>
      <div style="font-size:1rem;font-weight:600;color:#64748b;">ì¤€ë¹„ ì¤‘</div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_script %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì „ì—­ ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let orderRows    = [];   // [{start,end,kw,url,name,store,daily,elapsed,total,pid}]
let campaignData = [];   // [{meta, rows:[14ì—´ ë°°ì—´]}] Ã— N
let selStart     = null; // {r,c}
let selEnd       = null;
let isDragging   = false;
let uploadedFile = null;

const COL_NAMES  = ['í–‰','B','C','D','E','F','G','H','I','J','K','L','M','N'];
const MERGE_COLS = [2,3,13]; // C(2), D(3), N(13)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íƒ­ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.auto-tab').forEach((el,i)=>{
    el.classList.toggle('active',['reward','bulk'][i]===t);
  });
  document.querySelectorAll('.tab-panel').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+t).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  URL íŒŒì‹± ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function extractPid(url){
  if(!url) return '';
  const m1 = url.match(/\/products\/(\d+)/);
  const m2 = url.match(/[?&]itemId=(\d+)/);
  const m3 = url.match(/catalog\/(\d+)/);
  return (m1||m2||m3||['',''])[1];
}
function extractSlug(url){
  if(!url) return '';
  const ms = url.match(/smartstore\.naver\.com\/([^\/\?#]+)/);
  const mf = url.match(/storefarm\.naver\.com\/([^\/\?#]+)/);
  return ms ? ms[1] : (mf ? mf[1] : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°œì£¼ íŒŒì‹±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parsePaste(){
  const raw = document.getElementById('orderPaste').value.trim();
  if(!raw){ alert('ë¶™ì—¬ë„£ê¸° ì˜ì—­ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }

  const lines = raw.split(/\r?\n/).filter(l=>l.trim());
  const parsed = [];
  for(const line of lines){
    const cols = line.split('\t').map(c=>c.trim());
    if(cols.length < 4) continue;
    const row = {
      start:   cols[0]||'',
      end:     cols[1]||'',
      kw:      cols[2]||'',
      url:     cols[3]||'',
      name:    cols[4]||'',
      store:   cols[5]||'',   // 6ë²ˆì§¸ ì—´ì— ì—…ì²´ëª…ì´ ìˆìœ¼ë©´ ì‚¬ìš©
      daily:   cols[6]||'',
      elapsed: cols[7]||'',
      total:   cols[8]||'',
    };
    row.pid = extractPid(row.url);
    parsed.push(row);
  }
  if(!parsed.length){ alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—´ ìˆœì„œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'); return; }

  orderRows = parsed;
  renderOrderTable();
  document.getElementById('orderPaste').value = '';

  // ìŠ¤í† ì–´ëª… ë¹„ë™ê¸° ì¡°íšŒ (ì—…ì²´ëª…ì´ ì—†ê±°ë‚˜ slugì™€ ê°™ì€ ê²½ìš°)
  parsed.forEach((row, idx) => {
    const slug = extractSlug(row.url);
    if(slug && !row.store){
      row.store = slug; // ì„ì‹œë¡œ slug í‘œì‹œ
      fetchStoreName(slug, idx);
    }
  });
}

function loadDemoData(){
  document.getElementById('orderPaste').value =
    '2025-02-24\t2025-02-28\tì¥ë‡Œì‚¼\thttps://smartstore.naver.com/minkukss/products/5835100001\të„ë‹´ì‚°ì‚¼ ì¥ë‡Œì‚¼ ì‚°ì‚¼ ì‚°ì–‘ì‚¼ 6ë…„ê·¼\t\t300\t5\t1500\n' +
    '2025-03-01\t2025-03-07\tí™ì‚¼ì •\thttps://smartstore.naver.com/hsgstore/products/9876543210\tì •ê´€ì¥ í™ì‚¼ì • ì—ë¸Œë¦¬íƒ€ì„ 30í¬\tì •ê´€ì¥\t500\t7\t3500';
  parsePaste();
}

function addEmptyRow(){
  orderRows.push({start:'',end:'',kw:'',url:'',name:'',store:'',daily:'',elapsed:'',total:'',pid:''});
  renderOrderTable();
}

function clearOrders(){
  orderRows = [];
  campaignData = [];
  document.getElementById('orderTablePanel').style.display='none';
  document.getElementById('resultPanel').style.display='none';
  document.getElementById('orderPaste').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìŠ¤í† ì–´ëª… ë¹„ë™ê¸° ì¡°íšŒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fetchStoreName(slug, rowIdx){
  if(!slug) return;
  const cellId = `store-input-${rowIdx}`;

  fetch(`/api/fetch-store-name?slug=${encodeURIComponent(slug)}`)
    .then(r=>r.json())
    .then(d=>{
      const name = (d.ok && d.name && d.name !== slug) ? d.name : slug;
      orderRows[rowIdx].store = name;
      const el = document.getElementById(cellId);
      if(el){
        el.value = name;
        el.style.color = (name !== slug) ? '#a78bfa' : '#f59e0b';
      }
    })
    .catch(()=>{
      // ì‹¤íŒ¨ì‹œ slug ìœ ì§€
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°œì£¼ í…Œì´ë¸” ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOrderTable(){
  if(!orderRows.length){
    document.getElementById('orderTablePanel').style.display='none';
    return;
  }
  document.getElementById('orderTablePanel').style.display='block';
  const badge = document.getElementById('rowCountBadge');
  if(badge) badge.textContent = `ì´ ${orderRows.length}ê±´`;

  const tbody = document.getElementById('orderTbody');
  tbody.innerHTML = orderRows.map((r,i)=>`
    <tr id="orow-${i}">
      <td style="text-align:center;"><input type="checkbox" class="order-chk row-chk" checked></td>
      <td style="color:#475569;text-align:center;">${i+1}</td>
      <td><input value="${escAttr(r.start)}" onchange="orderRows[${i}].start=this.value" style="min-width:90px;" placeholder="YYYY-MM-DD"></td>
      <td><input value="${escAttr(r.end)}"   onchange="orderRows[${i}].end=this.value"   style="min-width:90px;" placeholder="YYYY-MM-DD"></td>
      <td><input value="${escAttr(r.kw)}"    onchange="orderRows[${i}].kw=this.value"    style="color:#3b82f6;min-width:80px;"></td>
      <td><input value="${escAttr(r.url)}"   onchange="orderRows[${i}].url=this.value;orderRows[${i}].pid=extractPid(this.value);" style="min-width:180px;font-size:.7rem;color:#64748b;"></td>
      <td><input value="${escAttr(r.name)}"  onchange="orderRows[${i}].name=this.value"  style="min-width:130px;"></td>
      <td>
        <div style="display:flex;align-items:center;gap:4px;">
          <input id="store-input-${i}" value="${escAttr(r.store||'')}"
            onchange="orderRows[${i}].store=this.value"
            style="color:${r.store&&r.store!==extractSlug(r.url)?'#a78bfa':'#f59e0b'};min-width:80px;"
            placeholder="ìë™ì¡°íšŒì¤‘...">
          <button onclick="fetchStoreName(extractSlug(orderRows[${i}].url),${i})"
            style="background:none;border:none;cursor:pointer;color:#03c75a;font-size:.75rem;white-space:nowrap;"
            title="ìŠ¤í† ì–´ëª… ë‹¤ì‹œ ì¡°íšŒ">ğŸ”„</button>
        </div>
      </td>
      <td><input type="number" id="daily-${i}" value="${escAttr(r.daily)}"   onchange="orderRows[${i}].daily=this.value;autoCalcTotal(${i});"   style="min-width:50px;text-align:right;"></td>
      <td><input type="number" id="elapsed-${i}" value="${escAttr(r.elapsed)}" onchange="orderRows[${i}].elapsed=this.value;autoCalcTotal(${i});" style="min-width:50px;text-align:right;"></td>
      <td><input type="number" id="total-${i}" value="${escAttr(r.total)}"   onchange="orderRows[${i}].total=this.value"                         style="min-width:60px;text-align:right;color:#64748b;"></td>
      <td><button class="btn-row-del" onclick="deleteOrderRow(${i})" title="ì‚­ì œ">âœ•</button></td>
    </tr>
  `).join('');
}

function escAttr(s){
  return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
}

function autoCalcTotal(i){
  const d = parseFloat(orderRows[i].daily)||0;
  const e = parseFloat(orderRows[i].elapsed)||0;
  if(d&&e){
    orderRows[i].total = Math.round(d*e);
    const el = document.getElementById('total-'+i);
    if(el) el.value = orderRows[i].total;
  }
}
function deleteOrderRow(i){ orderRows.splice(i,1); renderOrderTable(); }
function toggleAllChk(el){ document.querySelectorAll('.row-chk').forEach(c=>c.checked=el.checked); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë¸”ëŸ¬ ì²˜ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function blurWord(w){
  if(!w) return w;
  if(w.length<=1) return w;
  if(w.length===2) return '*'+w[1];
  return w[0]+'*'+w.slice(2);
}
function blurName(name){
  if(!name) return '';
  const words = name.split(/\s+/);
  return words.map((w,i)=>i===0?w:blurWord(w)).join(' ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìº í˜ì¸ ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateAll(){
  const checkboxes = [...document.querySelectorAll('.row-chk')];
  const selected = orderRows.filter((_,i)=>checkboxes[i]&&checkboxes[i].checked);
  if(!selected.length){ alert('ìƒì„±í•  ë°œì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const tpl = document.getElementById('missionTpl').value;
  campaignData = [];

  for(const r of selected){
    const blurred = blurName(r.name);
    const mission = tpl
      .replace(/\{blurred_name\}/g, blurred||r.name)
      .replace(/\{store_name\}/g,   r.store||'íŒë§¤ì²˜')
      .replace(/\{keyword\}/g,      r.kw||'í‚¤ì›Œë“œ')
      .replace(/\{product_name\}/g, r.name);

    const pid  = r.pid || extractPid(r.url);
    const pid3 = pid.substring(0,3);
    const pid5 = pid.substring(0,5);

    const rows = [];
    for(let i=0;i<5;i++){
      rows.push([
        '',                             // [0] í–‰ë²ˆí˜¸ (í‘œì‹œìš©)
        'WEB',                          // [1] B
        i===0 ? r.start : '__merge__', // [2] C â€” ì‹œì‘ì¼ (ë³‘í•©)
        i===0 ? r.end   : '__merge__', // [3] D â€” ì¢…ë£Œì¼ (ë³‘í•©)
        '', '', '', '',                 // [4~7] E~H ìˆ˜ì‹
        pid3,                           // [8] I â€” í‚¤ì›Œë“œíŒíŠ¸
        mission,                        // [9] J â€” ë¯¸ì…˜
        pid5,                           // [10] K â€” ì •ë‹µ
        r.url,                          // [11] L â€” URL
        r.store||'',                    // [12] M â€” ì—…ì²´ëª…
        i===0 ? String(r.daily||'') : '__merge__', // [13] N â€” ìˆ˜ëŸ‰ (ë³‘í•©)
      ]);
    }
    campaignData.push({ meta: r, rows });
  }

  renderSheet();
  document.getElementById('resultPanel').style.display='block';
  document.getElementById('resultPanel').scrollIntoView({behavior:'smooth',block:'start'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¸í„°ë™í‹°ë¸Œ ì‹œíŠ¸ ë Œë”ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSheet(){
  const tbody = document.getElementById('isheetBody');
  const tabs  = document.getElementById('campaignTabs');
  tabs.innerHTML = campaignData.map((c,i)=>
    `<div class="camp-tab ${i===0?'active':''}" onclick="scrollToCamp(${i})" id="ctab-${i}">
      ìº í˜ì¸ ${i+1}${c.meta.kw?' â€” '+c.meta.kw:''}
    </div>`
  ).join('');

  const cellTypes = ['','c-web','c-date','c-date',
    'c-formula','c-formula','c-formula','c-formula',
    'c-kw','c-mission','c-pid','c-url','c-store','c-qty'];

  let rowNum = 3;
  let html = '';

  campaignData.forEach((camp, ci)=>{
    camp.rows.forEach((rowData, ri)=>{
      const isCampStart = ri===0;
      html += `<tr class="${isCampStart?'camp-start':''}" id="camp-${ci}-row-${ri}">`;
      // í–‰ë²ˆí˜¸ ì…€
      html += `<td class="row-num" data-camp="${ci}" data-camprow="${ri}">${rowNum++}</td>`;

      rowData.forEach((val, colIdx)=>{
        if(colIdx===0) return; // í–‰ë²ˆí˜¸ skip
        const cType = cellTypes[colIdx]||'';
        const isMergePlaceholder = MERGE_COLS.includes(colIdx) && val==='__merge__';

        if(isMergePlaceholder){
          html += `<td class="c-merge-placeholder" data-r="${ci*5+ri+3}" data-c="${colIdx}" data-camp="${ci}">` +
                  `<div class="cell-inner" style="font-size:.62rem;color:#1e3a5f;">â†‘ ë³‘í•©</div></td>`;
        } else {
          const display = String(val==='__merge__' ? '' : (val||''));
          // E~Hì—´ì€ í¸ì§‘ ë¶ˆê°€
          const editable = (colIdx>=4&&colIdx<=7) ? '' : ' contenteditable="true"';
          html += `<td class="${cType}" data-r="${ci*5+ri+3}" data-c="${colIdx}" data-camp="${ci}">` +
                  `<div class="cell-inner"${editable}>${escHtml(display)}</div></td>`;
        }
      });
      html += '</tr>';
    });
  });
  tbody.innerHTML = html;
  initSheetEvents();
}

function escHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì…€ ì„ íƒ Â· ë“œë˜ê·¸ Â· Ctrl+C
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSheetEvents(){
  const sheet = document.getElementById('isheet');

  // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ ì„ íƒ
  sheet.addEventListener('mousedown', e=>{
    const td = e.target.closest('td[data-r]');
    if(!td) return;
    const r=+td.dataset.r, c=+td.dataset.c;
    if(!e.shiftKey){
      selStart={r,c}; selEnd={r,c}; isDragging=true;
    } else {
      if(!selStart) selStart={r,c};
      selEnd={r,c};
    }
    updateSelection();
    e.preventDefault(); // í…ìŠ¤íŠ¸ ê¸°ë³¸ ì„ íƒ ë°©ì§€
  });

  sheet.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    const td = e.target.closest('td[data-r]');
    if(!td) return;
    selEnd={r:+td.dataset.r, c:+td.dataset.c};
    updateSelection();
  });

  // contenteditable ì…€ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ í—ˆìš©
  sheet.addEventListener('click', e=>{
    const inner = e.target.closest('.cell-inner[contenteditable]');
    if(inner){
      inner.focus();
      isDragging=false;
    }
  });
}

document.addEventListener('mouseup', ()=>{ isDragging=false; });
document.addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='c'){
    // contenteditable ë‚´ë¶€ í¬ì»¤ìŠ¤ë©´ ê¸°ë³¸ ë™ì‘ í—ˆìš©
    const active = document.activeElement;
    if(active && active.contentEditable==='true') return;
    if(selStart){ e.preventDefault(); copySelected(); }
  }
});

function updateSelection(){
  document.querySelectorAll('#isheet td.selected').forEach(td=>td.classList.remove('selected'));
  if(!selStart||!selEnd) return;
  const r1=Math.min(selStart.r,selEnd.r), r2=Math.max(selStart.r,selEnd.r);
  const c1=Math.min(selStart.c,selEnd.c), c2=Math.max(selStart.c,selEnd.c);
  let count=0;
  document.querySelectorAll('#isheet td[data-r]').forEach(td=>{
    const r=+td.dataset.r, c=+td.dataset.c;
    if(r>=r1&&r<=r2&&c>=c1&&c<=c2){ td.classList.add('selected'); count++; }
  });
  const info = `ì„ íƒ: í–‰${r1}~${r2}, ${COL_NAMES[c1]}ì—´~${COL_NAMES[c2]}ì—´ (${count}ì…€)`;
  document.getElementById('selInfo').textContent=info;
}

function copySelected(){
  if(!selStart){ alert('ë³µì‚¬í•  ì…€ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
  const r1=Math.min(selStart.r,selEnd.r), r2=Math.max(selStart.r,selEnd.r);
  const c1=Math.min(selStart.c,selEnd.c), c2=Math.max(selStart.c,selEnd.c);

  // 2D ê·¸ë¦¬ë“œ ìˆ˜ì§‘
  const grid={};
  document.querySelectorAll('#isheet td[data-r].selected').forEach(td=>{
    const r=+td.dataset.r, c=+td.dataset.c;
    const inner = td.querySelector('.cell-inner');
    let text = inner ? (inner.innerText||inner.textContent||'').trim() : '';
    if(text==='â†‘ ë³‘í•©') text='';
    if(!grid[r]) grid[r]={};
    grid[r][c] = text;
  });

  const tsv=[];
  for(let r=r1;r<=r2;r++){
    const cols=[];
    for(let c=c1;c<=c2;c++) cols.push((grid[r]||{})[c]||'');
    tsv.push(cols.join('\t'));
  }
  const text=tsv.join('\n');

  const btn = document.querySelector('.btn-dl-green');
  const copy = (b)=>{ if(b){ b.textContent='âœ… ë³µì‚¬ë¨!'; setTimeout(()=>b.textContent='ğŸ“‹ ì„ íƒ ë³µì‚¬',1800); }};

  if(navigator.clipboard&&window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=>copy(btn)).catch(()=>fallbackCopy(text,btn));
  } else {
    fallbackCopy(text,btn);
  }
}

function fallbackCopy(text, btn){
  const el=document.createElement('textarea');
  el.value=text; el.style.position='fixed'; el.style.opacity='0';
  document.body.appendChild(el); el.select();
  try{ document.execCommand('copy'); if(btn){ btn.textContent='âœ… ë³µì‚¬ë¨!'; setTimeout(()=>btn.textContent='ğŸ“‹ ì„ íƒ ë³µì‚¬',1800); }}
  catch(e){ alert('ë³µì‚¬ ì‹¤íŒ¨: '+e.message); }
  document.body.removeChild(el);
}

function selectAll(){
  const tds=document.querySelectorAll('#isheet td[data-r]');
  const rs=[],cs=[];
  tds.forEach(td=>{ rs.push(+td.dataset.r); cs.push(+td.dataset.c); });
  if(!rs.length) return;
  selStart={r:Math.min(...rs),c:Math.min(...cs)};
  selEnd  ={r:Math.max(...rs),c:Math.max(...cs)};
  updateSelection();
}
function clearSelection(){
  selStart=null; selEnd=null; updateSelection();
  document.getElementById('selInfo').textContent='ì„ íƒ í•´ì œë¨';
}
function copyAllTSV(){ selectAll(); setTimeout(()=>copySelected(),50); }

function scrollToCamp(i){
  document.querySelectorAll('.camp-tab').forEach((t,idx)=>t.classList.toggle('active',idx===i));
  const el=document.getElementById(`camp-${i}-row-0`);
  if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XLSX ë‹¤ìš´ë¡œë“œ (ì„œë²„ API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPayload(){
  return { campaigns: campaignData.map(c=>({meta:c.meta, rows:c.rows})) };
}

function downloadXlsx(){
  if(!campaignData.length){ alert('ë¨¼ì € ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.'); return; }
  const btn = document.querySelector('.btn-dl-xlsx');
  const orig = btn.textContent;
  btn.textContent='â³ ìƒì„± ì¤‘...';
  btn.disabled=true;

  fetch('/api/automation/excel-export', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(buildPayload())
  })
  .then(r=>{ if(!r.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜ '+r.status); return r.blob(); })
  .then(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`campaign_${new Date().toISOString().slice(0,10)}.xlsx`;
    a.click();
    URL.revokeObjectURL(url);
    btn.textContent='âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ';
    setTimeout(()=>{ btn.textContent=orig; btn.disabled=false; },2000);
  })
  .catch(e=>{ alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: '+e.message); btn.textContent=orig; btn.disabled=false; });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê¸°ì¡´ íŒŒì¼ì— ì±„ì›Œì„œ ë‚´ë³´ë‚´ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFileSelect(input){
  if(input.files[0]){
    uploadedFile=input.files[0];
    document.getElementById('uploadFileName').textContent='ğŸ“„ '+uploadedFile.name;
  }
}
function handleDrop(e){
  e.preventDefault();
  document.getElementById('uploadZone').classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f){ uploadedFile=f; document.getElementById('uploadFileName').textContent='ğŸ“„ '+f.name; }
}
function exportToFile(){
  if(!uploadedFile){ alert('ì†¡ì¶œ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.'); return; }
  if(!campaignData.length){ alert('ë¨¼ì € ì‹œíŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.'); return; }
  const formData=new FormData();
  formData.append('file', uploadedFile);
  formData.append('payload', JSON.stringify(buildPayload()));
  formData.append('start_row', document.getElementById('startRowNum').value||'3');
  formData.append('start_col', document.getElementById('startColLetter').value||'B');
  fetch('/api/automation/excel-fill', {method:'POST', body:formData})
    .then(r=>{ if(!r.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜'); return r.blob(); })
    .then(blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='filled_'+uploadedFile.name;
      a.click();
      URL.revokeObjectURL(url);
    })
    .catch(e=>alert('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: '+e.message));
}
</script>
{% endblock %}
